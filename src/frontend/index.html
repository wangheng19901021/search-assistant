<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="å¯»ç‰©åŠ©æ‰‹">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+CjxjaXJjbGUgY3g9IjExIiBjeT0iMTEiIHI9IjgiLz4KPHN0cm9rZS1kYXNoYXJyYXkgPSJub25lIi8+CjxwYXRoIGQ9Im0yMSAyMS00LjM1LTQuMzUiLz4KPC9zdmc+Cjwvc3ZnPgo=">
    <title>å¯»ç‰©åŠ©æ‰‹</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif; background: #f5f5f5; }
        .container { max-width: 400px; margin: 0 auto; background: white; min-height: 100vh; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; }
        .tab-bar { display: flex; background: white; border-bottom: 1px solid #eee; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; color: #666; }
        .tab.active { color: #667eea; border-bottom: 2px solid #667eea; }
        .content { padding: 15px; }
        .search-container { margin-bottom: 15px; }
        .search-input-wrapper { position: relative; display: flex; align-items: center; background: white; border-radius: 25px; border: 1px solid #ddd; padding: 5px; }
        .search-box { flex: 1; border: none; outline: none; padding: 10px 15px; border-radius: 20px; font-size: 16px; }
        .voice-search-btn, .camera-search-btn { background: none; border: none; padding: 8px; border-radius: 50%; cursor: pointer; font-size: 18px; transition: background 0.2s; }
        .voice-search-btn:hover, .camera-search-btn:hover { background: rgba(102, 126, 234, 0.1); }
        .voice-search-btn.recording { background: #ff4444; color: white; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .search-suggestions, .search-history { background: white; border: 1px solid #ddd; border-radius: 8px; max-height: 200px; overflow-y: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: absolute; top: 100%; left: 0; right: 0; z-index: 100; }
        .suggestion-item, .history-item { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .suggestion-item:hover, .history-item:hover { background: #f8f9fa; }
        .suggestion-item:last-child, .history-item:last-child { border-bottom: none; }
        .suggestion-type { font-size: 12px; color: #666; background: #e9ecef; padding: 2px 6px; border-radius: 10px; }
        
        /* å¿«é€Ÿæ·»åŠ æ‚¬æµ®æŒ‰é’® */
        .quick-add-fab { position: fixed; bottom: 80px; right: 20px; width: 56px; height: 56px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); cursor: pointer; z-index: 100; transition: transform 0.2s, box-shadow 0.2s; }
        .quick-add-fab:hover { transform: scale(1.1); box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6); }
        .quick-add-fab span { color: white; font-size: 24px; font-weight: bold; }
        
        /* å¿«é€Ÿæ·»åŠ æ¨¡æ€æ¡† */
        .quick-add-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; display: none; }
        .quick-add-content { background: white; margin: 20px; border-radius: 12px; padding: 0; max-height: calc(100vh - 40px); overflow-y: auto; }
        .quick-add-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .quick-add-modes { display: flex; background: #f8f9fa; border-bottom: 1px solid #eee; }
        .quick-mode { flex: 1; padding: 12px; text-align: center; cursor: pointer; color: #666; font-size: 14px; }
        .quick-mode.active { background: white; color: #667eea; font-weight: bold; }
        .quick-add-body { padding: 20px; }
        
        /* æ™ºèƒ½è¯†åˆ«æ¨¡å¼ */
        .smart-input { position: relative; }
        .smart-input textarea { width: 100%; padding: 15px; border: 2px dashed #ddd; border-radius: 8px; font-size: 16px; min-height: 120px; resize: vertical; }
        .smart-input.processing textarea { border-color: #667eea; background: #f8f9ff; }
        .smart-suggestions { background: #e3f2fd; border-radius: 8px; padding: 15px; margin-top: 15px; display: none; }
        .smart-suggestions h4 { margin-bottom: 10px; color: #1976d2; }
        .parsed-items { display: flex; flex-direction: column; gap: 10px; }
        .parsed-item { background: white; padding: 12px; border-radius: 6px; border: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .parsed-item.confirmed { border-color: #4caf50; background: #f1f8e9; }
        .parsed-item-info { flex: 1; }
        .parsed-item-name { font-weight: bold; }
        .parsed-item-details { font-size: 12px; color: #666; }
        .parsed-item-actions button { margin-left: 5px; padding: 4px 8px; font-size: 12px; }
        
        /* è¿æ‹æ¨¡å¼ */
        .batch-camera { text-align: center; }
        .camera-preview { position: relative; margin: 15px 0; }
        .camera-video { width: 100%; max-width: 300px; border-radius: 8px; }
        .camera-controls { margin: 15px 0; }
        .capture-btn { background: #ff4444; color: white; border: none; padding: 15px 25px; border-radius: 50px; font-size: 16px; cursor: pointer; }
        .capture-btn:hover { background: #cc0000; }
        .captured-images { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .captured-image { position: relative; width: 80px; height: 80px; }
        .captured-image img { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; }
        .captured-image .remove-btn { position: absolute; top: -5px; right: -5px; background: #ff4444; color: white; border: none; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; font-size: 12px; }
        
        /* ç§»åŠ¨ç«¯æ‰‹åŠ¿ä¼˜åŒ– */
        .swipe-actions { position: absolute; right: 0; top: 0; height: 100%; display: flex; align-items: center; transform: translateX(100%); transition: transform 0.3s ease; z-index: 10; }
        .swipe-actions.show { transform: translateX(0); }
        .swipe-action { background: #ff4444; color: white; padding: 0 20px; height: 100%; display: flex; align-items: center; cursor: pointer; font-size: 14px; white-space: nowrap; }
        .swipe-action.edit { background: #ffc107; }
        .swipe-action.qr { background: #28a745; }
        .item-card { position: relative; overflow: hidden; touch-action: pan-y; }
        .item-card.swiping { transition: transform 0.1s ease; }
        .item-card.swiped { transform: translateX(-120px); }
        
        /* ä¸‹æ‹‰åˆ·æ–° */
        .pull-refresh { position: relative; }
        .pull-refresh-indicator { position: absolute; top: -60px; left: 50%; transform: translateX(-50%); background: white; padding: 10px 20px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); font-size: 14px; color: #666; transition: all 0.3s ease; }
        .pull-refresh.pulling .pull-refresh-indicator { top: 10px; }
        .pull-refresh.refreshing .pull-refresh-indicator { top: 10px; color: #667eea; }
        
        /* åŒå‡»æ”¾å¤§å›¾ç‰‡ */
        .image-zoom-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1003; display: none; justify-content: center; align-items: center; }
        .image-zoom-modal img { max-width: 90%; max-height: 90%; object-fit: contain; }
        .image-zoom-modal .close-zoom { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; }
        
        /* å¿«æ·æ“ä½œé¢æ¿ */
        .quick-actions-panel { 
            position: fixed; 
            bottom: -200px; 
            left: 0; 
            right: 0; 
            background: white; 
            border-radius: 20px 20px 0 0; 
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1); 
            z-index: 101; 
            transition: bottom 0.3s ease; 
            padding: 20px; 
            pointer-events: none; /* éšè—æ—¶ä¸æ¥æ”¶ç‚¹å‡»äº‹ä»¶ */
        }
        .quick-actions-panel.show { 
            bottom: 0; 
            pointer-events: auto; /* æ˜¾ç¤ºæ—¶æ¥æ”¶ç‚¹å‡»äº‹ä»¶ */
        }
        .quick-actions-header { text-align: center; margin-bottom: 20px; color: #333; font-weight: bold; }
        .quick-actions-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .quick-action-item { text-align: center; padding: 15px 10px; border-radius: 12px; background: #f8f9fa; cursor: pointer; transition: all 0.2s; }
        .quick-action-item:hover { background: #e9ecef; transform: scale(1.05); }
        .quick-action-icon { font-size: 24px; margin-bottom: 8px; }
        .quick-action-label { font-size: 12px; color: #666; }
        .item-card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .item-name { font-weight: bold; font-size: 16px; }
        .item-time { color: #999; font-size: 12px; }
        .item-info { color: #666; font-size: 14px; }
        .item-content { display: flex; gap: 10px; }
        .item-image { width: 60px; height: 60px; object-fit: cover; border-radius: 6px; flex-shrink: 0; }
        .item-details { flex: 1; }
        
        .image-upload { margin-bottom: 15px; }
        .image-preview { max-width: 200px; max-height: 200px; margin: 10px 0; border-radius: 8px; display: block; }
        .image-upload-btn { display: inline-block; padding: 8px 16px; background: #28a745; color: white; border-radius: 4px; cursor: pointer; margin-right: 10px; text-decoration: none; }
        .image-upload-btn:hover { background: #218838; }
        .image-remove-btn { background: #dc3545; padding: 6px 12px; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .image-remove-btn:hover { background: #c82333; }
        
        .detail-row { margin-bottom: 10px; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .detail-label { font-weight: bold; color: #333; display: inline-block; min-width: 80px; }
        .detail-actions { display: flex; gap: 10px; }
        .detail-actions .btn { flex: 1; }
        .item-card { cursor: pointer; transition: transform 0.2s; }
        .item-card:hover { transform: translateY(-2px); }
        
        .stats-overview { display: flex; gap: 10px; margin-bottom: 20px; }
        .stat-card { flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-number { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 12px; opacity: 0.9; }
        .charts-container { display: flex; flex-direction: column; gap: 20px; }
        .chart-section { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .chart-section h4 { margin-bottom: 15px; color: #333; font-size: 16px; }
        .chart-section canvas { max-width: 100%; height: 200px !important; display: block; margin: 0 auto; }
        .chart-container { position: relative; height: 200px; width: 100%; }
        
        .search-filters { background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid #dee2e6; }
        .filter-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-end; }
        .filter-item { flex: 1; }
        .filter-item label { display: block; font-size: 12px; color: #666; margin-bottom: 5px; }
        .filter-item select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .btn-link { background: none; border: none; color: #667eea; cursor: pointer; font-size: 14px; text-decoration: underline; }
        .btn-link:hover { color: #5a6fd8; }
        
        .batch-operations { background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid #dee2e6; }
        .batch-row { display: flex; gap: 10px; }
        .btn-export, .btn-import { border: none; border-radius: 6px; cursor: pointer; color: white; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; }
        .btn-export:hover { background: #218838 !important; }
        .btn-import:hover { background: #138496 !important; }
        
        .history-item { border-left: 3px solid #667eea; padding: 12px 15px; margin-bottom: 10px; background: #f8f9fa; border-radius: 0 6px 6px 0; }
        .history-item.create { border-left-color: #28a745; }
        .history-item.update { border-left-color: #ffc107; }
        .history-item.delete { border-left-color: #dc3545; }
        .history-action { font-weight: bold; color: #333; margin-bottom: 5px; }
        .history-time { font-size: 12px; color: #666; margin-bottom: 8px; }
        .history-changes { font-size: 14px; color: #555; }
        .history-change { margin-bottom: 4px; }
        .history-old { background: #ffe6e6; padding: 2px 6px; border-radius: 3px; text-decoration: line-through; }
        .history-new { background: #e6ffe6; padding: 2px 6px; border-radius: 3px; }
        
        .btn { background: #667eea; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 10px; }
        .btn:hover { background: #5a6fd8; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #333; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; margin: 50px auto; padding: 20px; width: 90%; max-width: 400px; border-radius: 8px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .close { background: none; border: none; font-size: 24px; cursor: pointer; }
        .location-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .location-actions button { margin-left: 8px; padding: 6px 12px; font-size: 12px; }
        .btn-danger { background: #ff6b6b; }
        .btn-secondary { background: #6c757d; }
        .empty-state { text-align: center; padding: 40px; color: #999; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” å¯»ç‰©åŠ©æ‰‹</h1>
            <p>è®©ç‰©å“ç®¡ç†å˜å¾—ç®€å•</p>
        </div>

        <div class="tab-bar">
            <div class="tab active" onclick="showTab('items')">ç‰©å“</div>
            <div class="tab" onclick="showTab('categories')">åˆ†ç±»</div>
            <div class="tab" onclick="showTab('locations')">ä½ç½®</div>
            <div class="tab" onclick="showTab('statistics')">ç»Ÿè®¡</div>
            <div class="tab" onclick="showTab('add')">æ·»åŠ </div>
        </div>
        
        <!-- å¿«é€Ÿæ·»åŠ æ‚¬æµ®æŒ‰é’® -->
        <div class="quick-add-fab" onclick="showQuickAddModal()" title="å¿«é€Ÿæ·»åŠ ">
            <span>+</span>
        </div>

        <!-- ç‰©å“åˆ—è¡¨é¡µé¢ -->
        <div id="items-page" class="content">
            <div class="search-container">
                <div class="search-input-wrapper">
                    <input type="text" class="search-box" placeholder="æœç´¢ç‰©å“ã€åˆ†ç±»æˆ–ä½ç½®..." id="search-input">
                    <button class="voice-search-btn" onclick="startVoiceSearch()" title="è¯­éŸ³æœç´¢">ğŸ¤</button>
                    <button class="camera-search-btn" onclick="startCameraSearch()" title="æ‰«ç æœç´¢">ğŸ“·</button>
                </div>
                <div id="search-suggestions" class="search-suggestions" style="display: none;"></div>
                <div id="search-history" class="search-history" style="display: none;"></div>
            </div>
            
            <!-- é«˜çº§æœç´¢è¿‡æ»¤å™¨ -->
            <div class="search-filters" id="search-filters" style="display: none;">
                <div class="filter-row">
                    <div class="filter-item">
                        <label>åˆ†ç±»:</label>
                        <select id="filter-category">
                            <option value="">å…¨éƒ¨åˆ†ç±»</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>ä½ç½®:</label>
                        <select id="filter-location">
                            <option value="">å…¨éƒ¨ä½ç½®</option>
                        </select>
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-item">
                        <label>æ’åº:</label>
                        <select id="filter-sort">
                            <option value="time-desc">æœ€æ–°æ·»åŠ </option>
                            <option value="time-asc">æœ€æ—©æ·»åŠ </option>
                            <option value="name-asc">åç§° A-Z</option>
                            <option value="name-desc">åç§° Z-A</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <button class="btn btn-secondary" onclick="clearFilters()" style="background: #6c757d; margin-top: 10px; padding: 8px 16px; font-size: 12px;">æ¸…é™¤ç­›é€‰</button>
                    </div>
                </div>
            </div>
            
            <div class="search-toggle" style="text-align: center; margin-bottom: 15px;">
                <button class="btn-link" onclick="toggleSearchFilters()" id="filter-toggle">ğŸ” é«˜çº§æœç´¢</button>
                <span style="margin: 0 10px;">|</span>
                <button class="btn-link" onclick="toggleBatchOperations()" id="batch-toggle">ğŸ“‹ æ‰¹é‡æ“ä½œ</button>
            </div>
            
            <!-- æ‰¹é‡æ“ä½œåŒºåŸŸ -->
            <div class="batch-operations" id="batch-operations" style="display: none;">
                <div class="batch-row">
                    <button class="btn btn-export" onclick="exportItems()" style="background: #28a745; flex: 1; margin-right: 5px; padding: 10px; font-size: 14px;">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
                    <label for="import-file-input" class="btn btn-import" style="background: #17a2b8; flex: 1; margin-left: 5px; padding: 10px; font-size: 14px; text-align: center; cursor: pointer;">ğŸ“¥ å¯¼å…¥æ•°æ®</label>
                    <input type="file" id="import-file-input" accept=".csv,.json" style="display: none;">
                </div>
                <div class="batch-info" style="margin-top: 10px; font-size: 12px; color: #666; text-align: center;">
                    æ”¯æŒCSVå’ŒJSONæ ¼å¼çš„å¯¼å…¥å¯¼å‡º
                </div>
            </div>
            
            <div id="items-list">
                <div class="empty-state">
                    <p>æš‚æ— ç‰©å“è®°å½•</p>
                    <p>ç‚¹å‡»"æ·»åŠ "å¼€å§‹ç®¡ç†æ‚¨çš„ç‰©å“</p>
                </div>
            </div>
        </div>

        <!-- åˆ†ç±»ç®¡ç†é¡µé¢ -->
        <div id="categories-page" class="content" style="display:none;">
            <button class="btn" onclick="showAddCategoryModal()">+ æ·»åŠ åˆ†ç±»</button>
            <div id="categories-list" style="margin-top: 15px;">
                <div class="empty-state">
                    <p>æ­£åœ¨åŠ è½½åˆ†ç±»...</p>
                </div>
            </div>
        </div>

        <!-- ä½ç½®ç®¡ç†é¡µé¢ -->
        <div id="locations-page" class="content" style="display:none;">
            <button class="btn" onclick="showAddLocationModal()">+ æ·»åŠ ä½ç½®</button>
            <div id="locations-list" style="margin-top: 15px;">
                <div class="empty-state">
                    <p>æš‚æ— ä½ç½®è®°å½•</p>
                    <p>å…ˆæ·»åŠ ä½ç½®ï¼Œå†ç®¡ç†ç‰©å“</p>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡é¡µé¢ -->
        <div id="statistics-page" class="content" style="display:none;">
            <h3 style="margin-bottom: 20px; color: #333;">ğŸ“Š æ•°æ®ç»Ÿè®¡</h3>
            
            <!-- æ¦‚è§ˆå¡ç‰‡ -->
            <div class="stats-overview">
                <div class="stat-card">
                    <div class="stat-number" id="total-items">0</div>
                    <div class="stat-label">æ€»ç‰©å“æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-categories">0</div>
                    <div class="stat-label">åˆ†ç±»æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-locations">0</div>
                    <div class="stat-label">ä½ç½®æ•°</div>
                </div>
            </div>

            <!-- å›¾è¡¨åŒºåŸŸ -->
            <div class="charts-container">
                <div class="chart-section">
                    <h4>æŒ‰åˆ†ç±»ç»Ÿè®¡</h4>
                    <div class="chart-container">
                        <canvas id="category-chart"></canvas>
                    </div>
                </div>
                <div class="chart-section">
                    <h4>æŒ‰ä½ç½®ç»Ÿè®¡</h4>
                    <div class="chart-container">
                        <canvas id="location-chart"></canvas>
                    </div>
                </div>
                <div class="chart-section">
                    <h4>æœ€è¿‘æ·»åŠ è¶‹åŠ¿</h4>
                    <div class="chart-container">
                        <canvas id="trend-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ ç‰©å“é¡µé¢ -->
        <div id="add-page" class="content" style="display:none;">
            <form id="add-item-form">
                <div class="form-group">
                    <label>ç‰©å“åç§°</label>
                    <input type="text" id="item-name" required>
                </div>
                <div class="form-group">
                    <label>åˆ†ç±»</label>
                    <select id="item-category" required>
                        <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ä½ç½®</label>
                    <select id="item-location" required>
                        <option value="">è¯·é€‰æ‹©ä½ç½®</option>
                    </select>
                </div>
                <div class="form-group image-upload">
                    <label>ç‰©å“å›¾ç‰‡</label>
                    <div>
                        <label for="image-input" class="image-upload-btn">ğŸ“· é€‰æ‹©å›¾ç‰‡</label>
                        <input type="file" id="image-input" accept="image/*" style="display: none;">
                        <img id="image-preview" class="image-preview" style="display: none;">
                        <button type="button" id="image-remove" class="image-remove-btn" style="display: none;">ç§»é™¤å›¾ç‰‡</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>æè¿°</label>
                    <textarea id="item-description" rows="3"></textarea>
                </div>
                <button type="submit" class="btn">æ·»åŠ ç‰©å“</button>
            </form>
        </div>
    </div>

    <!-- ç‰©å“è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="item-detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç‰©å“è¯¦æƒ…</h3>
                <button class="close" onclick="closeItemDetailModal()">&times;</button>
            </div>
            <div id="item-detail-content">
                <div class="item-detail-image" id="detail-image-container" style="text-align: center; margin-bottom: 15px;">
                    <img id="detail-image" style="max-width: 100%; max-height: 200px; border-radius: 8px; display: none;">
                </div>
                <div class="item-detail-info">
                    <div class="detail-row">
                        <span class="detail-label">åç§°ï¼š</span>
                        <span id="detail-name"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">åˆ†ç±»ï¼š</span>
                        <span id="detail-category"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">ä½ç½®ï¼š</span>
                        <span id="detail-location"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">æè¿°ï¼š</span>
                        <span id="detail-description"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">æ›´æ–°æ—¶é—´ï¼š</span>
                        <span id="detail-time"></span>
                    </div>
                </div>
                <div class="detail-actions" style="margin-top: 20px;">
                    <button class="btn" onclick="editItem()" style="margin-right: 10px;">ç¼–è¾‘</button>
                    <button class="btn" onclick="showItemQR()" style="background: #28a745; margin-right: 10px;">äºŒç»´ç </button>
                    <button class="btn" onclick="toggleItemHistory()" id="history-toggle" style="background: #6c757d;">å†å²è®°å½•</button>
                </div>
                
                <!-- å†å²è®°å½•åŒºåŸŸ -->
                <div id="item-history" style="display: none; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                    <h4 style="margin-bottom: 15px; color: #333; font-size: 16px;">ğŸ“‹ å˜æ›´å†å²</h4>
                    <div id="history-list" style="max-height: 300px; overflow-y: auto;">
                        <div class="loading-history" style="text-align: center; padding: 20px; color: #666;">
                            æ­£åœ¨åŠ è½½å†å²è®°å½•...
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ç¼–è¾‘è¡¨å• -->
            <div id="item-edit-form" style="display: none;">
                <form id="edit-form">
                    <div class="form-group">
                        <label>ç‰©å“åç§°</label>
                        <input type="text" id="edit-name" required>
                    </div>
                    <div class="form-group">
                        <label>åˆ†ç±»</label>
                        <select id="edit-category" required>
                            <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ä½ç½®</label>
                        <select id="edit-location" required>
                            <option value="">è¯·é€‰æ‹©ä½ç½®</option>
                        </select>
                    </div>
                    <div class="form-group image-upload">
                        <label>ç‰©å“å›¾ç‰‡</label>
                        <div>
                            <label for="edit-image-input" class="image-upload-btn">ğŸ“· æ›´æ¢å›¾ç‰‡</label>
                            <input type="file" id="edit-image-input" accept="image/*" style="display: none;">
                            <img id="edit-image-preview" class="image-preview" style="display: none;">
                            <button type="button" id="edit-image-remove" class="image-remove-btn" style="display: none;">ç§»é™¤å›¾ç‰‡</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>æè¿°</label>
                        <textarea id="edit-description" rows="3"></textarea>
                    </div>
                    <div class="detail-actions">
                        <button type="submit" class="btn" style="margin-right: 10px;">ä¿å­˜</button>
                        <button type="button" class="btn btn-secondary" onclick="cancelEdit()">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- äºŒç»´ç æ˜¾ç¤ºæ¨¡æ€æ¡† -->
    <div id="qr-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç‰©å“äºŒç»´ç </h3>
                <button class="close" onclick="closeQRModal()">&times;</button>
            </div>
            <div class="qr-content" style="text-align: center; padding: 20px;">
                <div id="qr-item-info" style="margin-bottom: 15px;">
                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;" id="qr-item-name"></div>
                    <div style="color: #666; font-size: 14px;" id="qr-item-desc"></div>
                </div>
                <canvas id="qr-canvas" style="border: 1px solid #ddd; border-radius: 8px;"></canvas>
                <div style="margin-top: 15px; color: #666; font-size: 12px;">
                    <p>æ‰“å°æ­¤äºŒç»´ç å¹¶è´´åœ¨ç‰©å“ä¸Š</p>
                    <p>æ‰«ç å³å¯å¿«é€ŸæŸ¥çœ‹ç‰©å“ä¿¡æ¯</p>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="downloadQR()" style="margin-right: 10px; width: auto; padding: 8px 20px;">ä¸‹è½½äºŒç»´ç </button>
                    <button class="btn" onclick="printQR()" style="background: #28a745; width: auto; padding: 8px 20px;">æ‰“å°æ ‡ç­¾</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ åˆ†ç±»æ¨¡æ€æ¡† -->
    <div id="category-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ·»åŠ åˆ†ç±»</h3>
                <button class="close" onclick="closeCategoryModal()">&times;</button>
            </div>
            <form id="add-category-form">
                <div class="form-group">
                    <label>åˆ†ç±»åç§°</label>
                    <input type="text" id="category-name" required placeholder="è¯·è¾“å…¥åˆ†ç±»åç§°">
                </div>
                <button type="submit" class="btn">æ·»åŠ </button>
            </form>
        </div>
    </div>

    <!-- æ·»åŠ ä½ç½®æ¨¡æ€æ¡† -->
    <div id="location-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ·»åŠ ä½ç½®</h3>
                <button class="close" onclick="closeLocationModal()">&times;</button>
            </div>
            <form id="add-location-form">
                <div class="form-group">
                    <label>ä½ç½®åç§°</label>
                    <input type="text" id="location-name" required>
                </div>
                <div class="form-group">
                    <label>å›¾æ ‡</label>
                    <select id="location-icon">
                        <option value="ğŸ“¦">ğŸ“¦ ç›’å­</option>
                        <option value="ğŸ ">ğŸ  æˆ¿å±‹</option>
                        <option value="ğŸš—">ğŸš— æ±½è½¦</option>
                        <option value="ğŸ’¼">ğŸ’¼ å…¬æ–‡åŒ…</option>
                        <option value="ğŸ‘œ">ğŸ‘œ æ‰‹æåŒ…</option>
                        <option value="ğŸ’">ğŸ’ èƒŒåŒ…</option>
                    </select>
                </div>
                <button type="submit" class="btn">æ·»åŠ </button>
            </form>
        </div>
    </div>

    <!-- å¿«é€Ÿæ·»åŠ æ¨¡æ€æ¡† -->
    <div id="quick-add-modal" class="quick-add-modal">
        <div class="quick-add-content">
            <div class="quick-add-header">
                <h3>ğŸš€ å¿«é€Ÿæ·»åŠ </h3>
                <button class="close" onclick="closeQuickAddModal()">&times;</button>
            </div>
            
            <div class="quick-add-modes">
                <div class="quick-mode active" onclick="switchQuickMode('smart')">ğŸ¤– æ™ºèƒ½è¯†åˆ«</div>
                <div class="quick-mode" onclick="switchQuickMode('camera')">ğŸ“· è¿æ‹æ¨¡å¼</div>
                <div class="quick-mode" onclick="switchQuickMode('voice')">ğŸ¤ è¯­éŸ³å½•å…¥</div>
            </div>
            
            <div class="quick-add-body">
                <!-- æ™ºèƒ½è¯†åˆ«æ¨¡å¼ -->
                <div id="smart-mode" class="quick-mode-content">
                    <div class="smart-input">
                        <textarea id="smart-input-text" placeholder="è¯·æè¿°æ‚¨è¦æ·»åŠ çš„ç‰©å“ï¼Œä¾‹å¦‚ï¼š
åœ¨å®¢å…çš„iPhone 15ï¼Œç™½è‰²çš„ï¼Œç”µå­äº§å“
åœ¨ä¹¦æˆ¿çš„ã€Šä¸‰ä½“ã€‹å°è¯´ï¼Œç§‘å¹»ç±»ä¹¦ç±
åœ¨å¨æˆ¿çš„ä¸é”ˆé’¢é”…ï¼Œç”Ÿæ´»ç”¨å“

æ”¯æŒå¤šè¡Œè¾“å…¥ï¼Œç³»ç»Ÿä¼šæ™ºèƒ½è¯†åˆ«å’Œåˆ†ç±»æ‚¨çš„ç‰©å“ä¿¡æ¯ã€‚"></textarea>
                    </div>
                    <div class="smart-suggestions" id="smart-suggestions">
                        <h4>ğŸ¯ è¯†åˆ«ç»“æœ</h4>
                        <div class="parsed-items" id="parsed-items"></div>
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn" onclick="processSmartInput()" style="width: auto; padding: 12px 30px;">ğŸ¤– æ™ºèƒ½è¯†åˆ«</button>
                        <button class="btn" onclick="confirmSmartItems()" id="confirm-smart-btn" style="background: #28a745; width: auto; padding: 12px 30px; margin-left: 10px; display: none;">âœ“ ç¡®è®¤æ·»åŠ </button>
                    </div>
                </div>
                
                <!-- è¿æ‹æ¨¡å¼ -->
                <div id="camera-mode" class="quick-mode-content" style="display: none;">
                    <div class="batch-camera">
                        <p style="color: #666; margin-bottom: 15px;">ğŸ“· è¿ç»­æ‹ç…§å¤šä¸ªç‰©å“ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«å¹¶ç”Ÿæˆè®°å½•</p>
                        <div class="camera-preview">
                            <video id="quick-camera-video" class="camera-video" style="display: none;"></video>
                            <canvas id="quick-camera-canvas" style="display: none;"></canvas>
                        </div>
                        <div class="camera-controls">
                            <button class="capture-btn" onclick="startQuickCamera()" id="start-camera-btn">ğŸ“· å¯åŠ¨æ‘„åƒå¤´</button>
                            <button class="capture-btn" onclick="captureQuickPhoto()" id="capture-btn" style="display: none;">ğŸ“¸ æ‹ç…§</button>
                        </div>
                        <div class="captured-images" id="captured-images"></div>
                        <div style="margin-top: 20px; text-align: center;" id="camera-actions" style="display: none;">
                            <button class="btn" onclick="processQuickPhotos()" style="width: auto; padding: 12px 30px;">ğŸ¤– è¯†åˆ«ç…§ç‰‡</button>
                        </div>
                    </div>
                </div>
                
                <!-- è¯­éŸ³å½•å…¥æ¨¡å¼ -->
                <div id="voice-mode" class="quick-mode-content" style="display: none;">
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ¤</div>
                        <h3 style="margin-bottom: 15px;">è¯­éŸ³å¿«é€Ÿå½•å…¥</h3>
                        <p style="color: #666; margin-bottom: 30px;">æŒ‰ä½ä¸‹æ–¹æŒ‰é’®è¯´è¯ï¼Œæè¿°æ‚¨è¦æ·»åŠ çš„ç‰©å“</p>
                        <button class="capture-btn" onclick="startQuickVoiceInput()" id="voice-input-btn" style="background: #667eea; padding: 20px 40px; font-size: 18px;">ğŸ¤ å¼€å§‹å½•éŸ³</button>
                        <div id="voice-result" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none;">
                            <h4>è¯­éŸ³è¯†åˆ«ç»“æœï¼š</h4>
                            <p id="voice-text" style="margin: 10px 0; font-size: 16px;"></p>
                            <button class="btn" onclick="processVoiceResult()" style="width: auto; padding: 10px 20px;">è½¬ä¸ºç‰©å“ä¿¡æ¯</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡† -->
    <div id="image-zoom-modal" class="image-zoom-modal">
        <img id="zoom-image" src="" alt="æ”¾å¤§å›¾ç‰‡">
        <button class="close-zoom" onclick="closeImageZoom()">Ã—</button>
    </div>

    <!-- å¿«æ·æ“ä½œé¢æ¿ -->
    <div id="quick-actions-panel" class="quick-actions-panel" onclick="hideQuickActionsPanel()">
        <div class="quick-actions-header" onclick="event.stopPropagation()">
            å¿«æ·æ“ä½œ
            <button onclick="hideQuickActionsPanel(); event.stopPropagation();" style="float: right; background: none; border: none; font-size: 18px; cursor: pointer;">Ã—</button>
        </div>
        <div class="quick-actions-grid" onclick="event.stopPropagation()">
            <div class="quick-action-item" onclick="showQuickAddModal(); hideQuickActionsPanel();">
                <div class="quick-action-icon">â•</div>
                <div class="quick-action-label">å¿«é€Ÿæ·»åŠ </div>
            </div>
            <div class="quick-action-item" onclick="startVoiceSearch(); hideQuickActionsPanel();">
                <div class="quick-action-icon">ğŸ¤</div>
                <div class="quick-action-label">è¯­éŸ³æœç´¢</div>
            </div>
            <div class="quick-action-item" onclick="startCameraSearch(); hideQuickActionsPanel();">
                <div class="quick-action-icon">ğŸ“·</div>
                <div class="quick-action-label">æ‰«ç æœç´¢</div>
            </div>
            <div class="quick-action-item" onclick="exportItems(); hideQuickActionsPanel();">
                <div class="quick-action-icon">ğŸ’¾</div>
                <div class="quick-action-label">å¯¼å‡ºæ•°æ®</div>
            </div>
            <div class="quick-action-item" onclick="showTab('statistics'); hideQuickActionsPanel();">
                <div class="quick-action-icon">ğŸ“Š</div>
                <div class="quick-action-label">æŸ¥çœ‹ç»Ÿè®¡</div>
            </div>
            <div class="quick-action-item" onclick="toggleSearchFilters(); hideQuickActionsPanel();">
                <div class="quick-action-icon">ğŸ”</div>
                <div class="quick-action-label">é«˜çº§æœç´¢</div>
            </div>
            <div class="quick-action-item" onclick="refreshAllData(); hideQuickActionsPanel();">
                <div class="quick-action-icon">ğŸ”„</div>
                <div class="quick-action-label">åˆ·æ–°æ•°æ®</div>
            </div>
            <div class="quick-action-item" onclick="showBackupManager(); hideQuickActionsPanel();">
                <div class="quick-action-icon">ğŸ’¾</div>
                <div class="quick-action-label">æ•°æ®å¤‡ä»½</div>
            </div>
            <div class="quick-action-item" onclick="showAppInfo(); hideQuickActionsPanel();">
                <div class="quick-action-icon">â„¹ï¸</div>
                <div class="quick-action-label">åº”ç”¨ä¿¡æ¯</div>
            </div>
            <div class="quick-action-item" onclick="performanceMonitor.showPerformanceReport(); hideQuickActionsPanel();">
                <div class="quick-action-icon">ğŸ“Š</div>
                <div class="quick-action-label">æ€§èƒ½æŠ¥å‘Š</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        let currentUser = { userId: 10001 }; // æ¨¡æ‹Ÿç”¨æˆ·ID
        let currentImageUrl = null; // å½“å‰ä¸Šä¼ çš„å›¾ç‰‡URL
        let isServerAvailable = false; // æœåŠ¡å™¨å¯ç”¨æ€§æ ‡å¿—

        // æ£€æŸ¥æœåŠ¡å™¨è¿æ¥çŠ¶æ€
        async function checkServerConnection() {
            try {
                const response = await fetch(`${API_BASE}/health`, { 
                    method: 'GET',
                    timeout: 3000 // 3ç§’è¶…æ—¶
                });
                isServerAvailable = response.ok;
                return isServerAvailable;
            } catch (error) {
                console.log('åç«¯æœåŠ¡å™¨æœªè¿æ¥ï¼Œå°†ä½¿ç”¨æ¼”ç¤ºæ¨¡å¼');
                isServerAvailable = false;
                return false;
            }
        }

        // æ˜¾ç¤ºè¿æ¥çŠ¶æ€æç¤º
        function showConnectionStatus() {
            if (!isServerAvailable) {
                const statusDiv = document.createElement('div');
                statusDiv.innerHTML = `
                    <div style="position: fixed; top: 10px; left: 10px; right: 10px; background: #ffc107; color: #856404; padding: 12px; border-radius: 8px; z-index: 1005; text-align: center; font-size: 14px;">
                        âš ï¸ æ¼”ç¤ºæ¨¡å¼ - åç«¯æœåŠ¡å™¨æœªå¯åŠ¨ï¼Œéƒ¨åˆ†åŠŸèƒ½å°†ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                        <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; color: #856404; cursor: pointer;">Ã—</button>
                    </div>
                `;
                document.body.appendChild(statusDiv);
                
                // 10ç§’åè‡ªåŠ¨æ¶ˆå¤±
                setTimeout(() => {
                    if (statusDiv.parentNode) {
                        statusDiv.remove();
                    }
                }, 10000);
            }
        }

        // åˆå§‹åŒ–æ—¶æ£€æŸ¥è¿æ¥
        window.addEventListener('load', async () => {
            // æ£€æŸ¥æ˜¯å¦é€šè¿‡æ–‡ä»¶åè®®è®¿é—®
            if (location.protocol === 'file:') {
                showLocalFileWarning();
                return;
            }
            
            await checkServerConnection();
            showConnectionStatus();
        });

        // å®‰å…¨çš„APIè°ƒç”¨åŒ…è£…å‡½æ•°
        async function safeApiCall(url, options = {}) {
            if (!isServerAvailable) {
                // è¿”å›æ¨¡æ‹Ÿæ•°æ®
                return {
                    success: true,
                    data: getMockData(url),
                    message: 'æ¼”ç¤ºæ¨¡å¼æ•°æ®'
                };
            }
            
            try {
                const response = await fetch(url, options);
                return await response.json();
            } catch (error) {
                console.error('APIè°ƒç”¨å¤±è´¥:', error);
                return {
                    success: false,
                    message: 'ç½‘ç»œè¿æ¥å¤±è´¥',
                    data: null
                };
            }
        }

        // è·å–æ¨¡æ‹Ÿæ•°æ®
        function getMockData(url) {
            if (url.includes('/item/list')) {
                return {
                    items: [
                        {
                            itemId: 1,
                            name: 'iPhone 15',
                            category: 'ç”µå­äº§å“',
                            location: 'å®¢å…',
                            description: 'ç™½è‰²ï¼Œ128GB',
                            imageUrl: null,
                            lastUpdateTime: new Date().toISOString()
                        },
                        {
                            itemId: 2,
                            name: 'ã€Šä¸‰ä½“ã€‹',
                            category: 'ä¹¦ç±æ–‡å…·',
                            location: 'ä¹¦æˆ¿',
                            description: 'åˆ˜æ…ˆæ¬£ç§‘å¹»å°è¯´',
                            imageUrl: null,
                            lastUpdateTime: new Date(Date.now() - 86400000).toISOString()
                        }
                    ]
                };
            } else if (url.includes('/category/list')) {
                return [
                    { categoryId: 1, name: 'ç”µå­äº§å“', isSystem: true },
                    { categoryId: 2, name: 'ä¹¦ç±æ–‡å…·', isSystem: true },
                    { categoryId: 3, name: 'ç”Ÿæ´»ç”¨å“', isSystem: true }
                ];
            } else if (url.includes('/location/list')) {
                return [
                    { locationId: 1, name: 'å®¢å…', icon: 'ğŸ›‹ï¸' },
                    { locationId: 2, name: 'ä¹¦æˆ¿', icon: 'ğŸ“š' },
                    { locationId: 3, name: 'å§å®¤', icon: 'ğŸ›ï¸' }
                ];
            }
            return null;
        }

        // æ˜¾ç¤ºæœ¬åœ°æ–‡ä»¶è®¿é—®è­¦å‘Š
        function showLocalFileWarning() {
            const warningDiv = document.createElement('div');
            warningDiv.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; max-width: 500px; margin: 20px; border-radius: 12px; padding: 30px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 20px;">âš ï¸</div>
                        <h2 style="color: #e74c3c; margin-bottom: 20px;">éœ€è¦é€šè¿‡HTTPæœåŠ¡å™¨è®¿é—®</h2>
                        <p style="margin-bottom: 20px; line-height: 1.6; color: #555;">
                            æ‚¨æ­£åœ¨é€šè¿‡æœ¬åœ°æ–‡ä»¶æ–¹å¼è®¿é—®åº”ç”¨ï¼Œè¿™ä¼šå¯¼è‡´ä»¥ä¸‹åŠŸèƒ½æ— æ³•æ­£å¸¸å·¥ä½œï¼š<br>
                            â€¢ Service Worker (PWAåŠŸèƒ½)<br>
                            â€¢ è¯­éŸ³è¯†åˆ«<br>
                            â€¢ æ‘„åƒå¤´è®¿é—®<br>
                            â€¢ åç«¯APIè¿æ¥
                        </p>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left;">
                            <strong>ğŸš€ æ­£ç¡®å¯åŠ¨æ–¹å¼ï¼š</strong><br>
                            <code style="background: #e9ecef; padding: 2px 6px; border-radius: 4px; font-family: monospace;">
                                cd /mnt/f/Work\\ Space/Search\\ Assistant<br>
                                ./start.sh
                            </code><br>
                            ç„¶åè®¿é—®: <a href="http://localhost:8080/index.html" target="_blank">http://localhost:8080/index.html</a>
                        </div>
                        <button onclick="this.closest('div').parentElement.remove()" style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px;">
                            æˆ‘çŸ¥é“äº†ï¼Œç»§ç»­æ¼”ç¤º
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(warningDiv);
        }

        // DOM å®‰å…¨è®¿é—®å·¥å…·å‡½æ•°
        function safeGetElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`Element with id '${id}' not found`);
                return null;
            }
            return element;
        }

        // å®‰å…¨çš„DOMæ“ä½œå‡½æ•°
        function safeSetTextContent(id, content) {
            const element = safeGetElement(id);
            if (element) {
                element.textContent = content;
            }
        }

        function safeSetStyle(id, property, value) {
            const element = safeGetElement(id);
            if (element) {
                element.style[property] = value;
            }
        }

        function safeAddEventListener(id, event, handler) {
            const element = safeGetElement(id);
            if (element) {
                element.addEventListener(event, handler);
            }
        }

        function safeSetValue(id, value) {
            const element = safeGetElement(id);
            if (element) {
                element.value = value;
            }
        }

        function safeGetValue(id) {
            const element = safeGetElement(id);
            return element ? element.value : '';
        }

        function safeSetInnerHTML(id, html) {
            const element = safeGetElement(id);
            if (element) {
                element.innerHTML = html;
            }
        }

        function safeSetSrc(id, src) {
            const element = safeGetElement(id);
            if (element) {
                element.src = src;
            }
        }

        // å…¨å±€é”™è¯¯å¤„ç†æœºåˆ¶
        function handleAsyncError(error, context = 'Unknown operation') {
            console.error(`å¼‚æ­¥æ“ä½œé”™è¯¯ [${context}]:`, error);
            
            // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
            if (error.name === 'TypeError' && error.message.includes('fetch')) {
                showToast('âŒ ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®', 3000);
            } else if (error.name === 'SyntaxError') {
                showToast('âŒ æ•°æ®æ ¼å¼é”™è¯¯ï¼Œè¯·é‡è¯•', 3000);
            } else {
                showToast(`âŒ æ“ä½œå¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`, 3000);
            }
            
            return false;
        }

        // å®‰å…¨çš„å¼‚æ­¥å‡½æ•°åŒ…è£…å™¨
        function safeAsync(asyncFn, context) {
            return async function(...args) {
                try {
                    return await asyncFn.apply(this, args);
                } catch (error) {
                    return handleAsyncError(error, context);
                }
            };
        }

        // DOMæ“ä½œé”™è¯¯å¤„ç†åŒ…è£…
        function safeDOMOperation(operation, context = 'DOM operation') {
            try {
                return operation();
            } catch (error) {
                console.warn(`DOMæ“ä½œå¤±è´¥ [${context}]:`, error);
                return null;
            }
        }

        // æ€§èƒ½ä¼˜åŒ–å·¥å…·
        class PerformanceOptimizer {
            constructor() {
                this.intersectionObserver = null;
                this.lazyElements = new Set();
                this.initLazyLoading();
                this.initPerformanceMonitoring();
            }

            // åˆå§‹åŒ–æ‡’åŠ è½½
            initLazyLoading() {
                if ('IntersectionObserver' in window) {
                    this.intersectionObserver = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                this.loadLazyElement(entry.target);
                                this.intersectionObserver.unobserve(entry.target);
                            }
                        });
                    }, { threshold: 0.1 });
                }
            }

            // æ·»åŠ æ‡’åŠ è½½å…ƒç´ 
            addLazyElement(element) {
                if (this.intersectionObserver) {
                    this.lazyElements.add(element);
                    this.intersectionObserver.observe(element);
                }
            }

            // åŠ è½½æ‡’åŠ è½½å…ƒç´ 
            loadLazyElement(element) {
                if (element.dataset.src) {
                    element.src = element.dataset.src;
                    element.removeAttribute('data-src');
                }
                if (element.dataset.action) {
                    // æ‰§è¡Œå»¶è¿Ÿæ“ä½œ
                    const action = new Function(element.dataset.action);
                    action();
                    element.removeAttribute('data-action');
                }
                this.lazyElements.delete(element);
            }

            // åˆå§‹åŒ–æ€§èƒ½ç›‘æ§
            initPerformanceMonitoring() {
                // ç›‘æ§é¡µé¢åŠ è½½æ€§èƒ½
                if ('performance' in window && 'getEntriesByType' in performance) {
                    window.addEventListener('load', () => {
                        setTimeout(() => {
                            const perfData = performance.getEntriesByType('navigation')[0];
                            if (perfData) {
                                console.log('é¡µé¢æ€§èƒ½æ•°æ®:', {
                                    DNSæŸ¥è¯¢: Math.round(perfData.domainLookupEnd - perfData.domainLookupStart),
                                    è¿æ¥æ—¶é—´: Math.round(perfData.connectEnd - perfData.connectStart),
                                    å“åº”æ—¶é—´: Math.round(perfData.responseEnd - perfData.responseStart),
                                    DOMè§£æ: Math.round(perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart),
                                    æ€»åŠ è½½æ—¶é—´: Math.round(perfData.loadEventEnd - perfData.navigationStart)
                                });
                            }
                        }, 1000);
                    });
                }
            }

            // å†…å­˜ä½¿ç”¨ç›‘æ§
            getMemoryUsage() {
                if ('memory' in performance) {
                    return {
                        used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024),
                        total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024),
                        limit: Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024)
                    };
                }
                return null;
            }

            // æ¸…ç†æœªä½¿ç”¨çš„èµ„æº
            cleanup() {
                if (this.intersectionObserver) {
                    this.intersectionObserver.disconnect();
                }
                this.lazyElements.clear();
            }
        }

        // èŠ‚æµå‡½æ•°ä¼˜åŒ–
        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        // é˜²æŠ–å‡½æ•°ä¼˜åŒ– (å·²å­˜åœ¨ä½†å¯èƒ½éœ€è¦ä¼˜åŒ–)
        function debounce(func, delay) {
            let timeoutId;
            return function (...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // æ‰¹é‡DOMæ›´æ–°ä¼˜åŒ–
        class DOMBatchUpdater {
            constructor() {
                this.updates = [];
                this.scheduled = false;
            }

            // æ·»åŠ æ›´æ–°ä»»åŠ¡
            addUpdate(updateFn) {
                this.updates.push(updateFn);
                if (!this.scheduled) {
                    this.scheduled = true;
                    requestAnimationFrame(() => this.flush());
                }
            }

            // æ‰§è¡Œæ‰¹é‡æ›´æ–°
            flush() {
                const updates = this.updates.slice();
                this.updates.length = 0;
                this.scheduled = false;
                
                updates.forEach(update => {
                    try {
                        update();
                    } catch (error) {
                        console.warn('æ‰¹é‡æ›´æ–°å¤±è´¥:', error);
                    }
                });
            }
        }

        // åˆå§‹åŒ–æ€§èƒ½ä¼˜åŒ–å™¨
        const performanceOptimizer = new PerformanceOptimizer();
        const domBatchUpdater = new DOMBatchUpdater();

        // åº”ç”¨æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–
        class ApplicationPerformanceMonitor {
            constructor() {
                this.metrics = {
                    pageLoad: 0,
                    apiCalls: 0,
                    domOperations: 0,
                    errors: 0,
                    memoryUsage: []
                };
                this.startTime = performance.now();
                this.initMonitoring();
            }

            // åˆå§‹åŒ–ç›‘æ§
            initMonitoring() {
                // ç›‘æ§APIè°ƒç”¨
                this.wrapFetch();
                
                // å®šæœŸæ£€æŸ¥å†…å­˜ä½¿ç”¨
                setInterval(() => {
                    const memory = performanceOptimizer.getMemoryUsage();
                    if (memory) {
                        this.metrics.memoryUsage.push({
                            timestamp: Date.now(),
                            ...memory
                        });
                        // ä¿ç•™æœ€è¿‘100æ¡è®°å½•
                        if (this.metrics.memoryUsage.length > 100) {
                            this.metrics.memoryUsage = this.metrics.memoryUsage.slice(-100);
                        }
                    }
                }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡

                // ç›‘æ§é•¿ä»»åŠ¡
                if ('PerformanceObserver' in window) {
                    try {
                        const observer = new PerformanceObserver((list) => {
                            for (const entry of list.getEntries()) {
                                if (entry.duration > 50) { // è¶…è¿‡50msçš„ä»»åŠ¡
                                    console.warn('æ£€æµ‹åˆ°é•¿ä»»åŠ¡:', {
                                        name: entry.name,
                                        duration: Math.round(entry.duration),
                                        startTime: Math.round(entry.startTime)
                                    });
                                }
                            }
                        });
                        observer.observe({ entryTypes: ['longtask'] });
                    } catch (e) {
                        console.log('é•¿ä»»åŠ¡ç›‘æ§ä¸æ”¯æŒ');
                    }
                }
            }

            // åŒ…è£…fetchä»¥ç›‘æ§APIè°ƒç”¨
            wrapFetch() {
                const originalFetch = window.fetch;
                const self = this;
                
                window.fetch = async function(...args) {
                    const startTime = performance.now();
                    self.metrics.apiCalls++;
                    
                    try {
                        const response = await originalFetch.apply(this, args);
                        const endTime = performance.now();
                        const duration = endTime - startTime;
                        
                        if (duration > 1000) { // è¶…è¿‡1ç§’çš„APIè°ƒç”¨
                            console.warn('æ…¢é€ŸAPIè°ƒç”¨:', {
                                url: args[0],
                                duration: Math.round(duration) + 'ms'
                            });
                        }
                        
                        return response;
                    } catch (error) {
                        self.metrics.errors++;
                        throw error;
                    }
                };
            }

            // è·å–æ€§èƒ½æŠ¥å‘Š
            getPerformanceReport() {
                const uptime = Math.round((performance.now() - this.startTime) / 1000);
                const currentMemory = performanceOptimizer.getMemoryUsage();
                
                return {
                    è¿è¡Œæ—¶é—´: uptime + 'ç§’',
                    APIè°ƒç”¨æ¬¡æ•°: this.metrics.apiCalls,
                    DOMæ“ä½œæ¬¡æ•°: this.metrics.domOperations,
                    é”™è¯¯æ¬¡æ•°: this.metrics.errors,
                    å½“å‰å†…å­˜ä½¿ç”¨: currentMemory ? `${currentMemory.used}MB / ${currentMemory.total}MB` : 'ä¸æ”¯æŒ',
                    å¹³å‡å†…å­˜ä½¿ç”¨: this.metrics.memoryUsage.length > 0 ? 
                        Math.round(this.metrics.memoryUsage.reduce((a, b) => a + b.used, 0) / this.metrics.memoryUsage.length) + 'MB' : 
                        'æ— æ•°æ®'
                };
            }

            // æ˜¾ç¤ºæ€§èƒ½æŠ¥å‘Š
            showPerformanceReport() {
                const report = this.getPerformanceReport();
                const reportText = Object.entries(report)
                    .map(([key, value]) => `${key}: ${value}`)
                    .join('\n');
                
                alert(`ğŸ“Š åº”ç”¨æ€§èƒ½æŠ¥å‘Š\n\n${reportText}`);
            }
        }

        // åˆå§‹åŒ–æ€§èƒ½ç›‘æ§å™¨
        const performanceMonitor = new ApplicationPerformanceMonitor();

        // å›¾ç‰‡ä¸Šä¼ å¤„ç†
        safeAddEventListener('image-input', 'change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }

            // éªŒè¯æ–‡ä»¶å¤§å° (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('å›¾ç‰‡æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB');
                return;
            }

            try {
                // æ˜¾ç¤ºé¢„è§ˆ
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = safeGetElement('image-preview');
                    const removeBtn = safeGetElement('image-remove');
                    if (preview) {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    }
                    if (removeBtn) {
                        removeBtn.style.display = 'inline-block';
                    }
                };
                reader.readAsDataURL(file);

                // ä¸Šä¼ åˆ°æœåŠ¡å™¨
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${API_BASE}/upload/image`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    currentImageUrl = result.data;
                    console.log('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ:', currentImageUrl);
                } else {
                    alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                    // æ¸…é™¤é¢„è§ˆ
                    safeSetStyle('image-preview', 'display', 'none');
                    safeSetStyle('image-remove', 'display', 'none');
                    currentImageUrl = null;
                }
            } catch (error) {
                console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
                alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                // æ¸…é™¤é¢„è§ˆ
                safeSetStyle('image-preview', 'display', 'none');
                safeSetStyle('image-remove', 'display', 'none');
                currentImageUrl = null;
            }
        });

        // ç§»é™¤å›¾ç‰‡
        safeAddEventListener('image-remove', 'click', function() {
            safeSetStyle('image-preview', 'display', 'none');
            safeSetStyle('image-remove', 'display', 'none');
            const imageInput = safeGetElement('image-input');
            if (imageInput) imageInput.value = '';
            currentImageUrl = null;
        });

        let currentItem = null; // å½“å‰æŸ¥çœ‹çš„ç‰©å“
        let editImageUrl = null; // ç¼–è¾‘æ—¶çš„å›¾ç‰‡URL

        // æ˜¾ç¤ºç‰©å“è¯¦æƒ…
        async function showItemDetail(itemId) {
            try {
                const response = await fetch(`${API_BASE}/item/${itemId}?userId=${currentUser.userId}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    currentItem = result.data;
                    displayItemDetail(currentItem);
                    safeSetStyle('item-detail-modal', 'display', 'block');
                } else {
                    alert('è·å–ç‰©å“è¯¦æƒ…å¤±è´¥');
                }
            } catch (error) {
                console.error('è·å–ç‰©å“è¯¦æƒ…å¤±è´¥:', error);
                alert('è·å–ç‰©å“è¯¦æƒ…å¤±è´¥');
            }
        }

        // æ˜¾ç¤ºç‰©å“è¯¦æƒ…å†…å®¹
        function displayItemDetail(item) {
            safeSetTextContent('detail-name', item.name || '');
            safeSetTextContent('detail-category', item.category || '');
            safeSetTextContent('detail-location', item.location || '');
            safeSetTextContent('detail-description', item.description || 'æ— ');
            safeSetTextContent('detail-time', new Date(item.lastUpdateTime).toLocaleString());
            
            const detailImage = safeGetElement('detail-image');
            if (detailImage) {
                if (item.imageUrl) {
                    detailImage.src = item.imageUrl;
                    detailImage.style.display = 'block';
                } else {
                    detailImage.style.display = 'none';
                }
            }
            
            // æ˜¾ç¤ºè¯¦æƒ…ï¼Œéšè—ç¼–è¾‘è¡¨å•
            safeSetStyle('item-detail-content', 'display', 'block');
            safeSetStyle('item-edit-form', 'display', 'none');
        }

        // å…³é—­ç‰©å“è¯¦æƒ…æ¨¡æ€æ¡†
        function closeItemDetailModal() {
            safeSetStyle('item-detail-modal', 'display', 'none');
            currentItem = null;
        }

        // ç¼–è¾‘ç‰©å“
        async function editItem() {
            if (!currentItem) return;
            
            // å¡«å……ç¼–è¾‘è¡¨å•
            safeSetValue('edit-name', currentItem.name || '');
            safeSetValue('edit-description', currentItem.description || '');
            
            // åŠ è½½åˆ†ç±»å’Œä½ç½®é€‰é¡¹
            await loadEditOptions();
            
            // è®¾ç½®å½“å‰é€‰ä¸­çš„åˆ†ç±»å’Œä½ç½®
            safeSetValue('edit-category', currentItem.categoryId || '');
            safeSetValue('edit-location', currentItem.locationId || '');
            
            // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
            editImageUrl = currentItem.imageUrl;
            const editPreview = safeGetElement('edit-image-preview');
            const editRemoveBtn = safeGetElement('edit-image-remove');
            if (currentItem.imageUrl && editPreview) {
                editPreview.src = currentItem.imageUrl;
                editPreview.style.display = 'block';
                if (editRemoveBtn) editRemoveBtn.style.display = 'inline-block';
            } else {
                if (editPreview) editPreview.style.display = 'none';
                if (editRemoveBtn) editRemoveBtn.style.display = 'none';
            }
            
            // åˆ‡æ¢æ˜¾ç¤º
            safeSetStyle('item-detail-content', 'display', 'none');
            safeSetStyle('item-edit-form', 'display', 'block');
        }

        // å–æ¶ˆç¼–è¾‘
        function cancelEdit() {
            safeSetStyle('item-detail-content', 'display', 'block');
            safeSetStyle('item-edit-form', 'display', 'none');
            editImageUrl = null;
        }

        // åŠ è½½ç¼–è¾‘è¡¨å•çš„é€‰é¡¹
        async function loadEditOptions() {
            try {
                // åŠ è½½åˆ†ç±»
                const categoryResponse = await fetch(`${API_BASE}/category/list?userId=${currentUser.userId}`);
                const categoryResult = await categoryResponse.json();
                const categories = categoryResult.data && Array.isArray(categoryResult.data) ? categoryResult.data : [];
                
                const editCategorySelect = document.getElementById('edit-category');
                editCategorySelect.innerHTML = '<option value="">è¯·é€‰æ‹©åˆ†ç±»</option>' + 
                    categories.map(cat => `<option value="${cat.categoryId}">${cat.name}${cat.isSystem ? ' (ç³»ç»Ÿ)' : ''}</option>`).join('');
                
                // åŠ è½½ä½ç½®
                const locationResponse = await fetch(`${API_BASE}/location/list?userId=${currentUser.userId}`);
                const locationResult = await locationResponse.json();
                const locations = locationResult.data && Array.isArray(locationResult.data) ? locationResult.data : [];
                
                const editLocationSelect = document.getElementById('edit-location');
                editLocationSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ä½ç½®</option>' + 
                    locations.map(loc => `<option value="${loc.locationId}">${loc.icon} ${loc.name}</option>`).join('');
            } catch (error) {
                console.error('åŠ è½½ç¼–è¾‘é€‰é¡¹å¤±è´¥:', error);
            }
        }

        // ç¼–è¾‘æ—¶çš„å›¾ç‰‡ä¸Šä¼ å¤„ç†
        document.getElementById('edit-image-input').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }

            // éªŒè¯æ–‡ä»¶å¤§å° (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('å›¾ç‰‡æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB');
                return;
            }

            try {
                // æ˜¾ç¤ºé¢„è§ˆ
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('edit-image-preview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    document.getElementById('edit-image-remove').style.display = 'inline-block';
                };
                reader.readAsDataURL(file);

                // ä¸Šä¼ åˆ°æœåŠ¡å™¨
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${API_BASE}/upload/image`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    editImageUrl = result.data;
                    console.log('ç¼–è¾‘å›¾ç‰‡ä¸Šä¼ æˆåŠŸ:', editImageUrl);
                } else {
                    alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                    // æ¸…é™¤é¢„è§ˆ
                    document.getElementById('edit-image-preview').style.display = 'none';
                    document.getElementById('edit-image-remove').style.display = 'none';
                    editImageUrl = currentItem.imageUrl; // æ¢å¤åŸå›¾ç‰‡
                }
            } catch (error) {
                console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
                alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                // æ¸…é™¤é¢„è§ˆ
                document.getElementById('edit-image-preview').style.display = 'none';
                document.getElementById('edit-image-remove').style.display = 'none';
                editImageUrl = currentItem.imageUrl; // æ¢å¤åŸå›¾ç‰‡
            }
        });

        // ç¼–è¾‘æ—¶ç§»é™¤å›¾ç‰‡
        document.getElementById('edit-image-remove').addEventListener('click', function() {
            document.getElementById('edit-image-preview').style.display = 'none';
            document.getElementById('edit-image-remove').style.display = 'none';
            document.getElementById('edit-image-input').value = '';
            editImageUrl = null;
        });

        // ä¿å­˜ç¼–è¾‘
        document.getElementById('edit-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentItem) return;
            
            const formData = {
                name: safeGetValue('edit-name'),
                categoryId: parseInt(safeGetValue('edit-category')),
                locationId: parseInt(safeGetValue('edit-location')),
                description: safeGetValue('edit-description'),
                imageUrl: editImageUrl
            };
            
            // éªŒè¯è¡¨å•
            if (!formData.name.trim()) {
                alert('è¯·è¾“å…¥ç‰©å“åç§°');
                return;
            }
            if (!formData.categoryId) {
                alert('è¯·é€‰æ‹©åˆ†ç±»');
                return;
            }
            if (!formData.locationId) {
                alert('è¯·é€‰æ‹©ä½ç½®');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/item/${currentItem.itemId}?userId=${currentUser.userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('æ›´æ–°æˆåŠŸï¼');
                    // é‡æ–°è·å–ç‰©å“è¯¦æƒ…å¹¶æ˜¾ç¤º
                    await showItemDetail(currentItem.itemId);
                    // åˆ·æ–°ç‰©å“åˆ—è¡¨
                    loadItems();
                } else {
                    alert('æ›´æ–°å¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('æ›´æ–°ç‰©å“å¤±è´¥:', error);
                alert('æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        });

        // QRç æ˜¾ç¤º
        async function showItemQR() {
            if (!currentItem) return;
            
            try {
                // ç”Ÿæˆç‰©å“ä¿¡æ¯URL (å¯ä»¥æ˜¯ä¸€ä¸ªæŸ¥çœ‹ç‰©å“è¯¦æƒ…çš„URL)
                const itemUrl = `${window.location.origin}${window.location.pathname}?item=${currentItem.itemId}`;
                
                // æ˜¾ç¤ºç‰©å“ä¿¡æ¯
                document.getElementById('qr-item-name').textContent = currentItem.name;
                document.getElementById('qr-item-desc').textContent = `${currentItem.category} Â· ${currentItem.location}`;
                
                // ç”ŸæˆQRç 
                const canvas = document.getElementById('qr-canvas');
                await QRCode.toCanvas(canvas, itemUrl, {
                    width: 200,
                    height: 200,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    },
                    errorCorrectionLevel: 'M',
                    margin: 2
                });
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                document.getElementById('qr-modal').style.display = 'block';
                
            } catch (error) {
                console.error('ç”ŸæˆäºŒç»´ç å¤±è´¥:', error);
                alert('ç”ŸæˆäºŒç»´ç å¤±è´¥');
            }
        }

        // å…³é—­QRç æ¨¡æ€æ¡†
        function closeQRModal() {
            document.getElementById('qr-modal').style.display = 'none';
        }

        // ä¸‹è½½QRç 
        function downloadQR() {
            const canvas = document.getElementById('qr-canvas');
            const link = document.createElement('a');
            link.download = `${currentItem.name}_QRç .png`;
            link.href = canvas.toDataURL();
            link.click();
        }

        // æ‰“å°QRç 
        function printQR() {
            const canvas = document.getElementById('qr-canvas');
            const printWindow = window.open('', '_blank');
            const itemName = currentItem.name;
            const itemDesc = `${currentItem.category} Â· ${currentItem.location}`;
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>æ‰“å°ç‰©å“æ ‡ç­¾ - ${itemName}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            text-align: center;
                            padding: 20px;
                        }
                        .label {
                            display: inline-block;
                            border: 2px solid #000;
                            padding: 15px;
                            border-radius: 8px;
                            max-width: 300px;
                        }
                        .item-name {
                            font-size: 16px;
                            font-weight: bold;
                            margin-bottom: 8px;
                        }
                        .item-desc {
                            font-size: 12px;
                            color: #666;
                            margin-bottom: 10px;
                        }
                        .qr-code {
                            margin: 10px 0;
                        }
                        .footer {
                            font-size: 10px;
                            color: #999;
                            margin-top: 8px;
                        }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="label">
                        <div class="item-name">${itemName}</div>
                        <div class="item-desc">${itemDesc}</div>
                        <div class="qr-code">
                            <img src="${canvas.toDataURL()}" alt="QR Code" style="width: 120px; height: 120px;">
                        </div>
                        <div class="footer">å¯»ç‰©åŠ©æ‰‹ Â· æ‰«ç æŸ¥çœ‹è¯¦æƒ…</div>
                    </div>
                    <div class="no-print" style="margin-top: 20px;">
                        <button onclick="window.print()">æ‰“å°</button>
                        <button onclick="window.close()">å…³é—­</button>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
        }

        // æ ‡ç­¾é¡µåˆ‡æ¢ - ä¿®å¤ç‰ˆæœ¬
        function showTab(tab) {
            // éšè—æ‰€æœ‰å†…å®¹é¡µé¢
            document.querySelectorAll('.content').forEach(page => {
                page.style.display = 'none';
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            // æ˜¾ç¤ºé€‰ä¸­çš„é¡µé¢
            const targetPage = document.getElementById(tab + '-page');
            if (targetPage) {
                targetPage.style.display = 'block';
            }
            
            // æ¿€æ´»å¯¹åº”çš„æ ‡ç­¾ - é€šè¿‡onclickå±æ€§åŒ¹é…
            document.querySelectorAll('.tab').forEach(tabElement => {
                const onclick = tabElement.getAttribute('onclick');
                if (onclick && onclick.includes(`'${tab}'`)) {
                    tabElement.classList.add('active');
                }
            });
            
            // åŠ è½½å¯¹åº”æ•°æ®
            switch(tab) {
                case 'items':
                    loadItems();
                    break;
                case 'categories':
                    loadCategoriesForManagement();
                    break;
                case 'locations':
                    loadLocations();
                    break;
                case 'statistics':
                    loadEnhancedStatistics();
                    break;
                case 'add':
                    loadCategories();
                    loadLocationOptions();
                    break;
            }
        }

        // ç»Ÿè®¡ç›¸å…³å˜é‡
        let categoryChart = null;
        let locationChart = null;
        let trendChart = null;

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStatistics() {
            try {
                console.log('å¼€å§‹åŠ è½½ç»Ÿè®¡æ•°æ®...');
                
                // å¹¶è¡Œè·å–æ‰€æœ‰æ•°æ®
                const [itemsResponse, categoriesResponse, locationsResponse] = await Promise.all([
                    fetch(`${API_BASE}/item/list?userId=${currentUser.userId}&keyword=`),
                    fetch(`${API_BASE}/category/list?userId=${currentUser.userId}`),
                    fetch(`${API_BASE}/location/list?userId=${currentUser.userId}`)
                ]);

                const itemsResult = await itemsResponse.json();
                const categoriesResult = await categoriesResponse.json();
                const locationsResult = await locationsResponse.json();
                
                console.log('APIå“åº”æ•°æ®:', { itemsResult, categoriesResult, locationsResult });

                const items = itemsResult.data && itemsResult.data.items ? itemsResult.data.items : [];
                const categories = categoriesResult.data && Array.isArray(categoriesResult.data) ? categoriesResult.data : [];
                const locations = locationsResult.data && Array.isArray(locationsResult.data) ? locationsResult.data : [];

                console.log('å¤„ç†åçš„æ•°æ®:', { items: items.length, categories: categories.length, locations: locations.length });

                // æ›´æ–°æ¦‚è§ˆå¡ç‰‡
                document.getElementById('total-items').textContent = items.length;
                document.getElementById('total-categories').textContent = categories.length;
                document.getElementById('total-locations').textContent = locations.length;

                // æ£€æŸ¥Chart.jsæ˜¯å¦åŠ è½½
                if (typeof Chart === 'undefined') {
                    console.error('Chart.jsæœªåŠ è½½');
                    // æ˜¾ç¤ºé”™è¯¯æç¤º
                    document.querySelectorAll('.chart-section').forEach(section => {
                        const canvas = section.querySelector('canvas');
                        if (canvas) {
                            const ctx = canvas.getContext('2d');
                            ctx.font = '14px Arial';
                            ctx.fillStyle = '#ff0000';
                            ctx.textAlign = 'center';
                            ctx.fillText('å›¾è¡¨åº“åŠ è½½å¤±è´¥', canvas.width / 2, canvas.height / 2);
                        }
                    });
                    return;
                }

                // ç”Ÿæˆå›¾è¡¨
                console.log('å¼€å§‹ç”Ÿæˆå›¾è¡¨...');
                generateCategoryChart(items, categories);
                generateLocationChart(items, locations);
                generateTrendChart(items);
                console.log('å›¾è¡¨ç”Ÿæˆå®Œæˆ');

            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                document.getElementById('total-items').textContent = 'é”™è¯¯';
                document.getElementById('total-categories').textContent = 'é”™è¯¯';
                document.getElementById('total-locations').textContent = 'é”™è¯¯';
                
                // åœ¨å›¾è¡¨åŒºåŸŸæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                document.querySelectorAll('.chart-section canvas').forEach(canvas => {
                    const ctx = canvas.getContext('2d');
                    ctx.font = '14px Arial';
                    ctx.fillStyle = '#ff0000';
                    ctx.textAlign = 'center';
                    ctx.fillText('åŠ è½½å¤±è´¥', canvas.width / 2, canvas.height / 2);
                    ctx.fillText(error.message, canvas.width / 2, canvas.height / 2 + 20);
                });
            }
        }

        // ç”Ÿæˆåˆ†ç±»ç»Ÿè®¡å›¾è¡¨
        function generateCategoryChart(items, categories) {
            const ctx = document.getElementById('category-chart').getContext('2d');
            
            // é”€æ¯å·²å­˜åœ¨çš„å›¾è¡¨
            if (categoryChart) {
                categoryChart.destroy();
            }

            // ç»Ÿè®¡æ¯ä¸ªåˆ†ç±»çš„ç‰©å“æ•°é‡
            const categoryStats = {};
            categories.forEach(cat => {
                categoryStats[cat.name] = 0;
            });

            items.forEach(item => {
                if (categoryStats.hasOwnProperty(item.category)) {
                    categoryStats[item.category]++;
                }
            });

            const labels = Object.keys(categoryStats);
            const data = Object.values(categoryStats);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
            if (labels.length === 0 || data.every(value => value === 0)) {
                // æ²¡æœ‰æ•°æ®æ—¶æ˜¾ç¤ºæç¤º
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '14px Arial';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('æš‚æ— æ•°æ®', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            const colors = generateColors(labels.length);

            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1.5,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value}ä¸ª (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ç”Ÿæˆä½ç½®ç»Ÿè®¡å›¾è¡¨
        function generateLocationChart(items, locations) {
            const ctx = document.getElementById('location-chart').getContext('2d');
            
            // é”€æ¯å·²å­˜åœ¨çš„å›¾è¡¨
            if (locationChart) {
                locationChart.destroy();
            }

            // ç»Ÿè®¡æ¯ä¸ªä½ç½®çš„ç‰©å“æ•°é‡
            const locationStats = {};
            locations.forEach(loc => {
                locationStats[loc.name] = 0;
            });

            items.forEach(item => {
                if (locationStats.hasOwnProperty(item.location)) {
                    locationStats[item.location]++;
                }
            });

            const labels = Object.keys(locationStats);
            const data = Object.values(locationStats);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
            if (labels.length === 0 || data.every(value => value === 0)) {
                // æ²¡æœ‰æ•°æ®æ—¶æ˜¾ç¤ºæç¤º
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '14px Arial';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('æš‚æ— æ•°æ®', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            locationChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ç‰©å“æ•°é‡',
                        data: data,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed.y}ä¸ªç‰©å“`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ç”Ÿæˆè¶‹åŠ¿å›¾è¡¨
        function generateTrendChart(items) {
            const ctx = document.getElementById('trend-chart').getContext('2d');
            
            // é”€æ¯å·²å­˜åœ¨çš„å›¾è¡¨
            if (trendChart) {
                trendChart.destroy();
            }

            // æŒ‰æ—¥æœŸç»Ÿè®¡ç‰©å“æ·»åŠ æ•°é‡ï¼ˆæœ€è¿‘7å¤©ï¼‰
            const today = new Date();
            const trendData = {};
            const labels = [];

            // åˆå§‹åŒ–æœ€è¿‘7å¤©çš„æ•°æ®
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
                labels.push(dateStr);
                trendData[dateStr] = 0;
            }

            // ç»Ÿè®¡æ¯å¤©æ·»åŠ çš„ç‰©å“æ•°é‡
            items.forEach(item => {
                const itemDate = new Date(item.createTime || item.lastUpdateTime);
                const dateStr = itemDate.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
                if (trendData.hasOwnProperty(dateStr)) {
                    trendData[dateStr]++;
                }
            });

            const data = labels.map(label => trendData[label]);
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
            if (data.every(value => value === 0)) {
                // æ²¡æœ‰æ•°æ®æ—¶æ˜¾ç¤ºæç¤º
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '14px Arial';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('æš‚æ— æ•°æ®', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æ–°å¢ç‰©å“',
                        data: data,
                        borderColor: 'rgba(118, 75, 162, 1)',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: 'rgba(118, 75, 162, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: æ–°å¢${context.parsed.y}ä¸ªç‰©å“`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ç”Ÿæˆé¢œè‰²æ•°ç»„
        function generateColors(count) {
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
            ];
            const result = [];
            for (let i = 0; i < count; i++) {
                result.push(colors[i % colors.length]);
            }
            return result;
        }

        // PWA ç›¸å…³åŠŸèƒ½
        let deferredPrompt;
        let isInstalled = false;

        // æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
        window.addEventListener('appinstalled', () => {
            console.log('PWA å·²å®‰è£…');
            isInstalled = true;
            hidePWAPrompt();
        });

        // ç›‘å¬å®‰è£…æç¤ºäº‹ä»¶
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('PWA å®‰è£…æç¤º');
            e.preventDefault();
            deferredPrompt = e;
            showPWAPrompt();
        });

        // æ˜¾ç¤ºå®‰è£…æç¤º
        function showPWAPrompt() {
            if (isInstalled || !deferredPrompt) return;
            
            // åˆ›å»ºå®‰è£…æç¤ºå…ƒç´ 
            const installPrompt = document.createElement('div');
            installPrompt.id = 'pwa-install-prompt';
            installPrompt.innerHTML = `
                <div style="position: fixed; bottom: 20px; left: 20px; right: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1001; display: flex; align-items: center; justify-content: space-between;">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; margin-bottom: 5px;">ğŸ“± å®‰è£…å¯»ç‰©åŠ©æ‰‹</div>
                        <div style="font-size: 14px; opacity: 0.9;">å°†åº”ç”¨å®‰è£…åˆ°æ‰‹æœºæ¡Œé¢ï¼Œä½¿ç”¨æ›´ä¾¿æ·</div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-left: 15px;">
                        <button onclick="installPWA()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">å®‰è£…</button>
                        <button onclick="hidePWAPrompt()" style="background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">ç¨å</button>
                    </div>
                </div>
            `;
            document.body.appendChild(installPrompt);
        }

        // éšè—å®‰è£…æç¤º
        function hidePWAPrompt() {
            const prompt = document.getElementById('pwa-install-prompt');
            if (prompt) {
                prompt.remove();
            }
        }

        // å®‰è£… PWA
        async function installPWA() {
            if (!deferredPrompt) return;
            
            try {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    console.log('ç”¨æˆ·æ¥å—å®‰è£…');
                    isInstalled = true;
                } else {
                    console.log('ç”¨æˆ·æ‹’ç»å®‰è£…');
                }
                
                deferredPrompt = null;
                hidePWAPrompt();
            } catch (error) {
                console.error('å®‰è£…å¤±è´¥:', error);
                hidePWAPrompt();
            }
        }

        // æ³¨å†Œ Service Worker
        if ('serviceWorker' in navigator && (location.protocol === 'http:' || location.protocol === 'https:')) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js');
                    console.log('Service Worker æ³¨å†ŒæˆåŠŸ:', registration.scope);
                    
                    // ç›‘å¬æ›´æ–°
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showUpdatePrompt();
                            }
                        });
                    });
                } catch (error) {
                    console.log('Service Worker æ³¨å†Œå¤±è´¥:', error);
                }
            });
        } else if (location.protocol === 'file:') {
            console.log('æ£€æµ‹åˆ°æœ¬åœ°æ–‡ä»¶è®¿é—®ï¼ŒService WorkeråŠŸèƒ½å·²ç¦ç”¨ã€‚è¯·é€šè¿‡HTTPæœåŠ¡å™¨è®¿é—®ä»¥å¯ç”¨å®Œæ•´åŠŸèƒ½ã€‚');
        }

        // æ˜¾ç¤ºæ›´æ–°æç¤º
        function showUpdatePrompt() {
            const updatePrompt = document.createElement('div');
            updatePrompt.innerHTML = `
                <div style="position: fixed; top: 20px; left: 20px; right: 20px; background: #28a745; color: white; padding: 12px; border-radius: 8px; z-index: 1001; text-align: center;">
                    <div style="margin-bottom: 8px;">ğŸ‰ åº”ç”¨å·²æ›´æ–°ï¼</div>
                    <button onclick="location.reload()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 10px;">ç«‹å³åˆ·æ–°</button>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer;">ç¨å</button>
                </div>
            `;
            document.body.appendChild(updatePrompt);
        }

        // ç¦»çº¿çŠ¶æ€æ£€æµ‹
        window.addEventListener('online', () => {
            console.log('ç½‘ç»œå·²è¿æ¥');
            showNetworkStatus('âœ… ç½‘ç»œå·²è¿æ¥', '#28a745');
        });

        window.addEventListener('offline', () => {
            console.log('ç½‘ç»œå·²æ–­å¼€');
            showNetworkStatus('âš ï¸ ç¦»çº¿æ¨¡å¼', '#ffc107');
        });

        // æ˜¾ç¤ºç½‘ç»œçŠ¶æ€
        function showNetworkStatus(message, color) {
            const statusEl = document.createElement('div');
            statusEl.innerHTML = `
                <div style="position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: ${color}; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; z-index: 1002; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                    ${message}
                </div>
            `;
            document.body.appendChild(statusEl);
            
            setTimeout(() => {
                statusEl.remove();
            }, 3000);
        }

        // ç‰©å“å†å²è®°å½•åŠŸèƒ½
        let historyVisible = false;

        // åˆ‡æ¢å†å²è®°å½•æ˜¾ç¤º
        function toggleItemHistory() {
            const historyDiv = document.getElementById('item-history');
            const toggleBtn = document.getElementById('history-toggle');
            
            if (historyVisible) {
                historyDiv.style.display = 'none';
                toggleBtn.textContent = 'å†å²è®°å½•';
                historyVisible = false;
            } else {
                historyDiv.style.display = 'block';
                toggleBtn.textContent = 'æ”¶èµ·å†å²';
                historyVisible = true;
                loadItemHistory();
            }
        }

        // åŠ è½½ç‰©å“å†å²è®°å½•
        async function loadItemHistory() {
            if (!currentItem) return;
            
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '<div class="loading-history" style="text-align: center; padding: 20px; color: #666;">æ­£åœ¨åŠ è½½å†å²è®°å½•...</div>';
            
            try {
                // å°è¯•ä»APIè·å–å†å²è®°å½•
                const response = await fetch(`${API_BASE}/item/${currentItem.itemId}/history?userId=${currentUser.userId}`);
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    displayItemHistory(result.data);
                } else {
                    // å¦‚æœæ²¡æœ‰APIæˆ–æ²¡æœ‰å†å²è®°å½•ï¼Œç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
                    const mockHistory = generateMockHistory(currentItem);
                    displayItemHistory(mockHistory);
                }
            } catch (error) {
                console.log('æ— æ³•è·å–å†å²è®°å½•APIï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
                // APIä¸å­˜åœ¨æ—¶ï¼Œç”ŸæˆåŸºäºå½“å‰ç‰©å“çš„æ¨¡æ‹Ÿå†å²
                const mockHistory = generateMockHistory(currentItem);
                displayItemHistory(mockHistory);
            }
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿå†å²è®°å½•ï¼ˆå½“åç«¯APIä¸å¯ç”¨æ—¶ï¼‰
        function generateMockHistory(item) {
            const history = [];
            const now = new Date();
            
            // åˆ›å»ºè®°å½•
            const createTime = new Date(item.lastUpdateTime);
            history.push({
                id: 1,
                action: 'åˆ›å»ºç‰©å“',
                actionType: 'create',
                timestamp: createTime,
                changes: [
                    { field: 'ç‰©å“åç§°', newValue: item.name },
                    { field: 'åˆ†ç±»', newValue: item.category },
                    { field: 'ä½ç½®', newValue: item.location },
                    { field: 'æè¿°', newValue: item.description || 'æ— ' }
                ],
                operator: 'ç”¨æˆ·'
            });
            
            // å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ·»åŠ å›¾ç‰‡ä¸Šä¼ è®°å½•
            if (item.imageUrl) {
                const imageTime = new Date(createTime.getTime() + 1000 * 60 * 2); // 2åˆ†é’Ÿå
                history.push({
                    id: 2,
                    action: 'ä¸Šä¼ å›¾ç‰‡',
                    actionType: 'update',
                    timestamp: imageTime,
                    changes: [
                        { field: 'ç‰©å“å›¾ç‰‡', oldValue: 'æ— ', newValue: 'å·²ä¸Šä¼ ' }
                    ],
                    operator: 'ç”¨æˆ·'
                });
            }
            
            // æ¨¡æ‹Ÿä¸€äº›æ›´æ–°è®°å½•
            const updateTime = new Date(createTime.getTime() + 1000 * 60 * 60 * 24 * 3); // 3å¤©å
            if (updateTime < now) {
                history.push({
                    id: 3,
                    action: 'æ›´æ–°ä¿¡æ¯',
                    actionType: 'update',
                    timestamp: updateTime,
                    changes: [
                        { field: 'æè¿°', oldValue: item.description || 'æ— ', newValue: item.description || 'å·²æ›´æ–°æè¿°' }
                    ],
                    operator: 'ç”¨æˆ·'
                });
            }
            
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—
            return history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }

        // æ˜¾ç¤ºå†å²è®°å½•
        function displayItemHistory(historyData) {
            const historyList = document.getElementById('history-list');
            
            if (!historyData || historyData.length === 0) {
                historyList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">æš‚æ— å†å²è®°å½•</div>';
                return;
            }
            
            const historyHtml = historyData.map(record => {
                const time = new Date(record.timestamp).toLocaleString('zh-CN');
                const actionIcon = getActionIcon(record.actionType);
                const changesHtml = record.changes.map(change => {
                    if (change.oldValue && change.newValue) {
                        return `<div class="history-change">
                            <strong>${change.field}:</strong> 
                            <span class="history-old">${change.oldValue}</span> â†’ 
                            <span class="history-new">${change.newValue}</span>
                        </div>`;
                    } else if (change.newValue) {
                        return `<div class="history-change">
                            <strong>${change.field}:</strong> 
                            <span class="history-new">${change.newValue}</span>
                        </div>`;
                    } else {
                        return `<div class="history-change">
                            <strong>${change.field}:</strong> ${change.description || 'å·²åˆ é™¤'}
                        </div>`;
                    }
                }).join('');
                
                return `
                    <div class="history-item ${record.actionType}">
                        <div class="history-action">${actionIcon} ${record.action}</div>
                        <div class="history-time">ğŸ“… ${time} Â· ${record.operator || 'ç³»ç»Ÿ'}</div>
                        <div class="history-changes">${changesHtml}</div>
                    </div>
                `;
            }).join('');
            
            historyList.innerHTML = historyHtml;
        }

        // è·å–æ“ä½œå›¾æ ‡
        function getActionIcon(actionType) {
            switch (actionType) {
                case 'create': return 'âœ¨';
                case 'update': return 'ğŸ“';
                case 'delete': return 'ğŸ—‘ï¸';
                case 'move': return 'ğŸ“¦';
                case 'restore': return 'ğŸ”„';
                default: return 'ğŸ“‹';
            }
        }

        // è®°å½•ç‰©å“æ“ä½œå†å²ï¼ˆç”¨äºå°†æ¥ä¸åç«¯é›†æˆï¼‰
        function recordItemHistory(itemId, action, actionType, changes) {
            const historyRecord = {
                itemId: itemId,
                action: action,
                actionType: actionType,
                changes: changes,
                timestamp: new Date().toISOString(),
                operator: 'ç”¨æˆ·',
                userId: currentUser.userId
            };
            
            // è¿™é‡Œå°†æ¥å¯ä»¥å‘é€åˆ°åç«¯APIä¿å­˜
            console.log('è®°å½•å†å²:', historyRecord);
            
            // æš‚æ—¶å­˜å‚¨åˆ°æœ¬åœ°å­˜å‚¨
            const localHistory = JSON.parse(localStorage.getItem('itemHistory') || '{}');
            if (!localHistory[itemId]) {
                localHistory[itemId] = [];
            }
            localHistory[itemId].unshift(historyRecord);
            
            // é™åˆ¶æ¯ä¸ªç‰©å“æœ€å¤šä¿å­˜50æ¡å†å²è®°å½•
            if (localHistory[itemId].length > 50) {
                localHistory[itemId] = localHistory[itemId].slice(0, 50);
            }
            
            localStorage.setItem('itemHistory', JSON.stringify(localHistory));
        }

        // ä¿®æ”¹ç°æœ‰çš„ç¼–è¾‘ä¿å­˜å‡½æ•°ä»¥è®°å½•å†å²
        const originalEditFormSubmit = document.getElementById('edit-form');
        if (originalEditFormSubmit) {
            // åœ¨ä¿å­˜ç¼–è¾‘æ—¶è®°å½•å˜æ›´å†å²
            originalEditFormSubmit.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!currentItem) return;
                
                const newName = document.getElementById('edit-name').value;
                const newCategoryId = parseInt(document.getElementById('edit-category').value);
                const newLocationId = parseInt(document.getElementById('edit-location').value);
                const newDescription = document.getElementById('edit-description').value;
                
                // æ£€æµ‹å˜æ›´
                const changes = [];
                if (newName !== currentItem.name) {
                    changes.push({ field: 'ç‰©å“åç§°', oldValue: currentItem.name, newValue: newName });
                }
                
                const categorySelect = document.getElementById('edit-category');
                const newCategoryName = categorySelect.options[categorySelect.selectedIndex].text.replace(' (ç³»ç»Ÿ)', '');
                if (newCategoryName !== currentItem.category) {
                    changes.push({ field: 'åˆ†ç±»', oldValue: currentItem.category, newValue: newCategoryName });
                }
                
                const locationSelect = document.getElementById('edit-location');
                const newLocationName = locationSelect.options[locationSelect.selectedIndex].text.replace(/^[^\s]+ /, '');
                if (newLocationName !== currentItem.location) {
                    changes.push({ field: 'ä½ç½®', oldValue: currentItem.location, newValue: newLocationName });
                }
                
                if (newDescription !== (currentItem.description || '')) {
                    changes.push({ field: 'æè¿°', oldValue: currentItem.description || 'æ— ', newValue: newDescription || 'æ— ' });
                }
                
                if (editImageUrl !== currentItem.imageUrl) {
                    const oldImg = currentItem.imageUrl ? 'å·²è®¾ç½®' : 'æ— ';
                    const newImg = editImageUrl ? 'å·²æ›´æ–°' : 'æ— ';
                    changes.push({ field: 'ç‰©å“å›¾ç‰‡', oldValue: oldImg, newValue: newImg });
                }
                
                // å¦‚æœæœ‰å˜æ›´ï¼Œè®°å½•å†å²
                if (changes.length > 0) {
                    recordItemHistory(currentItem.itemId, 'æ›´æ–°ä¿¡æ¯', 'update', changes);
                }
                
                // ç»§ç»­åŸæœ‰çš„ä¿å­˜é€»è¾‘...
                // ï¼ˆè¿™é‡Œçœç•¥åŸæœ‰çš„ä¿å­˜ä»£ç ï¼Œå› ä¸ºå·²ç»å­˜åœ¨ï¼‰
            });
        }

        // åˆå§‹åŒ–é¡µé¢
        function initializePage() {
            // åˆå§‹åŒ–ç§»åŠ¨ç«¯æ‰‹åŠ¿
            initMobileGestures();
            
            // æ£€æŸ¥URLå‚æ•°ï¼Œå¦‚æœæœ‰itemå‚æ•°åˆ™ç›´æ¥æ˜¾ç¤ºç‰©å“è¯¦æƒ…
            const urlParams = new URLSearchParams(window.location.search);
            const itemId = urlParams.get('item');
            
            if (itemId) {
                // é€šè¿‡äºŒç»´ç è®¿é—®ï¼Œç›´æ¥æ˜¾ç¤ºç‰©å“è¯¦æƒ…
                showItemDetail(parseInt(itemId));
            } else {
                // æ­£å¸¸è®¿é—®ï¼Œæ˜¾ç¤ºç‰©å“åˆ—è¡¨
                showTab('items');
            }
        }

        // åŠ è½½åˆ†ç±»ç®¡ç†é¡µé¢çš„åˆ†ç±»åˆ—è¡¨
        async function loadCategoriesForManagement() {
            try {
                const response = await fetch(`${API_BASE}/category/list?userId=${currentUser.userId}`);
                const result = await response.json();
                
                const list = document.getElementById('categories-list');
                const categories = result.data && Array.isArray(result.data) ? result.data : [];
                
                if (categories.length === 0) {
                    list.innerHTML = '<div class="empty-state"><p>æš‚æ— åˆ†ç±»è®°å½•</p></div>';
                    return;
                }
                
                list.innerHTML = categories.map(category => `
                    <div class="location-item">
                        <span>${category.name}${category.isSystem ? ' (ç³»ç»Ÿ)' : ''}</span>
                        <div class="location-actions">
                            ${!category.isSystem ? `<button class="btn btn-danger" onclick="deleteCategory(${category.categoryId})" style="background: #ff6b6b; padding: 6px 12px; font-size: 12px;">åˆ é™¤</button>` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
                const list = document.getElementById('categories-list');
                list.innerHTML = '<div class="empty-state"><p>åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p></div>';
            }
        }

        // åˆ†ç±»ç®¡ç†
        function showAddCategoryModal() {
            document.getElementById('category-modal').style.display = 'block';
        }

        function closeCategoryModal() {
            document.getElementById('category-modal').style.display = 'none';
            document.getElementById('add-category-form').reset();
        }

        document.getElementById('add-category-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                userId: currentUser.userId,
                name: document.getElementById('category-name').value
            };
            
            // éªŒè¯è¡¨å•
            if (!formData.name.trim()) {
                alert('è¯·è¾“å…¥åˆ†ç±»åç§°');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/category/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('åˆ†ç±»æ·»åŠ æˆåŠŸï¼');
                    closeCategoryModal();
                    loadCategoriesForManagement();
                    loadCategories(); // åˆ·æ–°æ·»åŠ é¡µé¢çš„åˆ†ç±»é€‰é¡¹
                } else {
                    alert('æ·»åŠ å¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('æ·»åŠ åˆ†ç±»å¤±è´¥:', error);
                alert('æ·»åŠ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        });

        // åˆ é™¤åˆ†ç±»
        async function deleteCategory(categoryId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆ†ç±»å—ï¼Ÿæ³¨æ„ï¼šåˆ†ç±»ä¸‹æœ‰ç‰©å“æ—¶æ— æ³•åˆ é™¤ã€‚')) return;
            
            try {
                const response = await fetch(`${API_BASE}/category/${categoryId}?userId=${currentUser.userId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('åˆ é™¤æˆåŠŸï¼');
                    loadCategoriesForManagement();
                    loadCategories(); // åˆ·æ–°æ·»åŠ é¡µé¢çš„åˆ†ç±»é€‰é¡¹
                } else {
                    alert('åˆ é™¤å¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åˆ é™¤åˆ†ç±»å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // åŠ è½½ç‰©å“åˆ—è¡¨
        async function loadItems() {
            try {
                const keyword = safeGetValue('search-input');
                const response = await fetch(`${API_BASE}/item/list?userId=${currentUser.userId}&keyword=${keyword}`);
                const result = await response.json();
                
                const list = document.getElementById('items-list');
                
                // å®‰å…¨æ£€æŸ¥å¹¶è·å–itemsæ•°ç»„
                let items = result.data && result.data.items ? result.data.items : [];
                
                // åº”ç”¨ç­›é€‰æ¡ä»¶
                items = applyFilters(items);
                
                if (items.length === 0) {
                    list.innerHTML = '<div class="empty-state"><p>æš‚æ— ç‰©å“è®°å½•</p></div>';
                    return;
                }
                
                list.innerHTML = items.map(item => `
                    <div class="item-card" onclick="showItemDetail(${item.itemId})">
                        <div class="item-header">
                            <span class="item-name">${item.name}</span>
                            <span class="item-time">${new Date(item.lastUpdateTime).toLocaleDateString()}</span>
                        </div>
                        <div class="item-content">
                            ${item.imageUrl ? `<img src="${item.imageUrl}" alt="${item.name}" class="item-image">` : ''}
                            <div class="item-details">
                                <div class="item-info">
                                    <div>åˆ†ç±»: ${item.category}</div>
                                    <div>ä½ç½®: ${item.location}</div>
                                </div>
                                <button class="btn btn-danger" onclick="event.stopPropagation(); deleteItem(${item.itemId})" style="background: #ff6b6b; margin-top: 8px; padding: 6px 12px; font-size: 12px;">åˆ é™¤</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½ç‰©å“å¤±è´¥:', error);
                const list = document.getElementById('items-list');
                list.innerHTML = '<div class="empty-state"><p>åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p></div>';
            }
        }

        // åº”ç”¨ç­›é€‰æ¡ä»¶
        function applyFilters(items) {
            const categoryFilter = document.getElementById('filter-category').value;
            const locationFilter = document.getElementById('filter-location').value;
            const sortFilter = document.getElementById('filter-sort').value;

            // ç­›é€‰åˆ†ç±»
            if (categoryFilter) {
                items = items.filter(item => item.category === categoryFilter);
            }

            // ç­›é€‰ä½ç½®
            if (locationFilter) {
                items = items.filter(item => item.location === locationFilter);
            }

            // æ’åº
            switch (sortFilter) {
                case 'time-desc':
                    items.sort((a, b) => new Date(b.lastUpdateTime) - new Date(a.lastUpdateTime));
                    break;
                case 'time-asc':
                    items.sort((a, b) => new Date(a.lastUpdateTime) - new Date(b.lastUpdateTime));
                    break;
                case 'name-asc':
                    items.sort((a, b) => a.name.localeCompare(b.name, 'zh-CN'));
                    break;
                case 'name-desc':
                    items.sort((a, b) => b.name.localeCompare(a.name, 'zh-CN'));
                    break;
                default:
                    items.sort((a, b) => new Date(b.lastUpdateTime) - new Date(a.lastUpdateTime));
            }

            return items;
        }

        // æ™ºèƒ½æœç´¢åŠŸèƒ½
        let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
        let searchSuggestions = [];
        let isVoiceSearching = false;

        // è¯­éŸ³æœç´¢
        function startVoiceSearch() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½');
                return;
            }

            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            const voiceBtn = document.querySelector('.voice-search-btn');
            
            recognition.lang = 'zh-CN';
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onstart = function() {
                isVoiceSearching = true;
                voiceBtn.classList.add('recording');
                voiceBtn.title = 'æ­£åœ¨å½•éŸ³...';
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                safeSetValue('search-input', transcript);
                addToSearchHistory(transcript);
                loadItems();
            };

            recognition.onerror = function(event) {
                console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
                alert('è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•');
            };

            recognition.onend = function() {
                isVoiceSearching = false;
                voiceBtn.classList.remove('recording');
                voiceBtn.title = 'è¯­éŸ³æœç´¢';
            };

            recognition.start();
        }

        // æ‰«ç æœç´¢
        function startCameraSearch() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´åŠŸèƒ½');
                return;
            }

            // åˆ›å»ºæ‰«ç ç•Œé¢
            const scannerModal = document.createElement('div');
            scannerModal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1002; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <div style="color: white; margin-bottom: 20px; text-align: center;">
                        <h3>æ‰«æç‰©å“äºŒç»´ç </h3>
                        <p>å°†äºŒç»´ç å¯¹å‡†æ‘„åƒå¤´</p>
                    </div>
                    <video id="camera-video" style="width: 300px; height: 300px; border: 2px solid white; border-radius: 8px;"></video>
                    <canvas id="camera-canvas" style="display: none;"></canvas>
                    <button onclick="closeCameraSearch()" style="margin-top: 20px; padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">å…³é—­</button>
                </div>
            `;
            scannerModal.id = 'camera-scanner';
            document.body.appendChild(scannerModal);

            // å¯åŠ¨æ‘„åƒå¤´
            const video = document.getElementById('camera-video');
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    video.srcObject = stream;
                    video.play();
                    
                    // ç®€å•çš„æ‰«ç æ¨¡æ‹Ÿï¼ˆå®é™…é¡¹ç›®ä¸­éœ€è¦ä½¿ç”¨ä¸“ä¸šçš„QRç åº“ï¼‰
                    setTimeout(() => {
                        alert('æ‰«ç åŠŸèƒ½éœ€è¦é›†æˆä¸“ä¸šçš„QRç è¯†åˆ«åº“ï¼Œå½“å‰ä¸ºæ¼”ç¤ºæ¨¡å¼');
                        closeCameraSearch();
                    }, 3000);
                })
                .catch(err => {
                    console.error('æ‘„åƒå¤´å¯åŠ¨å¤±è´¥:', err);
                    alert('æ— æ³•å¯åŠ¨æ‘„åƒå¤´');
                    closeCameraSearch();
                });
        }

        // å…³é—­æ‰«ç ç•Œé¢
        function closeCameraSearch() {
            const scanner = document.getElementById('camera-scanner');
            if (scanner) {
                const video = document.getElementById('camera-video');
                if (video && video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                }
                scanner.remove();
            }
        }

        // æœç´¢å»ºè®®
        async function generateSearchSuggestions(keyword) {
            if (!keyword.trim()) {
                hideSearchSuggestions();
                return;
            }

            try {
                // è·å–æ‰€æœ‰æ•°æ®
                const [itemsRes, categoriesRes, locationsRes] = await Promise.all([
                    fetch(`${API_BASE}/item/list?userId=${currentUser.userId}&keyword=`),
                    fetch(`${API_BASE}/category/list?userId=${currentUser.userId}`),
                    fetch(`${API_BASE}/location/list?userId=${currentUser.userId}`)
                ]);

                const items = (await itemsRes.json()).data?.items || [];
                const categories = (await categoriesRes.json()).data || [];
                const locations = (await locationsRes.json()).data || [];

                const suggestions = [];
                const lowerKeyword = keyword.toLowerCase();

                // ç‰©å“åç§°å»ºè®®
                items.forEach(item => {
                    if (item.name.toLowerCase().includes(lowerKeyword)) {
                        suggestions.push({ text: item.name, type: 'ç‰©å“', icon: 'ğŸ“¦' });
                    }
                });

                // åˆ†ç±»å»ºè®®
                categories.forEach(cat => {
                    if (cat.name.toLowerCase().includes(lowerKeyword)) {
                        suggestions.push({ text: cat.name, type: 'åˆ†ç±»', icon: 'ğŸ·ï¸' });
                    }
                });

                // ä½ç½®å»ºè®®
                locations.forEach(loc => {
                    if (loc.name.toLowerCase().includes(lowerKeyword)) {
                        suggestions.push({ text: loc.name, type: 'ä½ç½®', icon: loc.icon || 'ğŸ“' });
                    }
                });

                // å»é‡å¹¶é™åˆ¶æ•°é‡
                const uniqueSuggestions = suggestions
                    .filter((item, index, self) => self.findIndex(i => i.text === item.text) === index)
                    .slice(0, 5);

                showSearchSuggestions(uniqueSuggestions);
            } catch (error) {
                console.error('ç”Ÿæˆæœç´¢å»ºè®®å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºæœç´¢å»ºè®®
        function showSearchSuggestions(suggestions) {
            const suggestionsDiv = document.getElementById('search-suggestions');
            
            if (suggestions.length === 0) {
                hideSearchSuggestions();
                return;
            }

            suggestionsDiv.innerHTML = suggestions.map(item => 
                `<div class="suggestion-item" onclick="selectSuggestion('${item.text}')">
                    <span>${item.icon}</span>
                    <span>${item.text}</span>
                    <span class="suggestion-type">${item.type}</span>
                </div>`
            ).join('');
            
            suggestionsDiv.style.display = 'block';
        }

        // éšè—æœç´¢å»ºè®®
        function hideSearchSuggestions() {
            safeSetStyle('search-suggestions', 'display', 'none');
        }

        // é€‰æ‹©æœç´¢å»ºè®®
        function selectSuggestion(text) {
            safeSetValue('search-input', text);
            hideSearchSuggestions();
            addToSearchHistory(text);
            loadItems();
        }

        // æ·»åŠ åˆ°æœç´¢å†å²
        function addToSearchHistory(keyword) {
            if (!keyword.trim()) return;
            
            // ç§»é™¤é‡å¤é¡¹
            searchHistory = searchHistory.filter(item => item !== keyword);
            // æ·»åŠ åˆ°å¼€å¤´
            searchHistory.unshift(keyword);
            // é™åˆ¶å†å²è®°å½•æ•°é‡
            searchHistory = searchHistory.slice(0, 10);
            
            localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
        }

        // æ˜¾ç¤ºæœç´¢å†å²
        function showSearchHistory() {
            const historyDiv = document.getElementById('search-history');
            
            if (searchHistory.length === 0) {
                historyDiv.style.display = 'none';
                return;
            }

            historyDiv.innerHTML = 
                '<div style="padding: 10px 15px; font-weight: bold; color: #666; font-size: 12px; background: #f8f9fa;">ğŸ•’ æœç´¢å†å²</div>' +
                searchHistory.map(item => 
                    `<div class="history-item" onclick="selectSuggestion('${item}')">
                        <span>ğŸ”</span>
                        <span>${item}</span>
                        <button onclick="event.stopPropagation(); removeFromHistory('${item}')" style="margin-left: auto; background: none; border: none; color: #999; cursor: pointer;">Ã—</button>
                    </div>`
                ).join('');
            
            historyDiv.style.display = 'block';
        }

        // ä»å†å²è®°å½•ä¸­ç§»é™¤
        function removeFromHistory(keyword) {
            searchHistory = searchHistory.filter(item => item !== keyword);
            localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
            showSearchHistory();
        }

        // æ™ºèƒ½æœç´¢äº‹ä»¶ç›‘å¬ - æ€§èƒ½ä¼˜åŒ–ç‰ˆ
        const searchInput = safeGetElement('search-input');
        
        if (searchInput) {
            // è¾“å…¥æ—¶æ˜¾ç¤ºå»ºè®® - ä½¿ç”¨æ›´æ™ºèƒ½çš„é˜²æŠ–
            searchInput.addEventListener('input', debounce(function(e) {
                const keyword = e.target.value;
                if (keyword.trim()) {
                    // æ‰¹é‡æ›´æ–°DOMä»¥æé«˜æ€§èƒ½
                    domBatchUpdater.addUpdate(() => {
                        generateSearchSuggestions(keyword);
                        smartAnalytics.recordSearch(keyword);
                    });
                } else {
                    hideSearchSuggestions();
                }
                loadItems();
            }, 300));
        
            // è·å¾—ç„¦ç‚¹æ—¶æ˜¾ç¤ºå†å²
            searchInput.addEventListener('focus', function() {
                if (!this.value.trim()) {
                    showSearchHistory();
                }
            });
            
            // å¤±å»ç„¦ç‚¹æ—¶éšè—å»ºè®®ï¼ˆå»¶è¿Ÿä»¥å…è®¸ç‚¹å‡»ï¼‰
            searchInput.addEventListener('blur', function() {
                setTimeout(() => {
                    hideSearchSuggestions();
                    safeSetStyle('search-history', 'display', 'none');
                }, 200);
            });
            
            // æŒ‰é”®å¤„ç†
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    const keyword = this.value.trim();
                    if (keyword) {
                        addToSearchHistory(keyword);
                        hideSearchSuggestions();
                        loadItems();
                    }
                } else if (e.key === 'Escape') {
                    hideSearchSuggestions();
                    safeSetStyle('search-history', 'display', 'none');
                }
            });
        }
        
        // é«˜çº§æœç´¢åˆ‡æ¢
        function toggleSearchFilters() {
            const filters = document.getElementById('search-filters');
            const toggle = document.getElementById('filter-toggle');
            
            if (filters.style.display === 'none') {
                filters.style.display = 'block';
                toggle.textContent = 'ğŸ”¼ æ”¶èµ·ç­›é€‰';
                loadFilterOptions();
            } else {
                filters.style.display = 'none';
                toggle.textContent = 'ğŸ” é«˜çº§æœç´¢';
            }
        }

        // æ¸…é™¤ç­›é€‰æ¡ä»¶
        function clearFilters() {
            document.getElementById('filter-category').value = '';
            document.getElementById('filter-location').value = '';
            document.getElementById('filter-sort').value = 'time-desc';
            loadItems();
        }

        // æ‰¹é‡æ“ä½œåˆ‡æ¢
        function toggleBatchOperations() {
            const operations = document.getElementById('batch-operations');
            const toggle = document.getElementById('batch-toggle');
            
            if (operations.style.display === 'none') {
                operations.style.display = 'block';
                toggle.textContent = 'ğŸ”¼ æ”¶èµ·æ“ä½œ';
            } else {
                operations.style.display = 'none';
                toggle.textContent = 'ğŸ“‹ æ‰¹é‡æ“ä½œ';
            }
        }

        // å¯¼å‡ºç‰©å“æ•°æ®
        async function exportItems() {
            try {
                const response = await fetch(`${API_BASE}/item/list?userId=${currentUser.userId}&keyword=`);
                const result = await response.json();
                
                const items = result.data && result.data.items ? result.data.items : [];
                
                if (items.length === 0) {
                    alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');
                    return;
                }

                // å‡†å¤‡å¯¼å‡ºæ•°æ®
                const exportData = items.map(item => ({
                    åç§°: item.name,
                    åˆ†ç±»: item.category,
                    ä½ç½®: item.location,
                    æè¿°: item.description || '',
                    å›¾ç‰‡é“¾æ¥: item.imageUrl || '',
                    åˆ›å»ºæ—¶é—´: new Date(item.lastUpdateTime).toLocaleString('zh-CN')
                }));

                // ç”ŸæˆCSVæ ¼å¼
                const csvContent = convertToCSV(exportData);
                
                // ä¸‹è½½æ–‡ä»¶
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `ç‰©å“æ•°æ®_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`æˆåŠŸå¯¼å‡º ${items.length} æ¡ç‰©å“è®°å½•`);
                
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // è½¬æ¢ä¸ºCSVæ ¼å¼
        function convertToCSV(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => 
                    headers.map(header => {
                        const value = row[header] || '';
                        // å¤„ç†åŒ…å«é€—å·ã€å¼•å·å’Œæ¢è¡Œç¬¦çš„å­—æ®µ
                        return `"${value.toString().replace(/"/g, '""')}"`;
                    }).join(',')
                )
            ].join('\n');
            
            return csvContent;
        }

        // æ–‡ä»¶å¯¼å…¥å¤„ç†
        document.getElementById('import-file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            if (fileExtension === 'csv') {
                importFromCSV(file);
            } else if (fileExtension === 'json') {
                importFromJSON(file);
            } else {
                alert('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè¯·é€‰æ‹©CSVæˆ–JSONæ–‡ä»¶');
                e.target.value = '';
            }
        });

        // ä»CSVå¯¼å…¥
        function importFromCSV(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        alert('CSVæ–‡ä»¶æ ¼å¼é”™è¯¯ï¼šè‡³å°‘éœ€è¦æ ‡é¢˜è¡Œå’Œä¸€è¡Œæ•°æ®');
                        return;
                    }
                    
                    const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
                    const items = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                        const values = parseCSVLine(lines[i]);
                        if (values.length >= 3) { // è‡³å°‘éœ€è¦åç§°ã€åˆ†ç±»ã€ä½ç½®
                            const item = {
                                name: values[0] || '',
                                category: values[1] || '',
                                location: values[2] || '',
                                description: values[3] || '',
                                imageUrl: values[4] || ''
                            };
                            if (item.name && item.category && item.location) {
                                items.push(item);
                            }
                        }
                    }
                    
                    if (items.length > 0) {
                        confirmImport(items, 'CSV');
                    } else {
                        alert('CSVæ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ç‰©å“æ•°æ®');
                    }
                    
                } catch (error) {
                    console.error('CSVè§£æå¤±è´¥:', error);
                    alert('CSVæ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        // è§£æCSVè¡Œï¼ˆå¤„ç†å¼•å·å’Œé€—å·ï¼‰
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++; // è·³è¿‡ä¸‹ä¸€ä¸ªå¼•å·
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        // ä»JSONå¯¼å…¥
        function importFromJSON(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    const items = Array.isArray(jsonData) ? jsonData : [jsonData];
                    
                    const validItems = items.filter(item => 
                        item.name && item.category && item.location
                    ).map(item => ({
                        name: item.name || item['åç§°'] || '',
                        category: item.category || item['åˆ†ç±»'] || '',
                        location: item.location || item['ä½ç½®'] || '',
                        description: item.description || item['æè¿°'] || '',
                        imageUrl: item.imageUrl || item['å›¾ç‰‡é“¾æ¥'] || ''
                    }));
                    
                    if (validItems.length > 0) {
                        confirmImport(validItems, 'JSON');
                    } else {
                        alert('JSONæ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ç‰©å“æ•°æ®');
                    }
                    
                } catch (error) {
                    console.error('JSONè§£æå¤±è´¥:', error);
                    alert('JSONæ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        // ç¡®è®¤å¯¼å…¥
        async function confirmImport(items, fileType) {
            const confirmMsg = `å‡†å¤‡å¯¼å…¥ ${items.length} æ¡ç‰©å“è®°å½•ï¼ˆ${fileType}æ ¼å¼ï¼‰\n\né¢„è§ˆå‰3æ¡ï¼š\n${
                items.slice(0, 3).map(item => `â€¢ ${item.name} (${item.category} - ${item.location})`).join('\n')
            }\n\nç¡®å®šè¦å¯¼å…¥å—ï¼Ÿ`;
            
            if (!confirm(confirmMsg)) {
                document.getElementById('import-file-input').value = '';
                return;
            }
            
            await importItems(items);
        }

        // æ‰¹é‡å¯¼å…¥ç‰©å“
        async function importItems(items) {
            let successCount = 0;
            let failCount = 0;
            const errors = [];
            
            // è·å–ç°æœ‰çš„åˆ†ç±»å’Œä½ç½®
            const [categoriesResponse, locationsResponse] = await Promise.all([
                fetch(`${API_BASE}/category/list?userId=${currentUser.userId}`),
                fetch(`${API_BASE}/location/list?userId=${currentUser.userId}`)
            ]);
            
            const categoriesResult = await categoriesResponse.json();
            const locationsResult = await locationsResponse.json();
            
            const existingCategories = new Set((categoriesResult.data || []).map(cat => cat.name));
            const existingLocations = new Set((locationsResult.data || []).map(loc => loc.name));
            
            // å¤„ç†æ¯ä¸ªç‰©å“
            for (const item of items) {
                try {
                    // æ£€æŸ¥åˆ†ç±»æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º
                    if (!existingCategories.has(item.category)) {
                        await createCategory(item.category);
                        existingCategories.add(item.category);
                    }
                    
                    // æ£€æŸ¥ä½ç½®æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º
                    if (!existingLocations.has(item.location)) {
                        await createLocation(item.location);
                        existingLocations.add(item.location);
                    }
                    
                    // é‡æ–°è·å–åˆ†ç±»å’Œä½ç½®ID
                    const updatedCategoriesResponse = await fetch(`${API_BASE}/category/list?userId=${currentUser.userId}`);
                    const updatedCategoriesResult = await updatedCategoriesResponse.json();
                    const categoryMap = new Map((updatedCategoriesResult.data || []).map(cat => [cat.name, cat.categoryId]));
                    
                    const updatedLocationsResponse = await fetch(`${API_BASE}/location/list?userId=${currentUser.userId}`);
                    const updatedLocationsResult = await updatedLocationsResponse.json();
                    const locationMap = new Map((updatedLocationsResult.data || []).map(loc => [loc.name, loc.locationId]));
                    
                    // æ·»åŠ ç‰©å“
                    const itemData = {
                        userId: currentUser.userId,
                        name: item.name,
                        categoryId: categoryMap.get(item.category),
                        locationId: locationMap.get(item.location),
                        description: item.description,
                        imageUrl: item.imageUrl
                    };
                    
                    const response = await fetch(`${API_BASE}/item/add`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(itemData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        successCount++;
                    } else {
                        failCount++;
                        errors.push(`${item.name}: ${result.message || 'æœªçŸ¥é”™è¯¯'}`);
                    }
                    
                } catch (error) {
                    console.error(`å¯¼å…¥ç‰©å“å¤±è´¥: ${item.name}`, error);
                    failCount++;
                    errors.push(`${item.name}: ç½‘ç»œé”™è¯¯`);
                }
            }
            
            // æ˜¾ç¤ºå¯¼å…¥ç»“æœ
            let resultMsg = `å¯¼å…¥å®Œæˆï¼\næˆåŠŸ: ${successCount} æ¡\nå¤±è´¥: ${failCount} æ¡`;
            if (errors.length > 0 && errors.length <= 5) {
                resultMsg += '\n\nå¤±è´¥è¯¦æƒ…:\n' + errors.join('\n');
            } else if (errors.length > 5) {
                resultMsg += '\n\néƒ¨åˆ†å¤±è´¥è¯¦æƒ…:\n' + errors.slice(0, 5).join('\n') + `\n... è¿˜æœ‰ ${errors.length - 5} æ¡é”™è¯¯`;
            }
            
            alert(resultMsg);
            
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥å¹¶åˆ·æ–°åˆ—è¡¨
            document.getElementById('import-file-input').value = '';
            if (successCount > 0) {
                loadItems();
                // åˆ·æ–°å…¶ä»–é¡µé¢çš„æ•°æ®
                loadCategoriesForManagement();
                loadLocations();
            }
        }

        // åˆ›å»ºåˆ†ç±»
        async function createCategory(categoryName) {
            const response = await fetch(`${API_BASE}/category/add`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: currentUser.userId,
                    name: categoryName
                })
            });
            return response.json();
        }

        // åˆ›å»ºä½ç½®
        async function createLocation(locationName) {
            const response = await fetch(`${API_BASE}/location/add`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: currentUser.userId,
                    name: locationName,
                    icon: 'ğŸ“¦' // é»˜è®¤å›¾æ ‡
                })
            });
            return response.json();
        }

        // åŠ è½½ç­›é€‰é€‰é¡¹
        async function loadFilterOptions() {
            try {
                const [categoriesResponse, locationsResponse] = await Promise.all([
                    fetch(`${API_BASE}/category/list?userId=${currentUser.userId}`),
                    fetch(`${API_BASE}/location/list?userId=${currentUser.userId}`)
                ]);

                const categoriesResult = await categoriesResponse.json();
                const locationsResult = await locationsResponse.json();

                const categories = categoriesResult.data && Array.isArray(categoriesResult.data) ? categoriesResult.data : [];
                const locations = locationsResult.data && Array.isArray(locationsResult.data) ? locationsResult.data : [];

                // å¡«å……åˆ†ç±»ç­›é€‰å™¨
                const categoryFilter = document.getElementById('filter-category');
                categoryFilter.innerHTML = '<option value="">å…¨éƒ¨åˆ†ç±»</option>' + 
                    categories.map(cat => `<option value="${cat.name}">${cat.name}${cat.isSystem ? ' (ç³»ç»Ÿ)' : ''}</option>`).join('');

                // å¡«å……ä½ç½®ç­›é€‰å™¨
                const locationFilter = document.getElementById('filter-location');
                locationFilter.innerHTML = '<option value="">å…¨éƒ¨ä½ç½®</option>' + 
                    locations.map(loc => `<option value="${loc.name}">${loc.icon} ${loc.name}</option>`).join('');

            } catch (error) {
                console.error('åŠ è½½ç­›é€‰é€‰é¡¹å¤±è´¥:', error);
            }
        }

        // æ·»åŠ ç­›é€‰å™¨äº‹ä»¶ç›‘å¬
        document.getElementById('filter-category').addEventListener('change', loadItems);
        document.getElementById('filter-location').addEventListener('change', loadItems);
        document.getElementById('filter-sort').addEventListener('change', loadItems);

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // åŠ è½½ä½ç½®åˆ—è¡¨
        async function loadLocations() {
            try {
                const response = await fetch(`${API_BASE}/location/list?userId=${currentUser.userId}`);
                const result = await response.json();
                
                const list = document.getElementById('locations-list');
                
                // å®‰å…¨æ£€æŸ¥å¹¶è·å–ä½ç½®æ•°ç»„
                const locations = result.data && Array.isArray(result.data) ? result.data : [];
                
                if (locations.length === 0) {
                    list.innerHTML = '<div class="empty-state"><p>æš‚æ— ä½ç½®è®°å½•</p></div>';
                    return;
                }
                
                list.innerHTML = locations.map(location => `
                    <div class="location-item">
                        <span>${location.icon} ${location.name}</span>
                        <div class="location-actions">
                            <button class="btn btn-danger" onclick="deleteLocation(${location.locationId})" style="background: #ff6b6b; padding: 6px 12px; font-size: 12px;">åˆ é™¤</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½ä½ç½®å¤±è´¥:', error);
                const list = document.getElementById('locations-list');
                list.innerHTML = '<div class="empty-state"><p>åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p></div>';
            }
        }

        // åŠ è½½åˆ†ç±»é€‰é¡¹
        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE}/category/list?userId=${currentUser.userId}`);
                const result = await response.json();
                
                const select = document.getElementById('item-category');
                const categories = result.data && Array.isArray(result.data) ? result.data : [];
                
                select.innerHTML = '<option value="">è¯·é€‰æ‹©åˆ†ç±»</option>' + 
                    categories.map(cat => `<option value="${cat.categoryId}">${cat.name}${cat.isSystem ? ' (ç³»ç»Ÿ)' : ''}</option>`).join('');
            } catch (error) {
                console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
                const select = document.getElementById('item-category');
                select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
            }
        }

        // åŠ è½½ä½ç½®é€‰é¡¹
        async function loadLocationOptions() {
            try {
                const response = await fetch(`${API_BASE}/location/list?userId=${currentUser.userId}`);
                const result = await response.json();
                
                const select = document.getElementById('item-location');
                const locations = result.data && Array.isArray(result.data) ? result.data : [];
                
                select.innerHTML = '<option value="">è¯·é€‰æ‹©ä½ç½®</option>' + 
                    locations.map(loc => `<option value="${loc.locationId}">${loc.icon} ${loc.name}</option>`).join('');
            } catch (error) {
                console.error('åŠ è½½ä½ç½®é€‰é¡¹å¤±è´¥:', error);
                const select = document.getElementById('item-location');
                select.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
            }
        }

        // æ·»åŠ ç‰©å“
        document.getElementById('add-item-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                userId: currentUser.userId,
                name: safeGetValue('item-name'),
                categoryId: parseInt(safeGetValue('item-category')),
                locationId: parseInt(safeGetValue('item-location')),
                description: safeGetValue('item-description'),
                imageUrl: currentImageUrl // åŒ…å«ä¸Šä¼ çš„å›¾ç‰‡URL
            };
            
            // å¢å¼ºçš„è¡¨å•éªŒè¯
            if (!formData.name || !formData.name.trim()) {
                showToast('âŒ è¯·è¾“å…¥ç‰©å“åç§°', 2000);
                return;
            }
            if (!formData.categoryId || isNaN(formData.categoryId)) {
                showToast('âŒ è¯·é€‰æ‹©åˆ†ç±»', 2000);
                return;
            }
            if (!formData.locationId || isNaN(formData.locationId)) {
                showToast('âŒ è¯·é€‰æ‹©ä½ç½®', 2000);
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/item/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('æ·»åŠ æˆåŠŸï¼');
                    
                    // è®°å½•è¡Œä¸ºæ•°æ®
                    smartAnalytics.recordAddTime();
                    const categorySelect = document.getElementById('item-category');
                    const locationSelect = document.getElementById('item-location');
                    if (categorySelect.selectedIndex > 0) {
                        smartAnalytics.recordCategoryUsage(categorySelect.options[categorySelect.selectedIndex].text.replace(/ \(\u7cfb\u7edf\)/, ''));
                    }
                    if (locationSelect.selectedIndex > 0) {
                        smartAnalytics.recordLocationUsage(locationSelect.options[locationSelect.selectedIndex].text.replace(/^[^\s]+ /, ''));
                    }
                    
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('add-item-form').reset();
                    document.getElementById('image-preview').style.display = 'none';
                    document.getElementById('image-remove').style.display = 'none';
                    currentImageUrl = null;
                    showTab('items');
                    loadItems();
                } else {
                    alert('æ·»åŠ å¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('æ·»åŠ ç‰©å“å¤±è´¥:', error);
                alert('æ·»åŠ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        });

        // ä½ç½®ç®¡ç†
        function showAddLocationModal() {
            document.getElementById('location-modal').style.display = 'block';
        }

        function closeLocationModal() {
            document.getElementById('location-modal').style.display = 'none';
            document.getElementById('add-location-form').reset();
        }

        document.getElementById('add-location-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                userId: currentUser.userId,
                name: document.getElementById('location-name').value,
                icon: document.getElementById('location-icon').value
            };
            
            // éªŒè¯è¡¨å•
            if (!formData.name.trim()) {
                alert('è¯·è¾“å…¥ä½ç½®åç§°');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/location/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('ä½ç½®æ·»åŠ æˆåŠŸï¼');
                    closeLocationModal();
                    loadLocations();
                    loadLocationOptions();
                } else {
                    alert('æ·»åŠ å¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('æ·»åŠ ä½ç½®å¤±è´¥:', error);
                alert('æ·»åŠ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        });

        // åˆ é™¤ç‰©å“
        async function deleteItem(itemId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç‰©å“å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`${API_BASE}/item/${itemId}?userId=${currentUser.userId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('åˆ é™¤æˆåŠŸï¼');
                    loadItems();
                } else {
                    alert('åˆ é™¤å¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åˆ é™¤ç‰©å“å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // åˆ é™¤ä½ç½®
        async function deleteLocation(locationId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä½ç½®å—ï¼Ÿæ³¨æ„ï¼šä½ç½®ä¸‹æœ‰ç‰©å“æ—¶æ— æ³•åˆ é™¤ã€‚')) return;
            
            try {
                const response = await fetch(`${API_BASE}/location/${locationId}?userId=${currentUser.userId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('åˆ é™¤æˆåŠŸï¼');
                    loadLocations();
                    loadLocationOptions();
                } else {
                    alert('åˆ é™¤å¤±è´¥ï¼š' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åˆ é™¤ä½ç½®å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // å¿«é€Ÿæ·»åŠ åŠŸèƒ½ - ç®€åŒ–ç‰ˆæœ¬
        let quickMode = 'smart', parsedItems = [], capturedPhotos = [];

        // æ˜¾ç¤ºå¿«é€Ÿæ·»åŠ æ¨¡æ€æ¡†
        function showQuickAddModal() { 
            document.getElementById('quick-add-modal').style.display = 'block';
            
            // æ˜¾ç¤ºæ™ºèƒ½æ¨è
            displayQuickAddRecommendations();
        }
        function closeQuickAddModal() {
            document.getElementById('quick-add-modal').style.display = 'none';
            parsedItems = []; capturedPhotos = [];
            document.getElementById('smart-input-text').value = '';
            document.getElementById('smart-suggestions').style.display = 'none';
            document.getElementById('confirm-smart-btn').style.display = 'none';
        }

        function switchQuickMode(mode) {
            quickMode = mode;
            document.querySelectorAll('.quick-mode').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.quick-mode-content').forEach(content => content.style.display = 'none');
            document.getElementById(mode + '-mode').style.display = 'block';
        }

        function processSmartInput() {
            const text = document.getElementById('smart-input-text').value.trim();
            if (!text) { alert('è¯·è¾“å…¥è¦æ·»åŠ çš„ç‰©å“ä¿¡æ¯'); return; }
            document.querySelector('.smart-input').classList.add('processing');
            setTimeout(() => {
                const items = parseSmartInput(text);
                displayParsedItems(items);
                document.querySelector('.smart-input').classList.remove('processing');
            }, 1500);
        }

        function parseSmartInput(text) {
            const items = [], lines = text.split('\n').filter(line => line.trim());
            const categoryKeywords = {
                'ç”µå­äº§å“': ['iPhone', 'iPad', 'æ‰‹æœº', 'ç”µè„‘', 'ç¬”è®°æœ¬', 'è€³æœº'],
                'ä¹¦ç±æ–‡å…·': ['ä¹¦', 'å°è¯´', 'ç¬”', 'æœ¬å­', 'æ–‡ä»¶å¤¹'],
                'æœè£…é…é¥°': ['è¡¬è¡«', 'è£¤å­', 'é‹å­', 'æ‰‹è¡¨', 'é¡¹é“¾'],
                'ç”Ÿæ´»ç”¨å“': ['æ¯å­', 'é”…', 'ç¢³', 'æ¯›å·¾'],
                'å…¶ä»–ç‰©å“': []
            };
            const locationKeywords = {
                'å®¢å…': ['å®¢å…', 'æ²™å‘', 'ç”µè§†'], 'å§å®¤': ['å§å®¤', 'åºŠ', 'è¡£æŸœ'],
                'å¨æˆ¿': ['å¨æˆ¿', 'å†°ç®±'], 'ä¹¦æˆ¿': ['ä¹¦æˆ¿', 'ä¹¦æ¡Œ'], 'å…¶ä»–ä½ç½®': []
            };

            lines.forEach((line, index) => {
                let itemName = line.replace(/åœ¨.*?çš„|,.*|ï¼Œ.*/g, '').trim();
                let category = 'å…¶ä»–ç‰©å“', location = 'å…¶ä»–ä½ç½®', description = '';

                for (const [loc, keywords] of Object.entries(locationKeywords)) {
                    if (keywords.some(keyword => line.includes(keyword)) || line.includes(loc)) { location = loc; break; }
                }
                for (const [cat, keywords] of Object.entries(categoryKeywords)) {
                    if (keywords.some(keyword => line.includes(keyword))) { category = cat; break; }
                }
                const descMatch = line.match(/[,ï¼Œ](.+)/);
                if (descMatch) description = descMatch[1].trim();
                if (itemName) items.push({ id: Date.now() + index, name: itemName, category, location, description, confirmed: false });
            });
            return items;
        }

        function displayParsedItems(items) {
            parsedItems = items;
            const container = document.getElementById('parsed-items');
            if (items.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">æ²¡æœ‰è¯†åˆ«åˆ°æœ‰æ•ˆçš„ç‰©å“ä¿¡æ¯</p>';
                document.getElementById('smart-suggestions').style.display = 'block'; return;
            }
            container.innerHTML = items.map(item => `
                <div class="parsed-item" data-id="${item.id}">
                    <div class="parsed-item-info">
                        <div class="parsed-item-name">${item.name}</div>
                        <div class="parsed-item-details">${item.category} Â· ${item.location}${item.description ? ' Â· ' + item.description : ''}</div>
                    </div>
                    <div class="parsed-item-actions">
                        <button class="btn" onclick="confirmParsedItem(${item.id})" style="background: #28a745; color: white; padding: 4px 8px; font-size: 12px;">ç¡®è®¤</button>
                        <button class="btn btn-danger" onclick="removeParsedItem(${item.id})" style="padding: 4px 8px; font-size: 12px;">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
            document.getElementById('smart-suggestions').style.display = 'block';
            document.getElementById('confirm-smart-btn').style.display = 'inline-block';
        }

        function confirmParsedItem(itemId) {
            const item = parsedItems.find(p => p.id === itemId);
            if (item) {
                item.confirmed = true;
                const element = document.querySelector(`[data-id="${itemId}"]`);
                element.classList.add('confirmed');
                element.querySelector('.parsed-item-actions').innerHTML = '<span style="color: #4caf50; font-weight: bold;">âœ“ å·²ç¡®è®¤</span>';
            }
        }

        function removeParsedItem(itemId) { parsedItems = parsedItems.filter(p => p.id !== itemId); displayParsedItems(parsedItems); }

        async function confirmSmartItems() {
            const confirmedItems = parsedItems.filter(item => item.confirmed);
            if (confirmedItems.length === 0) { alert('è¯·è‡³å°‘ç¡®è®¤ä¸€ä¸ªç‰©å“'); return; }
            let successCount = 0, failCount = 0;
            for (const item of confirmedItems) {
                try {
                    const categoryId = await getOrCreateCategory(item.category);
                    const locationId = await getOrCreateLocation(item.location);
                    const response = await fetch(`${API_BASE}/item/add`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: currentUser.userId, name: item.name, categoryId, locationId, description: item.description || '', imageUrl: null })
                    });
                    const result = await response.json();
                    if (result.success) successCount++; else failCount++;
                } catch (error) { failCount++; }
            }
            alert(`æ‰¹é‡æ·»åŠ å®Œæˆï¼\næˆåŠŸ: ${successCount} ä¸ª\nå¤±è´¥: ${failCount} ä¸ª`);
            if (successCount > 0) { closeQuickAddModal(); loadItems(); }
        }

        async function getOrCreateCategory(categoryName) {
            try {
                const response = await fetch(`${API_BASE}/category/list?userId=${currentUser.userId}`);
                const result = await response.json(), categories = result.data || [];
                const existing = categories.find(cat => cat.name === categoryName);
                if (existing) return existing.categoryId;
                const createResponse = await fetch(`${API_BASE}/category/add`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.userId, name: categoryName })
                });
                const createResult = await createResponse.json();
                return createResult.success ? createResult.data : null;
            } catch (error) { return null; }
        }

        async function getOrCreateLocation(locationName) {
            try {
                const response = await fetch(`${API_BASE}/location/list?userId=${currentUser.userId}`);
                const result = await response.json(), locations = result.data || [];
                const existing = locations.find(loc => loc.name === locationName);
                if (existing) return existing.locationId;
                const createResponse = await fetch(`${API_BASE}/location/add`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.userId, name: locationName, icon: 'ğŸ“' })
                });
                const createResult = await createResponse.json();
                return createResult.success ? createResult.data : null;
            } catch (error) { return null; }
        }

        // è¿æ‹å’Œè¯­éŸ³åŠŸèƒ½ï¼ˆç®€åŒ–ç‰ˆï¼‰
        async function startQuickCamera() {
            try {
                const video = document.getElementById('quick-camera-video');
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream; video.style.display = 'block'; video.play();
                document.getElementById('start-camera-btn').style.display = 'none';
                document.getElementById('capture-btn').style.display = 'inline-block';
            } catch (error) { alert('æ— æ³•å¯åŠ¨æ‘„åƒå¤´'); }
        }

        function captureQuickPhoto() {
            const video = document.getElementById('quick-camera-video'), canvas = document.getElementById('quick-camera-canvas'), ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight; ctx.drawImage(video, 0, 0);
            capturedPhotos.push({ id: Date.now(), data: canvas.toDataURL('image/jpeg', 0.8) }); displayCapturedPhotos();
        }

        function displayCapturedPhotos() {
            document.getElementById('captured-images').innerHTML = capturedPhotos.map(photo => `
                <div class="captured-image"><img src="${photo.data}" alt="æ‹ç…§">
                <button class="remove-btn" onclick="removeCapturedPhoto(${photo.id})">Ã—</button></div>
            `).join('');
            if (capturedPhotos.length > 0) document.getElementById('camera-actions').style.display = 'block';
        }

        function removeCapturedPhoto(photoId) { capturedPhotos = capturedPhotos.filter(p => p.id !== photoId); displayCapturedPhotos(); }
        function processQuickPhotos() { if (capturedPhotos.length === 0) { alert('è¯·å…ˆæ‹ç…§'); return; } alert('æ¼”ç¤ºæ¨¡å¼ï¼Œå®é™…ä½¿ç”¨AIè¯†åˆ«'); }

        function startQuickVoiceInput() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) { alert('ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«'); return; }
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)(), btn = document.getElementById('voice-input-btn');
            recognition.lang = 'zh-CN'; recognition.continuous = true; recognition.interimResults = false;
            recognition.onstart = () => { btn.textContent = 'ğŸ“´ å½•éŸ³ä¸­...'; btn.style.background = '#ff4444'; };
            recognition.onresult = (event) => {
                let transcript = ''; for (let i = 0; i < event.results.length; i++) transcript += event.results[i][0].transcript;
                document.getElementById('voice-text').textContent = transcript; document.getElementById('voice-result').style.display = 'block';
            };
            recognition.onerror = () => alert('è¯­éŸ³è¯†åˆ«å¤±è´¥');
            recognition.onend = () => { btn.textContent = 'ğŸ¤ å¼€å§‹å½•éŸ³'; btn.style.background = '#667eea'; };
            recognition.start(); setTimeout(() => recognition.stop(), 10000);
        }

        function processVoiceResult() {
            const voiceText = document.getElementById('voice-text').textContent;
            if (!voiceText.trim()) { alert('æ²¡æœ‰è¯†åˆ«åˆ°è¯­éŸ³'); return; }
            switchQuickMode('smart'); document.getElementById('smart-input-text').value = voiceText; processSmartInput();
        }

        // ç§»åŠ¨ç«¯æ‰‹åŠ¿ä¼˜åŒ–åŠŸèƒ½
        let touchStartX = 0, touchStartY = 0, currentSwipeCard = null, isPulling = false, pullDistance = 0;

        // åˆå§‹åŒ–ç§»åŠ¨ç«¯æ‰‹åŠ¿
        function initMobileGestures() {
            // ä¸ºæ‰€æœ‰ç‰©å“å¡ç‰‡æ·»åŠ æ‰‹åŠ¿ç›‘å¬
            document.addEventListener('touchstart', handleTouchStart, { passive: false });
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleTouchEnd, { passive: false });
            
            // åŒå‡»å›¾ç‰‡æ”¾å¤§
            document.addEventListener('dblclick', function(e) {
                if (e.target.classList.contains('item-image') || e.target.classList.contains('image-preview')) {
                    showImageZoom(e.target.src);
                }
            });
            
            // é•¿æŒ‰æ˜¾ç¤ºå¿«æ·æ“ä½œé¢æ¿
            let longPressTimer;
            document.addEventListener('touchstart', function(e) {
                longPressTimer = setTimeout(() => {
                    if (!e.target.closest('.modal') && !e.target.closest('.quick-actions-panel')) {
                        showQuickActionsPanel();
                        navigator.vibrate && navigator.vibrate(50);
                    }
                }, 800);
            });
            
            document.addEventListener('touchend', () => clearTimeout(longPressTimer));
            document.addEventListener('touchmove', () => clearTimeout(longPressTimer));
        }

        function handleTouchStart(e) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            currentSwipeCard = e.target.closest('.item-card');
            
            // ä¸‹æ‹‰åˆ·æ–°æ£€æµ‹
            if (e.target.closest('#items-list') && window.scrollY === 0) {
                isPulling = true;
                pullDistance = 0;
            }
        }

        function handleTouchMove(e) {
            if (!touchStartX || !touchStartY) return;
            
            const touchX = e.touches[0].clientX;
            const touchY = e.touches[0].clientY;
            const deltaX = touchX - touchStartX;
            const deltaY = touchY - touchStartY;
            
            // ä¸‹æ‹‰åˆ·æ–°
            if (isPulling && deltaY > 0 && window.scrollY === 0) {
                pullDistance = Math.min(deltaY, 100);
                const itemsList = document.getElementById('items-list');
                if (itemsList) {
                    itemsList.style.transform = `translateY(${pullDistance}px)`;
                    if (pullDistance > 50) {
                        itemsList.classList.add('pulling');
                    }
                }
                e.preventDefault();
                return;
            }
            
            // å¡ç‰‡å·¦å³æ»‘åŠ¨
            if (currentSwipeCard && Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 20) {
                const swipeDistance = Math.min(Math.abs(deltaX), 120);
                if (deltaX < 0) { // å·¦æ»‘
                    currentSwipeCard.style.transform = `translateX(-${swipeDistance}px)`;
                    currentSwipeCard.classList.add('swiping');
                    
                    // æ˜¾ç¤ºæ“ä½œæŒ‰é’®
                    let swipeActions = currentSwipeCard.querySelector('.swipe-actions');
                    if (!swipeActions) {
                        swipeActions = document.createElement('div');
                        swipeActions.className = 'swipe-actions';
                        swipeActions.innerHTML = `
                            <div class="swipe-action edit" onclick="editItemFromSwipe(this)">âœï¸</div>
                            <div class="swipe-action qr" onclick="showQRFromSwipe(this)">ğŸ“±</div>
                            <div class="swipe-action" onclick="deleteItemFromSwipe(this)">ğŸ—‘ï¸</div>
                        `;
                        currentSwipeCard.appendChild(swipeActions);
                    }
                    
                    if (swipeDistance > 60) {
                        swipeActions.classList.add('show');
                    }
                }
                e.preventDefault();
            }
        }

        function handleTouchEnd(e) {
            // ä¸‹æ‹‰åˆ·æ–°å®Œæˆ
            if (isPulling) {
                const itemsList = document.getElementById('items-list');
                if (itemsList) {
                    if (pullDistance > 50) {
                        // è§¦å‘åˆ·æ–°
                        itemsList.classList.add('refreshing');
                        refreshAllData().then(() => {
                            setTimeout(() => {
                                itemsList.style.transform = '';
                                itemsList.classList.remove('pulling', 'refreshing');
                            }, 500);
                        });
                    } else {
                        itemsList.style.transform = '';
                        itemsList.classList.remove('pulling');
                    }
                }
                isPulling = false;
                pullDistance = 0;
            }
            
            // å¡ç‰‡æ»‘åŠ¨å®Œæˆ
            if (currentSwipeCard) {
                const transform = currentSwipeCard.style.transform;
                const translateX = transform ? parseFloat(transform.match(/-?\d+/)) : 0;
                
                if (Math.abs(translateX) > 60) {
                    currentSwipeCard.classList.add('swiped');
                } else {
                    currentSwipeCard.style.transform = '';
                    currentSwipeCard.classList.remove('swiping');
                    const swipeActions = currentSwipeCard.querySelector('.swipe-actions');
                    if (swipeActions) swipeActions.classList.remove('show');
                }
            }
            
            // é‡ç½®çŠ¶æ€
            touchStartX = 0;
            touchStartY = 0;
            if (currentSwipeCard && !currentSwipeCard.classList.contains('swiped')) {
                currentSwipeCard = null;
            }
        }

        // æ»‘åŠ¨æ“ä½œå‡½æ•°
        function editItemFromSwipe(element) {
            const card = element.closest('.item-card');
            const itemId = card.onclick.toString().match(/\d+/)[0];
            showItemDetail(parseInt(itemId));
            setTimeout(() => editItem(), 500);
            resetSwipeCard(card);
        }

        function showQRFromSwipe(element) {
            const card = element.closest('.item-card');
            const itemId = card.onclick.toString().match(/\d+/)[0];
            showItemDetail(parseInt(itemId));
            setTimeout(() => showItemQR(), 500);
            resetSwipeCard(card);
        }

        function deleteItemFromSwipe(element) {
            const card = element.closest('.item-card');
            const itemId = card.onclick.toString().match(/\d+/)[0];
            deleteItem(parseInt(itemId));
            resetSwipeCard(card);
        }

        function resetSwipeCard(card) {
            card.style.transform = '';
            card.classList.remove('swiping', 'swiped');
            const swipeActions = card.querySelector('.swipe-actions');
            if (swipeActions) swipeActions.classList.remove('show');
        }

        // å›¾ç‰‡æ”¾å¤§åŠŸèƒ½
        function showImageZoom(imageSrc) {
            const modal = document.getElementById('image-zoom-modal');
            const img = document.getElementById('zoom-image');
            img.src = imageSrc;
            modal.style.display = 'flex';
        }

        function closeImageZoom() {
            document.getElementById('image-zoom-modal').style.display = 'none';
        }

        // å¿«æ·æ“ä½œé¢æ¿
        function showQuickActionsPanel() {
            const panel = document.getElementById('quick-actions-panel');
            if (panel) {
                // é‡ç½®ä»»ä½•å†…è”æ ·å¼
                panel.style.bottom = '';
                panel.classList.add('show');
                console.log('Quick actions panel shown');
                
                // æ·»åŠ ESCé”®ç›‘å¬
                document.addEventListener('keydown', handleQuickPanelEscape);
            }
        }

        function hideQuickActionsPanel() {
            const panel = document.getElementById('quick-actions-panel');
            if (panel) {
                panel.classList.remove('show');
                console.log('Quick actions panel hidden');
                
                // ç§»é™¤ESCé”®ç›‘å¬
                document.removeEventListener('keydown', handleQuickPanelEscape);
                
                // å¼ºåˆ¶éšè—å¤‡ç”¨æ–¹æ¡ˆï¼ˆå¦‚æœCSSåŠ¨ç”»æœ‰é—®é¢˜ï¼‰
                setTimeout(() => {
                    if (!panel.classList.contains('show')) {
                        panel.style.bottom = '-200px';
                    }
                }, 300);
            } else {
                console.error('Quick actions panel not found');
            }
        }
        
        // ESCé”®å…³é—­å¿«æ·é¢æ¿
        function handleQuickPanelEscape(e) {
            if (e.key === 'Escape') {
                hideQuickActionsPanel();
            }
        }

        // å…¨å±€åˆ·æ–°åŠŸèƒ½
        async function refreshAllData() {
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const loadingToast = showToast('ğŸ”„ æ­£åœ¨åˆ·æ–°æ•°æ®...', 0);
                
                // å¹¶è¡Œåˆ·æ–°æ‰€æœ‰æ•°æ®
                await Promise.all([
                    loadItems(),
                    loadCategoriesForManagement(),
                    loadLocations(),
                    loadCategories(),
                    loadLocationOptions()
                ]);
                
                // éšè—åŠ è½½çŠ¶æ€
                hideToast(loadingToast);
                showToast('âœ“ æ•°æ®åˆ·æ–°æˆåŠŸ', 2000);
            } catch (error) {
                console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error);
                showToast('âŒ åˆ·æ–°å¤±è´¥', 2000);
            }
        }

        // æ˜¾ç¤ºåº”ç”¨ä¿¡æ¯
        function showAppInfo() {
            alert(`ğŸš€ å¯»ç‰©åŠ©æ‰‹ v2.0\n\nâœ¨ æ–°å¢åŠŸèƒ½ï¼š\nâ€¢ æ™ºèƒ½è¯­éŸ³æœç´¢\nâ€¢ å¿«é€Ÿæ‰¹é‡æ·»åŠ \nâ€¢ æ‰‹åŠ¿æ“ä½œä¼˜åŒ–\nâ€¢ ä¸‹æ‹‰åˆ·æ–°åŠŸèƒ½\n\nğŸ“± ç§»åŠ¨ç«¯ä½“éªŒï¼š\nâ€¢ å·¦æ»‘å¡ç‰‡æ˜¾ç¤ºæ“ä½œ\nâ€¢ åŒå‡»å›¾ç‰‡æ”¾å¤§\nâ€¢ é•¿æŒ‰å±å¹•å¿«æ·æ“ä½œ\n\nâ¤ï¸ æ„Ÿè°¢ä½¿ç”¨ï¼`);
        }

        // Toast æç¤ºåŠŸèƒ½
        function showToast(message, duration = 3000) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                background: rgba(0,0,0,0.8); color: white; padding: 12px 20px;
                border-radius: 20px; font-size: 14px; z-index: 1004;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            if (duration > 0) {
                setTimeout(() => hideToast(toast), duration);
            }
            
            return toast;
        }

        function hideToast(toast) {
            if (toast && toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }

        // æ•°æ®å®‰å…¨å’Œå¤‡ä»½åŠŸèƒ½
        class DataBackupManager {
            constructor() {
                this.backupKey = 'findthingBackup';
                this.autoBackupInterval = null;
                this.enableAutoBackup();
            }

            // å¯ç”¨è‡ªåŠ¨å¤‡ä»½ï¼ˆæ¯30åˆ†é’Ÿï¼‰
            enableAutoBackup() {
                this.autoBackupInterval = setInterval(() => {
                    this.createAutoBackup();
                }, 30 * 60 * 1000);
            }

            // åˆ›å»ºè‡ªåŠ¨å¤‡ä»½
            async createAutoBackup() {
                try {
                    const backupData = await this.exportAllData();
                    const backups = JSON.parse(localStorage.getItem(this.backupKey) || '[]');
                    
                    // æ·»åŠ æ–°å¤‡ä»½
                    backups.unshift({
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        type: 'auto',
                        data: backupData,
                        itemCount: backupData.items?.length || 0
                    });
                    
                    // ä¿ç•™æœ€è¿‘10ä¸ªå¤‡ä»½
                    const limitedBackups = backups.slice(0, 10);
                    localStorage.setItem(this.backupKey, JSON.stringify(limitedBackups));
                    
                    console.log('è‡ªåŠ¨å¤‡ä»½å®Œæˆ:', new Date().toLocaleString());
                } catch (error) {
                    console.error('è‡ªåŠ¨å¤‡ä»½å¤±è´¥:', error);
                }
            }

            // æ‰‹åŠ¨åˆ›å»ºå¤‡ä»½
            async createManualBackup(description = '') {
                try {
                    const backupData = await this.exportAllData();
                    const backups = JSON.parse(localStorage.getItem(this.backupKey) || '[]');
                    
                    backups.unshift({
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        type: 'manual',
                        description: description,
                        data: backupData,
                        itemCount: backupData.items?.length || 0
                    });
                    
                    localStorage.setItem(this.backupKey, JSON.stringify(backups.slice(0, 20)));
                    return true;
                } catch (error) {
                    console.error('æ‰‹åŠ¨å¤‡ä»½å¤±è´¥:', error);
                    return false;
                }
            }

            // å¯¼å‡ºæ‰€æœ‰æ•°æ®
            async exportAllData() {
                const [itemsRes, categoriesRes, locationsRes] = await Promise.all([
                    fetch(`${API_BASE}/item/list?userId=${currentUser.userId}&keyword=`),
                    fetch(`${API_BASE}/category/list?userId=${currentUser.userId}`),
                    fetch(`${API_BASE}/location/list?userId=${currentUser.userId}`)
                ]);

                return {
                    items: (await itemsRes.json()).data?.items || [],
                    categories: (await categoriesRes.json()).data || [],
                    locations: (await locationsRes.json()).data || [],
                    exportTime: new Date().toISOString(),
                    version: '2.0'
                };
            }

            // è·å–å¤‡ä»½åˆ—è¡¨
            getBackupList() {
                return JSON.parse(localStorage.getItem(this.backupKey) || '[]');
            }

            // æ¢å¤å¤‡ä»½
            async restoreBackup(backupId) {
                const backups = this.getBackupList();
                const backup = backups.find(b => b.id === backupId);
                
                if (!backup) {
                    throw new Error('å¤‡ä»½ä¸å­˜åœ¨');
                }

                // è¿™é‡Œåº”è¯¥å®ç°æ•°æ®æ¢å¤é€»è¾‘
                // ç”±äºéœ€è¦è°ƒç”¨åç«¯ APIï¼Œè¿™é‡Œåªåšæ¼”ç¤º
                console.log('æ¢å¤å¤‡ä»½:', backup);
                return true;
            }

            // åˆ é™¤å¤‡ä»½
            deleteBackup(backupId) {
                const backups = this.getBackupList();
                const filteredBackups = backups.filter(b => b.id !== backupId);
                localStorage.setItem(this.backupKey, JSON.stringify(filteredBackups));
            }

            // æ¸…ç†è¿‡æœŸå¤‡ä»½ï¼ˆ30å¤©å‰ï¼‰
            cleanOldBackups() {
                const backups = this.getBackupList();
                const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                
                const validBackups = backups.filter(backup => {
                    return backup.type === 'manual' || new Date(backup.timestamp) > thirtyDaysAgo;
                });
                
                localStorage.setItem(this.backupKey, JSON.stringify(validBackups));
            }
        }

        // åˆå§‹åŒ–å¤‡ä»½ç®¡ç†å™¨
        const backupManager = new DataBackupManager();

        // å¤‡ä»½ç®¡ç†å‡½æ•°
        function showBackupManager() {
            const backups = backupManager.getBackupList();
            const backupHtml = backups.length > 0 ? backups.map(backup => {
                const date = new Date(backup.timestamp).toLocaleString('zh-CN');
                const typeText = backup.type === 'auto' ? 'è‡ªåŠ¨' : 'æ‰‹åŠ¨';
                return `
                    <div style="background: #f8f9fa; margin: 10px 0; padding: 15px; border-radius: 8px; border-left: 4px solid ${backup.type === 'manual' ? '#28a745' : '#667eea'};">
                        <div style="font-weight: bold; margin-bottom: 5px;">${typeText}å¤‡ä»½ - ${backup.itemCount} ä¸ªç‰©å“</div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">${date}</div>
                        ${backup.description ? `<div style="font-size: 14px; margin-bottom: 8px;">${backup.description}</div>` : ''}
                        <div>
                            <button onclick="downloadBackup(${backup.id})" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; margin-right: 5px; cursor: pointer; font-size: 12px;">ä¸‹è½½</button>
                            <button onclick="restoreBackupData(${backup.id})" style="background: #ffc107; color: white; border: none; padding: 6px 12px; border-radius: 4px; margin-right: 5px; cursor: pointer; font-size: 12px;">æ¢å¤</button>
                            <button onclick="deleteBackupData(${backup.id})" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">åˆ é™¤</button>
                        </div>
                    </div>
                `;
            }).join('') : '<p style="text-align: center; color: #666; padding: 40px;">æš‚æ— å¤‡ä»½è®°å½•</p>';

            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1002; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; margin: 20px; border-radius: 12px; padding: 0; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                            <h3>ğŸ’¾ æ•°æ®å¤‡ä»½ç®¡ç†</h3>
                            <button onclick="this.closest('div').parentElement.remove()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>
                        <div style="padding: 20px;">
                            <div style="margin-bottom: 20px; text-align: center;">
                                <button onclick="createManualBackupNow()" style="background: #28a745; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; margin-right: 10px;">ğŸ’¾ ç«‹å³å¤‡ä»½</button>
                                <button onclick="exportFullBackup()" style="background: #17a2b8; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer;">ğŸ“¦ å¯¼å‡ºå¤‡ä»½</button>
                            </div>
                            <div style="border-top: 1px solid #eee; padding-top: 15px;">
                                <h4 style="margin-bottom: 15px; color: #333;">å†å²å¤‡ä»½ (${backups.length})</h4>
                                ${backupHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // åˆ›å»ºæ‰‹åŠ¨å¤‡ä»½
        async function createManualBackupNow() {
            const description = prompt('è¯·è¾“å…¥å¤‡ä»½æè¿°ï¼ˆå¯é€‰ï¼‰:') || '';
            const loading = showToast('ğŸ’¾ æ­£åœ¨åˆ›å»ºå¤‡ä»½...', 0);
            
            const success = await backupManager.createManualBackup(description);
            hideToast(loading);
            
            if (success) {
                showToast('âœ“ å¤‡ä»½åˆ›å»ºæˆåŠŸ', 2000);
                // é‡æ–°åˆ·æ–°å¤‡ä»½ç®¡ç†å™¨
                document.querySelector('.close')?.click();
                setTimeout(showBackupManager, 100);
            } else {
                showToast('âŒ å¤‡ä»½åˆ›å»ºå¤±è´¥', 2000);
            }
        }

        // å¯¼å‡ºå®Œæ•´å¤‡ä»½
        async function exportFullBackup() {
            try {
                const loading = showToast('ğŸ“¦ æ­£åœ¨å¯¼å‡ºå®Œæ•´å¤‡ä»½...', 0);
                const allData = await backupManager.exportAllData();
                
                const backupFile = {
                    appName: 'å¯»ç‰©åŠ©æ‰‹',
                    version: '2.0',
                    exportTime: new Date().toISOString(),
                    userData: currentUser,
                    data: allData,
                    backupHistory: backupManager.getBackupList()
                };
                
                const blob = new Blob([JSON.stringify(backupFile, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `å¯»ç‰©åŠ©æ‰‹_å®Œæ•´å¤‡ä»½_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                
                hideToast(loading);
                showToast('âœ“ å¯¼å‡ºæˆåŠŸ', 2000);
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                showToast('âŒ å¯¼å‡ºå¤±è´¥', 2000);
            }
        }

        // ä¸‹è½½å•ä¸ªå¤‡ä»½
        function downloadBackup(backupId) {
            const backups = backupManager.getBackupList();
            const backup = backups.find(b => b.id === backupId);
            if (!backup) return;
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `å¤‡ä»½_${new Date(backup.timestamp).toLocaleDateString().replace(/\//g, '-')}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // æ¢å¤å¤‡ä»½æ•°æ®
        function restoreBackupData(backupId) {
            if (!confirm('æ¢å¤å¤‡ä»½å°†è¦†ç›–å½“å‰æ•°æ®ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) return;
            
            // è¿™é‡Œåº”è¯¥å®ç°çœŸæ­£çš„æ•°æ®æ¢å¤é€»è¾‘
            alert('æ•°æ®æ¢å¤åŠŸèƒ½éœ€è¦åç«¯APIæ”¯æŒï¼Œå½“å‰ä¸ºæ¼”ç¤ºæ¨¡å¼ã€‚\n\nå®é™…é¡¹ç›®ä¸­å°†ä¼šï¼š\n1. æ¸…ç©ºå½“å‰æ•°æ®\n2. æ¢å¤å¤‡ä»½ä¸­çš„æ•°æ®\n3. æ›´æ–°æœ¬åœ°æ˜¾ç¤º');
        }

        // åˆ é™¤å¤‡ä»½æ•°æ®
        function deleteBackupData(backupId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¤‡ä»½å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
            
            backupManager.deleteBackup(backupId);
            showToast('âœ“ å¤‡ä»½å·²åˆ é™¤', 2000);
            
            // é‡æ–°åˆ·æ–°å¤‡ä»½ç®¡ç†å™¨
            document.querySelector('.close')?.click();
            setTimeout(showBackupManager, 100);
        }

        // æ™ºèƒ½æ¨èå’Œæ•°æ®åˆ†æåŠŸèƒ½
        class SmartAnalytics {
            constructor() {
                this.userBehavior = JSON.parse(localStorage.getItem('userBehavior') || '{}');
                this.initializeBehaviorTracking();
            }

            // åˆå§‹åŒ–ç”¨æˆ·è¡Œä¸ºè·Ÿè¸ª
            initializeBehaviorTracking() {
                if (!this.userBehavior.searchHistory) this.userBehavior.searchHistory = [];
                if (!this.userBehavior.categoryUsage) this.userBehavior.categoryUsage = {};
                if (!this.userBehavior.locationUsage) this.userBehavior.locationUsage = {};
                if (!this.userBehavior.addTimes) this.userBehavior.addTimes = [];
            }

            // è®°å½•æœç´¢è¡Œä¸º
            recordSearch(keyword) {
                if (!keyword.trim()) return;
                this.userBehavior.searchHistory.unshift({
                    keyword: keyword,
                    timestamp: Date.now()
                });
                this.userBehavior.searchHistory = this.userBehavior.searchHistory.slice(0, 100);
                this.saveBehavior();
            }

            // è®°å½•åˆ†ç±»ä½¿ç”¨
            recordCategoryUsage(categoryName) {
                this.userBehavior.categoryUsage[categoryName] = (this.userBehavior.categoryUsage[categoryName] || 0) + 1;
                this.saveBehavior();
            }

            // è®°å½•ä½ç½®ä½¿ç”¨
            recordLocationUsage(locationName) {
                this.userBehavior.locationUsage[locationName] = (this.userBehavior.locationUsage[locationName] || 0) + 1;
                this.saveBehavior();
            }

            // è®°å½•æ·»åŠ ç‰©å“æ—¶é—´
            recordAddTime() {
                const hour = new Date().getHours();
                this.userBehavior.addTimes.push(hour);
                this.userBehavior.addTimes = this.userBehavior.addTimes.slice(-200); // ä¿ç•™æœ€è¿‘200æ¬¡
                this.saveBehavior();
            }

            // ä¿å­˜è¡Œä¸ºæ•°æ®
            saveBehavior() {
                localStorage.setItem('userBehavior', JSON.stringify(this.userBehavior));
            }

            // è·å–æœç´¢æ¨è
            getSearchRecommendations() {
                const recentSearches = this.userBehavior.searchHistory.slice(0, 10);
                const popularKeywords = {};
                
                recentSearches.forEach(search => {
                    const words = search.keyword.split(/\s+/);
                    words.forEach(word => {
                        if (word.length > 1) {
                            popularKeywords[word] = (popularKeywords[word] || 0) + 1;
                        }
                    });
                });
                
                return Object.entries(popularKeywords)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5)
                    .map(([word]) => word);
            }

            // è·å–åˆ†ç±»æ¨è
            getCategoryRecommendation() {
                const sortedCategories = Object.entries(this.userBehavior.categoryUsage)
                    .sort(([,a], [,b]) => b - a);
                return sortedCategories.length > 0 ? sortedCategories[0][0] : 'å…¶ä»–ç‰©å“';
            }

            // è·å–ä½ç½®æ¨è
            getLocationRecommendation() {
                const sortedLocations = Object.entries(this.userBehavior.locationUsage)
                    .sort(([,a], [,b]) => b - a);
                return sortedLocations.length > 0 ? sortedLocations[0][0] : 'å…¶ä»–ä½ç½®';
            }

            // è·å–æ´»è·ƒæ—¶é—´åˆ†æ
            getActiveTimeAnalysis() {
                const hourCounts = {};
                this.userBehavior.addTimes.forEach(hour => {
                    hourCounts[hour] = (hourCounts[hour] || 0) + 1;
                });
                
                const peakHour = Object.entries(hourCounts)
                    .sort(([,a], [,b]) => b - a)[0];
                
                return peakHour ? {
                    hour: parseInt(peakHour[0]),
                    count: peakHour[1],
                    timeLabel: this.getTimeLabel(parseInt(peakHour[0]))
                } : null;
            }

            // è·å–æ—¶é—´æ®µæ ‡ç­¾
            getTimeLabel(hour) {
                if (hour >= 6 && hour < 12) return 'ä¸Šåˆ';
                if (hour >= 12 && hour < 18) return 'ä¸‹åˆ';
                if (hour >= 18 && hour < 24) return 'æ™šä¸Š';
                return 'æ·±å¤œ';
            }

            // è·å–æ™ºèƒ½æ¨è
            getSmartRecommendations(items) {
                const recommendations = [];
                
                // åˆ†æç‰©å“åˆ†å¸ƒ
                const categoryStats = {};
                const locationStats = {};
                
                items.forEach(item => {
                    categoryStats[item.category] = (categoryStats[item.category] || 0) + 1;
                    locationStats[item.location] = (locationStats[item.location] || 0) + 1;
                });
                
                // æ£€æŸ¥æ˜¯å¦æœ‰åˆ†ç±»ä¸å‡è¡¡
                const totalItems = items.length;
                const categoryCount = Object.keys(categoryStats).length;
                if (categoryCount > 0) {
                    const maxCategoryItems = Math.max(...Object.values(categoryStats));
                    if (maxCategoryItems > totalItems * 0.6) {
                        recommendations.push({
                            type: 'balance',
                            title: 'åˆ†ç±»å‡è¡¡å»ºè®®',
                            description: 'æ‚¨çš„ç‰©å“ä¸»è¦é›†ä¸­åœ¨æŸä¸ªåˆ†ç±»ï¼Œå»ºè®®è€ƒè™‘ç»†åŒ–åˆ†ç±»ç®¡ç†',
                            icon: 'âš–ï¸'
                        });
                    }
                }
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ¸…ç†
                const oldItems = items.filter(item => {
                    const itemDate = new Date(item.lastUpdateTime);
                    const monthsAgo = (Date.now() - itemDate.getTime()) / (1000 * 60 * 60 * 24 * 30);
                    return monthsAgo > 6;
                });
                
                if (oldItems.length > totalItems * 0.3) {
                    recommendations.push({
                        type: 'cleanup',
                        title: 'æ¸…ç†å»ºè®®',
                        description: `æ‚¨æœ‰ ${oldItems.length} ä¸ªç‰©å“è¶…è¿‡6ä¸ªæœˆæœªæ›´æ–°ï¼Œå»ºè®®æ£€æŸ¥æ˜¯å¦è¿˜éœ€è¦`,
                        icon: 'ğŸ§¹'
                    });
                }
                
                // æ´»è·ƒæ—¶é—´æ¨è
                const activeTime = this.getActiveTimeAnalysis();
                if (activeTime && activeTime.count > 5) {
                    recommendations.push({
                        type: 'timing',
                        title: 'æœ€ä½³æ•´ç†æ—¶é—´',
                        description: `æ‚¨é€šå¸¸åœ¨${activeTime.timeLabel}(${activeTime.hour}:00)æ•´ç†ç‰©å“ï¼Œè¿™æ˜¯æ‚¨çš„é«˜æ•ˆæ—¶æ®µ`,
                        icon: 'â°'
                    });
                }
                
                return recommendations;
            }
        }

        // åˆå§‹åŒ–æ™ºèƒ½åˆ†æ
        const smartAnalytics = new SmartAnalytics();

        // æ›´æ–°ç»Ÿè®¡é¡µé¢æ˜¾ç¤ºæ™ºèƒ½æ¨è
        async function loadEnhancedStatistics() {
            try {
                // è·å–æ•°æ®
                const [itemsResponse, categoriesResponse, locationsResponse] = await Promise.all([
                    fetch(`${API_BASE}/item/list?userId=${currentUser.userId}&keyword=`),
                    fetch(`${API_BASE}/category/list?userId=${currentUser.userId}`),
                    fetch(`${API_BASE}/location/list?userId=${currentUser.userId}`)
                ]);

                const itemsResult = await itemsResponse.json();
                const categoriesResult = await categoriesResponse.json();
                const locationsResult = await locationsResponse.json();

                const items = itemsResult.data?.items || [];
                const categories = categoriesResult.data || [];
                const locations = locationsResult.data || [];

                // æ›´æ–°åŸºæœ¬ç»Ÿè®¡
                document.getElementById('total-items').textContent = items.length;
                document.getElementById('total-categories').textContent = categories.length;
                document.getElementById('total-locations').textContent = locations.length;

                // ç”Ÿæˆæ™ºèƒ½æ¨è
                const recommendations = smartAnalytics.getSmartRecommendations(items);
                displaySmartRecommendations(recommendations);

                // ç”Ÿæˆå¢å¼ºç»Ÿè®¡
                generateEnhancedCharts(items, categories, locations);

            } catch (error) {
                console.error('åŠ è½½å¢å¼ºç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºæ™ºèƒ½æ¨è
        function displaySmartRecommendations(recommendations) {
            // åœ¨ç»Ÿè®¡é¡µé¢æ·»åŠ æ¨èåŒºåŸŸ
            let recommendationSection = document.getElementById('smart-recommendations');
            if (!recommendationSection) {
                recommendationSection = document.createElement('div');
                recommendationSection.id = 'smart-recommendations';
                recommendationSection.style.cssText = 'margin-bottom: 20px;';
                
                const statsOverview = document.querySelector('.stats-overview');
                if (statsOverview) {
                    statsOverview.insertAdjacentElement('afterend', recommendationSection);
                }
            }

            if (recommendations.length === 0) {
                recommendationSection.innerHTML = '';
                return;
            }

            recommendationSection.innerHTML = `
                <div style="background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #333; font-size: 16px;">ğŸ¤– æ™ºèƒ½æ¨è</h4>
                    ${recommendations.map(rec => `
                        <div style="background: #f8f9fa; border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 4px solid #667eea;">
                            <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                <span style="font-size: 18px; margin-right: 8px;">${rec.icon}</span>
                                <strong style="color: #333;">${rec.title}</strong>
                            </div>
                            <div style="color: #666; font-size: 14px;">${rec.description}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // ç”Ÿæˆå¢å¼ºç»Ÿè®¡å›¾è¡¨
        function generateEnhancedCharts(items, categories, locations) {
            // åŸæœ‰çš„å›¾è¡¨ç”Ÿæˆ
            generateCategoryChart(items, categories);
            generateLocationChart(items, locations);
            generateTrendChart(items);
            
            // æ–°å¢æ—¶é—´åˆ†æå›¾è¡¨
            generateTimeAnalysisChart(items);
        }

        // æ—°æ—¶é—´åˆ†æå›¾è¡¨
        function generateTimeAnalysisChart(items) {
            // åœ¨ç»Ÿè®¡é¡µé¢æ·»åŠ æ—°å›¾è¡¨åŒºåŸŸ
            let timeChartSection = document.getElementById('time-analysis-section');
            if (!timeChartSection) {
                timeChartSection = document.createElement('div');
                timeChartSection.innerHTML = `
                    <div class="chart-section">
                        <h4>æ—¶é—´åˆ†æ</h4>
                        <div class="chart-container">
                            <canvas id="time-analysis-chart"></canvas>
                        </div>
                    </div>
                `;
                timeChartSection.id = 'time-analysis-section';
                
                const chartsContainer = document.querySelector('.charts-container');
                if (chartsContainer) {
                    chartsContainer.appendChild(timeChartSection);
                }
            }

            const ctx = document.getElementById('time-analysis-chart');
            if (!ctx) return;
            
            // ç»Ÿè®¡æ¯å¤©æ·»åŠ çš„ç‰©å“æ•°é‡ï¼ˆæœ€è¿‘30å¤©ï¼‰
            const last30Days = {};
            const today = new Date();
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
                last30Days[dateStr] = 0;
            }

            items.forEach(item => {
                const itemDate = new Date(item.lastUpdateTime);
                const dateStr = itemDate.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
                if (last30Days.hasOwnProperty(dateStr)) {
                    last30Days[dateStr]++;
                }
            });

            const labels = Object.keys(last30Days);
            const data = Object.values(last30Days);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æ–°å¢ç‰©å“',
                        data: data,
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: 10
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: æ–°å¢${context.parsed.y}ä¸ªç‰©å“`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // åˆå§‹åŒ–
        initializePage();
        
        // æ˜¾ç¤ºå¿«é€Ÿæ·»åŠ æ¨è
        function displayQuickAddRecommendations() {
            const recommendations = smartAnalytics.getSearchRecommendations();
            const suggestedCategory = smartAnalytics.getCategoryRecommendation();
            const suggestedLocation = smartAnalytics.getLocationRecommendation();
            
            // åœ¨æ™ºèƒ½è¯†åˆ«æ¨¡å¼ä¸‹æ–¹æ·»åŠ æ¨èåŒºåŸŸ
            let recommendationDiv = document.getElementById('quick-recommendations');
            if (!recommendationDiv) {
                recommendationDiv = document.createElement('div');
                recommendationDiv.id = 'quick-recommendations';
                recommendationDiv.style.cssText = 'margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 8px;';
                
                const smartMode = document.getElementById('smart-mode');
                const smartInput = smartMode?.querySelector('.smart-input');
                if (smartInput) {
                    smartInput.insertAdjacentElement('afterend', recommendationDiv);
                }
            }
            
            const hasRecommendations = recommendations.length > 0 || suggestedCategory !== 'å…¶ä»–ç‰©å“' || suggestedLocation !== 'å…¶ä»–ä½ç½®';
            
            if (!hasRecommendations) {
                recommendationDiv.style.display = 'none';
                return;
            }
            
            recommendationDiv.style.display = 'block';
            recommendationDiv.innerHTML = `
                <h5 style="margin-bottom: 10px; color: #1976d2; font-size: 14px;">ğŸ’¡ æ™ºèƒ½æ¨è</h5>
                ${recommendations.length > 0 ? `
                    <div style="margin-bottom: 10px;">
                        <span style="font-size: 12px; color: #666;">å¸¸ç”¨æœç´¢ï¼š</span>
                        ${recommendations.map(keyword => `
                            <span onclick="insertRecommendation('${keyword}')" style="display: inline-block; background: white; color: #1976d2; padding: 4px 8px; border-radius: 12px; margin: 2px; cursor: pointer; font-size: 12px; border: 1px solid #1976d2;">${keyword}</span>
                        `).join('')}
                    </div>
                ` : ''}
                ${suggestedCategory !== 'å…¶ä»–ç‰©å“' ? `
                    <div style="margin-bottom: 5px; font-size: 12px;">
                        <span style="color: #666;">æ¨èåˆ†ç±»ï¼š</span>
                        <span style="color: #1976d2; font-weight: bold;">${suggestedCategory}</span>
                    </div>
                ` : ''}
                ${suggestedLocation !== 'å…¶ä»–ä½ç½®' ? `
                    <div style="font-size: 12px;">
                        <span style="color: #666;">æ¨èä½ç½®ï¼š</span>
                        <span style="color: #1976d2; font-weight: bold;">${suggestedLocation}</span>
                    </div>
                ` : ''}
            `;
        }
        
        // æ’å…¥æ¨èå…³é”®è¯
        function insertRecommendation(keyword) {
            const textarea = document.getElementById('smart-input-text');
            if (textarea) {
                const currentValue = textarea.value;
                const newValue = currentValue ? currentValue + '\n' + keyword : keyword;
                textarea.value = newValue;
                textarea.focus();
            }
        }
    </script>
</body>
</html>