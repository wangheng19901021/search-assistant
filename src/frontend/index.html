<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="寻物助手">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiM2NjdlZWEiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+CjxjaXJjbGUgY3g9IjExIiBjeT0iMTEiIHI9IjgiLz4KPHN0cm9rZS1kYXNoYXJyYXkgPSJub25lIi8+CjxwYXRoIGQ9Im0yMSAyMS00LjM1LTQuMzUiLz4KPC9zdmc+Cjwvc3ZnPgo=">
    <title>寻物助手</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif; background: #f5f5f5; }
        .container { max-width: 400px; margin: 0 auto; background: white; min-height: 100vh; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; }
        .tab-bar { display: flex; background: white; border-bottom: 1px solid #eee; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; color: #666; }
        .tab.active { color: #667eea; border-bottom: 2px solid #667eea; }
        .content { padding: 15px; }
        .search-container { margin-bottom: 15px; }
        .search-input-wrapper { position: relative; display: flex; align-items: center; background: white; border-radius: 25px; border: 1px solid #ddd; padding: 5px; }
        .search-box { flex: 1; border: none; outline: none; padding: 10px 15px; border-radius: 20px; font-size: 16px; }
        .voice-search-btn, .camera-search-btn { background: none; border: none; padding: 8px; border-radius: 50%; cursor: pointer; font-size: 18px; transition: background 0.2s; }
        .voice-search-btn:hover, .camera-search-btn:hover { background: rgba(102, 126, 234, 0.1); }
        .voice-search-btn.recording { background: #ff4444; color: white; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .search-suggestions, .search-history { background: white; border: 1px solid #ddd; border-radius: 8px; max-height: 200px; overflow-y: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: absolute; top: 100%; left: 0; right: 0; z-index: 100; }
        .suggestion-item, .history-item { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .suggestion-item:hover, .history-item:hover { background: #f8f9fa; }
        .suggestion-item:last-child, .history-item:last-child { border-bottom: none; }
        .suggestion-type { font-size: 12px; color: #666; background: #e9ecef; padding: 2px 6px; border-radius: 10px; }
        
        /* 快速添加悬浮按钮 */
        .quick-add-fab { position: fixed; bottom: 80px; right: 20px; width: 56px; height: 56px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); cursor: pointer; z-index: 100; transition: transform 0.2s, box-shadow 0.2s; }
        .quick-add-fab:hover { transform: scale(1.1); box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6); }
        .quick-add-fab span { color: white; font-size: 24px; font-weight: bold; }
        
        /* 快速添加模态框 */
        .quick-add-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001; display: none; }
        .quick-add-content { background: white; margin: 20px; border-radius: 12px; padding: 0; max-height: calc(100vh - 40px); overflow-y: auto; }
        .quick-add-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .quick-add-modes { display: flex; background: #f8f9fa; border-bottom: 1px solid #eee; }
        .quick-mode { flex: 1; padding: 12px; text-align: center; cursor: pointer; color: #666; font-size: 14px; }
        .quick-mode.active { background: white; color: #667eea; font-weight: bold; }
        .quick-add-body { padding: 20px; }
        
        /* 智能识别模式 */
        .smart-input { position: relative; }
        .smart-input textarea { width: 100%; padding: 15px; border: 2px dashed #ddd; border-radius: 8px; font-size: 16px; min-height: 120px; resize: vertical; }
        .smart-input.processing textarea { border-color: #667eea; background: #f8f9ff; }
        .smart-suggestions { background: #e3f2fd; border-radius: 8px; padding: 15px; margin-top: 15px; display: none; }
        .smart-suggestions h4 { margin-bottom: 10px; color: #1976d2; }
        .parsed-items { display: flex; flex-direction: column; gap: 10px; }
        .parsed-item { background: white; padding: 12px; border-radius: 6px; border: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .parsed-item.confirmed { border-color: #4caf50; background: #f1f8e9; }
        .parsed-item-info { flex: 1; }
        .parsed-item-name { font-weight: bold; }
        .parsed-item-details { font-size: 12px; color: #666; }
        .parsed-item-actions button { margin-left: 5px; padding: 4px 8px; font-size: 12px; }
        
        /* 连拍模式 */
        .batch-camera { text-align: center; }
        .camera-preview { position: relative; margin: 15px 0; }
        .camera-video { width: 100%; max-width: 300px; border-radius: 8px; }
        .camera-controls { margin: 15px 0; }
        .capture-btn { background: #ff4444; color: white; border: none; padding: 15px 25px; border-radius: 50px; font-size: 16px; cursor: pointer; }
        .capture-btn:hover { background: #cc0000; }
        .captured-images { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .captured-image { position: relative; width: 80px; height: 80px; }
        .captured-image img { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; }
        .captured-image .remove-btn { position: absolute; top: -5px; right: -5px; background: #ff4444; color: white; border: none; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; font-size: 12px; }
        
        /* 移动端手势优化 */
        .swipe-actions { position: absolute; right: 0; top: 0; height: 100%; display: flex; align-items: center; transform: translateX(100%); transition: transform 0.3s ease; z-index: 10; }
        .swipe-actions.show { transform: translateX(0); }
        .swipe-action { background: #ff4444; color: white; padding: 0 20px; height: 100%; display: flex; align-items: center; cursor: pointer; font-size: 14px; white-space: nowrap; }
        .swipe-action.edit { background: #ffc107; }
        .swipe-action.qr { background: #28a745; }
        .item-card { position: relative; overflow: hidden; touch-action: pan-y; }
        .item-card.swiping { transition: transform 0.1s ease; }
        .item-card.swiped { transform: translateX(-120px); }
        
        /* 下拉刷新 */
        .pull-refresh { position: relative; }
        .pull-refresh-indicator { position: absolute; top: -60px; left: 50%; transform: translateX(-50%); background: white; padding: 10px 20px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); font-size: 14px; color: #666; transition: all 0.3s ease; }
        .pull-refresh.pulling .pull-refresh-indicator { top: 10px; }
        .pull-refresh.refreshing .pull-refresh-indicator { top: 10px; color: #667eea; }
        
        /* 双击放大图片 */
        .image-zoom-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1003; display: none; justify-content: center; align-items: center; }
        .image-zoom-modal img { max-width: 90%; max-height: 90%; object-fit: contain; }
        .image-zoom-modal .close-zoom { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; }
        
        /* 快捷操作面板 */
        .quick-actions-panel { 
            position: fixed; 
            bottom: -200px; 
            left: 0; 
            right: 0; 
            background: white; 
            border-radius: 20px 20px 0 0; 
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1); 
            z-index: 101; 
            transition: bottom 0.3s ease; 
            padding: 20px; 
            pointer-events: none; /* 隐藏时不接收点击事件 */
        }
        .quick-actions-panel.show { 
            bottom: 0; 
            pointer-events: auto; /* 显示时接收点击事件 */
        }
        .quick-actions-header { text-align: center; margin-bottom: 20px; color: #333; font-weight: bold; }
        .quick-actions-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .quick-action-item { text-align: center; padding: 15px 10px; border-radius: 12px; background: #f8f9fa; cursor: pointer; transition: all 0.2s; }
        .quick-action-item:hover { background: #e9ecef; transform: scale(1.05); }
        .quick-action-icon { font-size: 24px; margin-bottom: 8px; }
        .quick-action-label { font-size: 12px; color: #666; }
        .item-card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .item-name { font-weight: bold; font-size: 16px; }
        .item-time { color: #999; font-size: 12px; }
        .item-info { color: #666; font-size: 14px; }
        .item-content { display: flex; gap: 10px; }
        .item-image { width: 60px; height: 60px; object-fit: cover; border-radius: 6px; flex-shrink: 0; }
        .item-details { flex: 1; }
        
        .image-upload { margin-bottom: 15px; }
        .image-preview { max-width: 200px; max-height: 200px; margin: 10px 0; border-radius: 8px; display: block; }
        .image-upload-btn { display: inline-block; padding: 8px 16px; background: #28a745; color: white; border-radius: 4px; cursor: pointer; margin-right: 10px; text-decoration: none; }
        .image-upload-btn:hover { background: #218838; }
        .image-remove-btn { background: #dc3545; padding: 6px 12px; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .image-remove-btn:hover { background: #c82333; }
        
        .detail-row { margin-bottom: 10px; padding: 8px 0; border-bottom: 1px solid #f0f0f0; }
        .detail-label { font-weight: bold; color: #333; display: inline-block; min-width: 80px; }
        .detail-actions { display: flex; gap: 10px; }
        .detail-actions .btn { flex: 1; }
        .item-card { cursor: pointer; transition: transform 0.2s; }
        .item-card:hover { transform: translateY(-2px); }
        
        .stats-overview { display: flex; gap: 10px; margin-bottom: 20px; }
        .stat-card { flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-number { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 12px; opacity: 0.9; }
        .charts-container { display: flex; flex-direction: column; gap: 20px; }
        .chart-section { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .chart-section h4 { margin-bottom: 15px; color: #333; font-size: 16px; }
        .chart-section canvas { max-width: 100%; height: 200px !important; display: block; margin: 0 auto; }
        .chart-container { position: relative; height: 200px; width: 100%; }
        
        .search-filters { background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid #dee2e6; }
        .filter-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-end; }
        .filter-item { flex: 1; }
        .filter-item label { display: block; font-size: 12px; color: #666; margin-bottom: 5px; }
        .filter-item select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .btn-link { background: none; border: none; color: #667eea; cursor: pointer; font-size: 14px; text-decoration: underline; }
        .btn-link:hover { color: #5a6fd8; }
        
        .batch-operations { background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid #dee2e6; }
        .batch-row { display: flex; gap: 10px; }
        .btn-export, .btn-import { border: none; border-radius: 6px; cursor: pointer; color: white; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; }
        .btn-export:hover { background: #218838 !important; }
        .btn-import:hover { background: #138496 !important; }
        
        .history-item { border-left: 3px solid #667eea; padding: 12px 15px; margin-bottom: 10px; background: #f8f9fa; border-radius: 0 6px 6px 0; }
        .history-item.create { border-left-color: #28a745; }
        .history-item.update { border-left-color: #ffc107; }
        .history-item.delete { border-left-color: #dc3545; }
        .history-action { font-weight: bold; color: #333; margin-bottom: 5px; }
        .history-time { font-size: 12px; color: #666; margin-bottom: 8px; }
        .history-changes { font-size: 14px; color: #555; }
        .history-change { margin-bottom: 4px; }
        .history-old { background: #ffe6e6; padding: 2px 6px; border-radius: 3px; text-decoration: line-through; }
        .history-new { background: #e6ffe6; padding: 2px 6px; border-radius: 3px; }
        
        .btn { background: #667eea; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 10px; }
        .btn:hover { background: #5a6fd8; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #333; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; margin: 50px auto; padding: 20px; width: 90%; max-width: 400px; border-radius: 8px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .close { background: none; border: none; font-size: 24px; cursor: pointer; }
        .location-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .location-actions button { margin-left: 8px; padding: 6px 12px; font-size: 12px; }
        .btn-danger { background: #ff6b6b; }
        .btn-secondary { background: #6c757d; }
        .empty-state { text-align: center; padding: 40px; color: #999; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔍 寻物助手</h1>
            <p>让物品管理变得简单</p>
        </div>

        <div class="tab-bar">
            <div class="tab active" onclick="showTab('items')">物品</div>
            <div class="tab" onclick="showTab('categories')">分类</div>
            <div class="tab" onclick="showTab('locations')">位置</div>
            <div class="tab" onclick="showTab('statistics')">统计</div>
            <div class="tab" onclick="showTab('add')">添加</div>
        </div>
        
        <!-- 快速添加悬浮按钮 -->
        <div class="quick-add-fab" onclick="showQuickAddModal()" title="快速添加">
            <span>+</span>
        </div>

        <!-- 物品列表页面 -->
        <div id="items-page" class="content">
            <div class="search-container">
                <div class="search-input-wrapper">
                    <input type="text" class="search-box" placeholder="搜索物品、分类或位置..." id="search-input">
                    <button class="voice-search-btn" onclick="startVoiceSearch()" title="语音搜索">🎤</button>
                    <button class="camera-search-btn" onclick="startCameraSearch()" title="扫码搜索">📷</button>
                </div>
                <div id="search-suggestions" class="search-suggestions" style="display: none;"></div>
                <div id="search-history" class="search-history" style="display: none;"></div>
            </div>
            
            <!-- 高级搜索过滤器 -->
            <div class="search-filters" id="search-filters" style="display: none;">
                <div class="filter-row">
                    <div class="filter-item">
                        <label>分类:</label>
                        <select id="filter-category">
                            <option value="">全部分类</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>位置:</label>
                        <select id="filter-location">
                            <option value="">全部位置</option>
                        </select>
                    </div>
                </div>
                <div class="filter-row">
                    <div class="filter-item">
                        <label>排序:</label>
                        <select id="filter-sort">
                            <option value="time-desc">最新添加</option>
                            <option value="time-asc">最早添加</option>
                            <option value="name-asc">名称 A-Z</option>
                            <option value="name-desc">名称 Z-A</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <button class="btn btn-secondary" onclick="clearFilters()" style="background: #6c757d; margin-top: 10px; padding: 8px 16px; font-size: 12px;">清除筛选</button>
                    </div>
                </div>
            </div>
            
            <div class="search-toggle" style="text-align: center; margin-bottom: 15px;">
                <button class="btn-link" onclick="toggleSearchFilters()" id="filter-toggle">🔍 高级搜索</button>
                <span style="margin: 0 10px;">|</span>
                <button class="btn-link" onclick="toggleBatchOperations()" id="batch-toggle">📋 批量操作</button>
            </div>
            
            <!-- 批量操作区域 -->
            <div class="batch-operations" id="batch-operations" style="display: none;">
                <div class="batch-row">
                    <button class="btn btn-export" onclick="exportItems()" style="background: #28a745; flex: 1; margin-right: 5px; padding: 10px; font-size: 14px;">📤 导出数据</button>
                    <label for="import-file-input" class="btn btn-import" style="background: #17a2b8; flex: 1; margin-left: 5px; padding: 10px; font-size: 14px; text-align: center; cursor: pointer;">📥 导入数据</label>
                    <input type="file" id="import-file-input" accept=".csv,.json" style="display: none;">
                </div>
                <div class="batch-info" style="margin-top: 10px; font-size: 12px; color: #666; text-align: center;">
                    支持CSV和JSON格式的导入导出
                </div>
            </div>
            
            <div id="items-list">
                <div class="empty-state">
                    <p>暂无物品记录</p>
                    <p>点击"添加"开始管理您的物品</p>
                </div>
            </div>
        </div>

        <!-- 分类管理页面 -->
        <div id="categories-page" class="content" style="display:none;">
            <button class="btn" onclick="showAddCategoryModal()">+ 添加分类</button>
            <div id="categories-list" style="margin-top: 15px;">
                <div class="empty-state">
                    <p>正在加载分类...</p>
                </div>
            </div>
        </div>

        <!-- 位置管理页面 -->
        <div id="locations-page" class="content" style="display:none;">
            <button class="btn" onclick="showAddLocationModal()">+ 添加位置</button>
            <div id="locations-list" style="margin-top: 15px;">
                <div class="empty-state">
                    <p>暂无位置记录</p>
                    <p>先添加位置，再管理物品</p>
                </div>
            </div>
        </div>

        <!-- 统计页面 -->
        <div id="statistics-page" class="content" style="display:none;">
            <h3 style="margin-bottom: 20px; color: #333;">📊 数据统计</h3>
            
            <!-- 概览卡片 -->
            <div class="stats-overview">
                <div class="stat-card">
                    <div class="stat-number" id="total-items">0</div>
                    <div class="stat-label">总物品数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-categories">0</div>
                    <div class="stat-label">分类数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-locations">0</div>
                    <div class="stat-label">位置数</div>
                </div>
            </div>

            <!-- 图表区域 -->
            <div class="charts-container">
                <div class="chart-section">
                    <h4>按分类统计</h4>
                    <div class="chart-container">
                        <canvas id="category-chart"></canvas>
                    </div>
                </div>
                <div class="chart-section">
                    <h4>按位置统计</h4>
                    <div class="chart-container">
                        <canvas id="location-chart"></canvas>
                    </div>
                </div>
                <div class="chart-section">
                    <h4>最近添加趋势</h4>
                    <div class="chart-container">
                        <canvas id="trend-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 添加物品页面 -->
        <div id="add-page" class="content" style="display:none;">
            <form id="add-item-form">
                <div class="form-group">
                    <label>物品名称</label>
                    <input type="text" id="item-name" required>
                </div>
                <div class="form-group">
                    <label>分类</label>
                    <select id="item-category" required>
                        <option value="">请选择分类</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>位置</label>
                    <select id="item-location" required>
                        <option value="">请选择位置</option>
                    </select>
                </div>
                <div class="form-group image-upload">
                    <label>物品图片</label>
                    <div>
                        <label for="image-input" class="image-upload-btn">📷 选择图片</label>
                        <input type="file" id="image-input" accept="image/*" style="display: none;">
                        <img id="image-preview" class="image-preview" style="display: none;">
                        <button type="button" id="image-remove" class="image-remove-btn" style="display: none;">移除图片</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>描述</label>
                    <textarea id="item-description" rows="3"></textarea>
                </div>
                <button type="submit" class="btn">添加物品</button>
            </form>
        </div>
    </div>

    <!-- 物品详情模态框 -->
    <div id="item-detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>物品详情</h3>
                <button class="close" onclick="closeItemDetailModal()">&times;</button>
            </div>
            <div id="item-detail-content">
                <div class="item-detail-image" id="detail-image-container" style="text-align: center; margin-bottom: 15px;">
                    <img id="detail-image" style="max-width: 100%; max-height: 200px; border-radius: 8px; display: none;">
                </div>
                <div class="item-detail-info">
                    <div class="detail-row">
                        <span class="detail-label">名称：</span>
                        <span id="detail-name"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">分类：</span>
                        <span id="detail-category"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">位置：</span>
                        <span id="detail-location"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">描述：</span>
                        <span id="detail-description"></span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">更新时间：</span>
                        <span id="detail-time"></span>
                    </div>
                </div>
                <div class="detail-actions" style="margin-top: 20px;">
                    <button class="btn" onclick="editItem()" style="margin-right: 10px;">编辑</button>
                    <button class="btn" onclick="showItemQR()" style="background: #28a745; margin-right: 10px;">二维码</button>
                    <button class="btn" onclick="toggleItemHistory()" id="history-toggle" style="background: #6c757d;">历史记录</button>
                </div>
                
                <!-- 历史记录区域 -->
                <div id="item-history" style="display: none; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                    <h4 style="margin-bottom: 15px; color: #333; font-size: 16px;">📋 变更历史</h4>
                    <div id="history-list" style="max-height: 300px; overflow-y: auto;">
                        <div class="loading-history" style="text-align: center; padding: 20px; color: #666;">
                            正在加载历史记录...
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 编辑表单 -->
            <div id="item-edit-form" style="display: none;">
                <form id="edit-form">
                    <div class="form-group">
                        <label>物品名称</label>
                        <input type="text" id="edit-name" required>
                    </div>
                    <div class="form-group">
                        <label>分类</label>
                        <select id="edit-category" required>
                            <option value="">请选择分类</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>位置</label>
                        <select id="edit-location" required>
                            <option value="">请选择位置</option>
                        </select>
                    </div>
                    <div class="form-group image-upload">
                        <label>物品图片</label>
                        <div>
                            <label for="edit-image-input" class="image-upload-btn">📷 更换图片</label>
                            <input type="file" id="edit-image-input" accept="image/*" style="display: none;">
                            <img id="edit-image-preview" class="image-preview" style="display: none;">
                            <button type="button" id="edit-image-remove" class="image-remove-btn" style="display: none;">移除图片</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>描述</label>
                        <textarea id="edit-description" rows="3"></textarea>
                    </div>
                    <div class="detail-actions">
                        <button type="submit" class="btn" style="margin-right: 10px;">保存</button>
                        <button type="button" class="btn btn-secondary" onclick="cancelEdit()">取消</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 二维码显示模态框 -->
    <div id="qr-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>物品二维码</h3>
                <button class="close" onclick="closeQRModal()">&times;</button>
            </div>
            <div class="qr-content" style="text-align: center; padding: 20px;">
                <div id="qr-item-info" style="margin-bottom: 15px;">
                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;" id="qr-item-name"></div>
                    <div style="color: #666; font-size: 14px;" id="qr-item-desc"></div>
                </div>
                <canvas id="qr-canvas" style="border: 1px solid #ddd; border-radius: 8px;"></canvas>
                <div style="margin-top: 15px; color: #666; font-size: 12px;">
                    <p>打印此二维码并贴在物品上</p>
                    <p>扫码即可快速查看物品信息</p>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn" onclick="downloadQR()" style="margin-right: 10px; width: auto; padding: 8px 20px;">下载二维码</button>
                    <button class="btn" onclick="printQR()" style="background: #28a745; width: auto; padding: 8px 20px;">打印标签</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加分类模态框 -->
    <div id="category-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加分类</h3>
                <button class="close" onclick="closeCategoryModal()">&times;</button>
            </div>
            <form id="add-category-form">
                <div class="form-group">
                    <label>分类名称</label>
                    <input type="text" id="category-name" required placeholder="请输入分类名称">
                </div>
                <button type="submit" class="btn">添加</button>
            </form>
        </div>
    </div>

    <!-- 添加位置模态框 -->
    <div id="location-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加位置</h3>
                <button class="close" onclick="closeLocationModal()">&times;</button>
            </div>
            <form id="add-location-form">
                <div class="form-group">
                    <label>位置名称</label>
                    <input type="text" id="location-name" required>
                </div>
                <div class="form-group">
                    <label>图标</label>
                    <select id="location-icon">
                        <option value="📦">📦 盒子</option>
                        <option value="🏠">🏠 房屋</option>
                        <option value="🚗">🚗 汽车</option>
                        <option value="💼">💼 公文包</option>
                        <option value="👜">👜 手提包</option>
                        <option value="🎒">🎒 背包</option>
                    </select>
                </div>
                <button type="submit" class="btn">添加</button>
            </form>
        </div>
    </div>

    <!-- 快速添加模态框 -->
    <div id="quick-add-modal" class="quick-add-modal">
        <div class="quick-add-content">
            <div class="quick-add-header">
                <h3>🚀 快速添加</h3>
                <button class="close" onclick="closeQuickAddModal()">&times;</button>
            </div>
            
            <div class="quick-add-modes">
                <div class="quick-mode active" onclick="switchQuickMode('smart')">🤖 智能识别</div>
                <div class="quick-mode" onclick="switchQuickMode('camera')">📷 连拍模式</div>
                <div class="quick-mode" onclick="switchQuickMode('voice')">🎤 语音录入</div>
            </div>
            
            <div class="quick-add-body">
                <!-- 智能识别模式 -->
                <div id="smart-mode" class="quick-mode-content">
                    <div class="smart-input">
                        <textarea id="smart-input-text" placeholder="请描述您要添加的物品，例如：
在客厅的iPhone 15，白色的，电子产品
在书房的《三体》小说，科幻类书籍
在厨房的不锈钢锅，生活用品

支持多行输入，系统会智能识别和分类您的物品信息。"></textarea>
                    </div>
                    <div class="smart-suggestions" id="smart-suggestions">
                        <h4>🎯 识别结果</h4>
                        <div class="parsed-items" id="parsed-items"></div>
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn" onclick="processSmartInput()" style="width: auto; padding: 12px 30px;">🤖 智能识别</button>
                        <button class="btn" onclick="confirmSmartItems()" id="confirm-smart-btn" style="background: #28a745; width: auto; padding: 12px 30px; margin-left: 10px; display: none;">✓ 确认添加</button>
                    </div>
                </div>
                
                <!-- 连拍模式 -->
                <div id="camera-mode" class="quick-mode-content" style="display: none;">
                    <div class="batch-camera">
                        <p style="color: #666; margin-bottom: 15px;">📷 连续拍照多个物品，系统会自动识别并生成记录</p>
                        <div class="camera-preview">
                            <video id="quick-camera-video" class="camera-video" style="display: none;"></video>
                            <canvas id="quick-camera-canvas" style="display: none;"></canvas>
                        </div>
                        <div class="camera-controls">
                            <button class="capture-btn" onclick="startQuickCamera()" id="start-camera-btn">📷 启动摄像头</button>
                            <button class="capture-btn" onclick="captureQuickPhoto()" id="capture-btn" style="display: none;">📸 拍照</button>
                        </div>
                        <div class="captured-images" id="captured-images"></div>
                        <div style="margin-top: 20px; text-align: center;" id="camera-actions" style="display: none;">
                            <button class="btn" onclick="processQuickPhotos()" style="width: auto; padding: 12px 30px;">🤖 识别照片</button>
                        </div>
                    </div>
                </div>
                
                <!-- 语音录入模式 -->
                <div id="voice-mode" class="quick-mode-content" style="display: none;">
                    <div style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">🎤</div>
                        <h3 style="margin-bottom: 15px;">语音快速录入</h3>
                        <p style="color: #666; margin-bottom: 30px;">按住下方按钮说话，描述您要添加的物品</p>
                        <button class="capture-btn" onclick="startQuickVoiceInput()" id="voice-input-btn" style="background: #667eea; padding: 20px 40px; font-size: 18px;">🎤 开始录音</button>
                        <div id="voice-result" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none;">
                            <h4>语音识别结果：</h4>
                            <p id="voice-text" style="margin: 10px 0; font-size: 16px;"></p>
                            <button class="btn" onclick="processVoiceResult()" style="width: auto; padding: 10px 20px;">转为物品信息</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 图片放大模态框 -->
    <div id="image-zoom-modal" class="image-zoom-modal">
        <img id="zoom-image" src="" alt="放大图片">
        <button class="close-zoom" onclick="closeImageZoom()">×</button>
    </div>

    <!-- 快捷操作面板 -->
    <div id="quick-actions-panel" class="quick-actions-panel" onclick="hideQuickActionsPanel()">
        <div class="quick-actions-header" onclick="event.stopPropagation()">
            快捷操作
            <button onclick="hideQuickActionsPanel(); event.stopPropagation();" style="float: right; background: none; border: none; font-size: 18px; cursor: pointer;">×</button>
        </div>
        <div class="quick-actions-grid" onclick="event.stopPropagation()">
            <div class="quick-action-item" onclick="showQuickAddModal(); hideQuickActionsPanel();">
                <div class="quick-action-icon">➕</div>
                <div class="quick-action-label">快速添加</div>
            </div>
            <div class="quick-action-item" onclick="startVoiceSearch(); hideQuickActionsPanel();">
                <div class="quick-action-icon">🎤</div>
                <div class="quick-action-label">语音搜索</div>
            </div>
            <div class="quick-action-item" onclick="startCameraSearch(); hideQuickActionsPanel();">
                <div class="quick-action-icon">📷</div>
                <div class="quick-action-label">扫码搜索</div>
            </div>
            <div class="quick-action-item" onclick="exportItems(); hideQuickActionsPanel();">
                <div class="quick-action-icon">💾</div>
                <div class="quick-action-label">导出数据</div>
            </div>
            <div class="quick-action-item" onclick="showTab('statistics'); hideQuickActionsPanel();">
                <div class="quick-action-icon">📊</div>
                <div class="quick-action-label">查看统计</div>
            </div>
            <div class="quick-action-item" onclick="toggleSearchFilters(); hideQuickActionsPanel();">
                <div class="quick-action-icon">🔍</div>
                <div class="quick-action-label">高级搜索</div>
            </div>
            <div class="quick-action-item" onclick="refreshAllData(); hideQuickActionsPanel();">
                <div class="quick-action-icon">🔄</div>
                <div class="quick-action-label">刷新数据</div>
            </div>
            <div class="quick-action-item" onclick="showBackupManager(); hideQuickActionsPanel();">
                <div class="quick-action-icon">💾</div>
                <div class="quick-action-label">数据备份</div>
            </div>
            <div class="quick-action-item" onclick="showAppInfo(); hideQuickActionsPanel();">
                <div class="quick-action-icon">ℹ️</div>
                <div class="quick-action-label">应用信息</div>
            </div>
            <div class="quick-action-item" onclick="performanceMonitor.showPerformanceReport(); hideQuickActionsPanel();">
                <div class="quick-action-icon">📊</div>
                <div class="quick-action-label">性能报告</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        let currentUser = { userId: 10001 }; // 模拟用户ID
        let currentImageUrl = null; // 当前上传的图片URL
        let isServerAvailable = false; // 服务器可用性标志

        // 检查服务器连接状态
        async function checkServerConnection() {
            try {
                const response = await fetch(`${API_BASE}/health`, { 
                    method: 'GET',
                    timeout: 3000 // 3秒超时
                });
                isServerAvailable = response.ok;
                return isServerAvailable;
            } catch (error) {
                console.log('后端服务器未连接，将使用演示模式');
                isServerAvailable = false;
                return false;
            }
        }

        // 显示连接状态提示
        function showConnectionStatus() {
            if (!isServerAvailable) {
                const statusDiv = document.createElement('div');
                statusDiv.innerHTML = `
                    <div style="position: fixed; top: 10px; left: 10px; right: 10px; background: #ffc107; color: #856404; padding: 12px; border-radius: 8px; z-index: 1005; text-align: center; font-size: 14px;">
                        ⚠️ 演示模式 - 后端服务器未启动，部分功能将使用模拟数据
                        <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; color: #856404; cursor: pointer;">×</button>
                    </div>
                `;
                document.body.appendChild(statusDiv);
                
                // 10秒后自动消失
                setTimeout(() => {
                    if (statusDiv.parentNode) {
                        statusDiv.remove();
                    }
                }, 10000);
            }
        }

        // 初始化时检查连接
        window.addEventListener('load', async () => {
            // 检查是否通过文件协议访问
            if (location.protocol === 'file:') {
                showLocalFileWarning();
                return;
            }
            
            await checkServerConnection();
            showConnectionStatus();
        });

        // 安全的API调用包装函数
        async function safeApiCall(url, options = {}) {
            if (!isServerAvailable) {
                // 返回模拟数据
                return {
                    success: true,
                    data: getMockData(url),
                    message: '演示模式数据'
                };
            }
            
            try {
                const response = await fetch(url, options);
                return await response.json();
            } catch (error) {
                console.error('API调用失败:', error);
                return {
                    success: false,
                    message: '网络连接失败',
                    data: null
                };
            }
        }

        // 获取模拟数据
        function getMockData(url) {
            if (url.includes('/item/list')) {
                return {
                    items: [
                        {
                            itemId: 1,
                            name: 'iPhone 15',
                            category: '电子产品',
                            location: '客厅',
                            description: '白色，128GB',
                            imageUrl: null,
                            lastUpdateTime: new Date().toISOString()
                        },
                        {
                            itemId: 2,
                            name: '《三体》',
                            category: '书籍文具',
                            location: '书房',
                            description: '刘慈欣科幻小说',
                            imageUrl: null,
                            lastUpdateTime: new Date(Date.now() - 86400000).toISOString()
                        }
                    ]
                };
            } else if (url.includes('/category/list')) {
                return [
                    { categoryId: 1, name: '电子产品', isSystem: true },
                    { categoryId: 2, name: '书籍文具', isSystem: true },
                    { categoryId: 3, name: '生活用品', isSystem: true }
                ];
            } else if (url.includes('/location/list')) {
                return [
                    { locationId: 1, name: '客厅', icon: '🛋️' },
                    { locationId: 2, name: '书房', icon: '📚' },
                    { locationId: 3, name: '卧室', icon: '🛏️' }
                ];
            }
            return null;
        }

        // 显示本地文件访问警告
        function showLocalFileWarning() {
            const warningDiv = document.createElement('div');
            warningDiv.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; max-width: 500px; margin: 20px; border-radius: 12px; padding: 30px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 20px;">⚠️</div>
                        <h2 style="color: #e74c3c; margin-bottom: 20px;">需要通过HTTP服务器访问</h2>
                        <p style="margin-bottom: 20px; line-height: 1.6; color: #555;">
                            您正在通过本地文件方式访问应用，这会导致以下功能无法正常工作：<br>
                            • Service Worker (PWA功能)<br>
                            • 语音识别<br>
                            • 摄像头访问<br>
                            • 后端API连接
                        </p>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left;">
                            <strong>🚀 正确启动方式：</strong><br>
                            <code style="background: #e9ecef; padding: 2px 6px; border-radius: 4px; font-family: monospace;">
                                cd /mnt/f/Work\\ Space/Search\\ Assistant<br>
                                ./start.sh
                            </code><br>
                            然后访问: <a href="http://localhost:8080/index.html" target="_blank">http://localhost:8080/index.html</a>
                        </div>
                        <button onclick="this.closest('div').parentElement.remove()" style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px;">
                            我知道了，继续演示
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(warningDiv);
        }

        // DOM 安全访问工具函数
        function safeGetElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`Element with id '${id}' not found`);
                return null;
            }
            return element;
        }

        // 安全的DOM操作函数
        function safeSetTextContent(id, content) {
            const element = safeGetElement(id);
            if (element) {
                element.textContent = content;
            }
        }

        function safeSetStyle(id, property, value) {
            const element = safeGetElement(id);
            if (element) {
                element.style[property] = value;
            }
        }

        function safeAddEventListener(id, event, handler) {
            const element = safeGetElement(id);
            if (element) {
                element.addEventListener(event, handler);
            }
        }

        function safeSetValue(id, value) {
            const element = safeGetElement(id);
            if (element) {
                element.value = value;
            }
        }

        function safeGetValue(id) {
            const element = safeGetElement(id);
            return element ? element.value : '';
        }

        function safeSetInnerHTML(id, html) {
            const element = safeGetElement(id);
            if (element) {
                element.innerHTML = html;
            }
        }

        function safeSetSrc(id, src) {
            const element = safeGetElement(id);
            if (element) {
                element.src = src;
            }
        }

        // 全局错误处理机制
        function handleAsyncError(error, context = 'Unknown operation') {
            console.error(`异步操作错误 [${context}]:`, error);
            
            // 显示用户友好的错误信息
            if (error.name === 'TypeError' && error.message.includes('fetch')) {
                showToast('❌ 网络连接失败，请检查网络设置', 3000);
            } else if (error.name === 'SyntaxError') {
                showToast('❌ 数据格式错误，请重试', 3000);
            } else {
                showToast(`❌ 操作失败: ${error.message || '未知错误'}`, 3000);
            }
            
            return false;
        }

        // 安全的异步函数包装器
        function safeAsync(asyncFn, context) {
            return async function(...args) {
                try {
                    return await asyncFn.apply(this, args);
                } catch (error) {
                    return handleAsyncError(error, context);
                }
            };
        }

        // DOM操作错误处理包装
        function safeDOMOperation(operation, context = 'DOM operation') {
            try {
                return operation();
            } catch (error) {
                console.warn(`DOM操作失败 [${context}]:`, error);
                return null;
            }
        }

        // 性能优化工具
        class PerformanceOptimizer {
            constructor() {
                this.intersectionObserver = null;
                this.lazyElements = new Set();
                this.initLazyLoading();
                this.initPerformanceMonitoring();
            }

            // 初始化懒加载
            initLazyLoading() {
                if ('IntersectionObserver' in window) {
                    this.intersectionObserver = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                this.loadLazyElement(entry.target);
                                this.intersectionObserver.unobserve(entry.target);
                            }
                        });
                    }, { threshold: 0.1 });
                }
            }

            // 添加懒加载元素
            addLazyElement(element) {
                if (this.intersectionObserver) {
                    this.lazyElements.add(element);
                    this.intersectionObserver.observe(element);
                }
            }

            // 加载懒加载元素
            loadLazyElement(element) {
                if (element.dataset.src) {
                    element.src = element.dataset.src;
                    element.removeAttribute('data-src');
                }
                if (element.dataset.action) {
                    // 执行延迟操作
                    const action = new Function(element.dataset.action);
                    action();
                    element.removeAttribute('data-action');
                }
                this.lazyElements.delete(element);
            }

            // 初始化性能监控
            initPerformanceMonitoring() {
                // 监控页面加载性能
                if ('performance' in window && 'getEntriesByType' in performance) {
                    window.addEventListener('load', () => {
                        setTimeout(() => {
                            const perfData = performance.getEntriesByType('navigation')[0];
                            if (perfData) {
                                console.log('页面性能数据:', {
                                    DNS查询: Math.round(perfData.domainLookupEnd - perfData.domainLookupStart),
                                    连接时间: Math.round(perfData.connectEnd - perfData.connectStart),
                                    响应时间: Math.round(perfData.responseEnd - perfData.responseStart),
                                    DOM解析: Math.round(perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart),
                                    总加载时间: Math.round(perfData.loadEventEnd - perfData.navigationStart)
                                });
                            }
                        }, 1000);
                    });
                }
            }

            // 内存使用监控
            getMemoryUsage() {
                if ('memory' in performance) {
                    return {
                        used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024),
                        total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024),
                        limit: Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024)
                    };
                }
                return null;
            }

            // 清理未使用的资源
            cleanup() {
                if (this.intersectionObserver) {
                    this.intersectionObserver.disconnect();
                }
                this.lazyElements.clear();
            }
        }

        // 节流函数优化
        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        // 防抖函数优化 (已存在但可能需要优化)
        function debounce(func, delay) {
            let timeoutId;
            return function (...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // 批量DOM更新优化
        class DOMBatchUpdater {
            constructor() {
                this.updates = [];
                this.scheduled = false;
            }

            // 添加更新任务
            addUpdate(updateFn) {
                this.updates.push(updateFn);
                if (!this.scheduled) {
                    this.scheduled = true;
                    requestAnimationFrame(() => this.flush());
                }
            }

            // 执行批量更新
            flush() {
                const updates = this.updates.slice();
                this.updates.length = 0;
                this.scheduled = false;
                
                updates.forEach(update => {
                    try {
                        update();
                    } catch (error) {
                        console.warn('批量更新失败:', error);
                    }
                });
            }
        }

        // 初始化性能优化器
        const performanceOptimizer = new PerformanceOptimizer();
        const domBatchUpdater = new DOMBatchUpdater();

        // 应用性能监控和优化
        class ApplicationPerformanceMonitor {
            constructor() {
                this.metrics = {
                    pageLoad: 0,
                    apiCalls: 0,
                    domOperations: 0,
                    errors: 0,
                    memoryUsage: []
                };
                this.startTime = performance.now();
                this.initMonitoring();
            }

            // 初始化监控
            initMonitoring() {
                // 监控API调用
                this.wrapFetch();
                
                // 定期检查内存使用
                setInterval(() => {
                    const memory = performanceOptimizer.getMemoryUsage();
                    if (memory) {
                        this.metrics.memoryUsage.push({
                            timestamp: Date.now(),
                            ...memory
                        });
                        // 保留最近100条记录
                        if (this.metrics.memoryUsage.length > 100) {
                            this.metrics.memoryUsage = this.metrics.memoryUsage.slice(-100);
                        }
                    }
                }, 30000); // 每30秒检查一次

                // 监控长任务
                if ('PerformanceObserver' in window) {
                    try {
                        const observer = new PerformanceObserver((list) => {
                            for (const entry of list.getEntries()) {
                                if (entry.duration > 50) { // 超过50ms的任务
                                    console.warn('检测到长任务:', {
                                        name: entry.name,
                                        duration: Math.round(entry.duration),
                                        startTime: Math.round(entry.startTime)
                                    });
                                }
                            }
                        });
                        observer.observe({ entryTypes: ['longtask'] });
                    } catch (e) {
                        console.log('长任务监控不支持');
                    }
                }
            }

            // 包装fetch以监控API调用
            wrapFetch() {
                const originalFetch = window.fetch;
                const self = this;
                
                window.fetch = async function(...args) {
                    const startTime = performance.now();
                    self.metrics.apiCalls++;
                    
                    try {
                        const response = await originalFetch.apply(this, args);
                        const endTime = performance.now();
                        const duration = endTime - startTime;
                        
                        if (duration > 1000) { // 超过1秒的API调用
                            console.warn('慢速API调用:', {
                                url: args[0],
                                duration: Math.round(duration) + 'ms'
                            });
                        }
                        
                        return response;
                    } catch (error) {
                        self.metrics.errors++;
                        throw error;
                    }
                };
            }

            // 获取性能报告
            getPerformanceReport() {
                const uptime = Math.round((performance.now() - this.startTime) / 1000);
                const currentMemory = performanceOptimizer.getMemoryUsage();
                
                return {
                    运行时间: uptime + '秒',
                    API调用次数: this.metrics.apiCalls,
                    DOM操作次数: this.metrics.domOperations,
                    错误次数: this.metrics.errors,
                    当前内存使用: currentMemory ? `${currentMemory.used}MB / ${currentMemory.total}MB` : '不支持',
                    平均内存使用: this.metrics.memoryUsage.length > 0 ? 
                        Math.round(this.metrics.memoryUsage.reduce((a, b) => a + b.used, 0) / this.metrics.memoryUsage.length) + 'MB' : 
                        '无数据'
                };
            }

            // 显示性能报告
            showPerformanceReport() {
                const report = this.getPerformanceReport();
                const reportText = Object.entries(report)
                    .map(([key, value]) => `${key}: ${value}`)
                    .join('\n');
                
                alert(`📊 应用性能报告\n\n${reportText}`);
            }
        }

        // 初始化性能监控器
        const performanceMonitor = new ApplicationPerformanceMonitor();

        // 图片上传处理
        safeAddEventListener('image-input', 'change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // 验证文件类型
            if (!file.type.startsWith('image/')) {
                alert('请选择图片文件');
                return;
            }

            // 验证文件大小 (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('图片文件大小不能超过5MB');
                return;
            }

            try {
                // 显示预览
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = safeGetElement('image-preview');
                    const removeBtn = safeGetElement('image-remove');
                    if (preview) {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    }
                    if (removeBtn) {
                        removeBtn.style.display = 'inline-block';
                    }
                };
                reader.readAsDataURL(file);

                // 上传到服务器
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${API_BASE}/upload/image`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    currentImageUrl = result.data;
                    console.log('图片上传成功:', currentImageUrl);
                } else {
                    alert('图片上传失败：' + (result.message || '未知错误'));
                    // 清除预览
                    safeSetStyle('image-preview', 'display', 'none');
                    safeSetStyle('image-remove', 'display', 'none');
                    currentImageUrl = null;
                }
            } catch (error) {
                console.error('图片上传失败:', error);
                alert('图片上传失败，请检查网络连接');
                // 清除预览
                safeSetStyle('image-preview', 'display', 'none');
                safeSetStyle('image-remove', 'display', 'none');
                currentImageUrl = null;
            }
        });

        // 移除图片
        safeAddEventListener('image-remove', 'click', function() {
            safeSetStyle('image-preview', 'display', 'none');
            safeSetStyle('image-remove', 'display', 'none');
            const imageInput = safeGetElement('image-input');
            if (imageInput) imageInput.value = '';
            currentImageUrl = null;
        });

        let currentItem = null; // 当前查看的物品
        let editImageUrl = null; // 编辑时的图片URL

        // 显示物品详情
        async function showItemDetail(itemId) {
            try {
                const response = await fetch(`${API_BASE}/item/${itemId}?userId=${currentUser.userId}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    currentItem = result.data;
                    displayItemDetail(currentItem);
                    safeSetStyle('item-detail-modal', 'display', 'block');
                } else {
                    alert('获取物品详情失败');
                }
            } catch (error) {
                console.error('获取物品详情失败:', error);
                alert('获取物品详情失败');
            }
        }

        // 显示物品详情内容
        function displayItemDetail(item) {
            safeSetTextContent('detail-name', item.name || '');
            safeSetTextContent('detail-category', item.category || '');
            safeSetTextContent('detail-location', item.location || '');
            safeSetTextContent('detail-description', item.description || '无');
            safeSetTextContent('detail-time', new Date(item.lastUpdateTime).toLocaleString());
            
            const detailImage = safeGetElement('detail-image');
            if (detailImage) {
                if (item.imageUrl) {
                    detailImage.src = item.imageUrl;
                    detailImage.style.display = 'block';
                } else {
                    detailImage.style.display = 'none';
                }
            }
            
            // 显示详情，隐藏编辑表单
            safeSetStyle('item-detail-content', 'display', 'block');
            safeSetStyle('item-edit-form', 'display', 'none');
        }

        // 关闭物品详情模态框
        function closeItemDetailModal() {
            safeSetStyle('item-detail-modal', 'display', 'none');
            currentItem = null;
        }

        // 编辑物品
        async function editItem() {
            if (!currentItem) return;
            
            // 填充编辑表单
            safeSetValue('edit-name', currentItem.name || '');
            safeSetValue('edit-description', currentItem.description || '');
            
            // 加载分类和位置选项
            await loadEditOptions();
            
            // 设置当前选中的分类和位置
            safeSetValue('edit-category', currentItem.categoryId || '');
            safeSetValue('edit-location', currentItem.locationId || '');
            
            // 显示图片预览
            editImageUrl = currentItem.imageUrl;
            const editPreview = safeGetElement('edit-image-preview');
            const editRemoveBtn = safeGetElement('edit-image-remove');
            if (currentItem.imageUrl && editPreview) {
                editPreview.src = currentItem.imageUrl;
                editPreview.style.display = 'block';
                if (editRemoveBtn) editRemoveBtn.style.display = 'inline-block';
            } else {
                if (editPreview) editPreview.style.display = 'none';
                if (editRemoveBtn) editRemoveBtn.style.display = 'none';
            }
            
            // 切换显示
            safeSetStyle('item-detail-content', 'display', 'none');
            safeSetStyle('item-edit-form', 'display', 'block');
        }

        // 取消编辑
        function cancelEdit() {
            safeSetStyle('item-detail-content', 'display', 'block');
            safeSetStyle('item-edit-form', 'display', 'none');
            editImageUrl = null;
        }

        // 加载编辑表单的选项
        async function loadEditOptions() {
            try {
                // 加载分类
                const categoryResponse = await fetch(`${API_BASE}/category/list?userId=${currentUser.userId}`);
                const categoryResult = await categoryResponse.json();
                const categories = categoryResult.data && Array.isArray(categoryResult.data) ? categoryResult.data : [];
                
                const editCategorySelect = document.getElementById('edit-category');
                editCategorySelect.innerHTML = '<option value="">请选择分类</option>' + 
                    categories.map(cat => `<option value="${cat.categoryId}">${cat.name}${cat.isSystem ? ' (系统)' : ''}</option>`).join('');
                
                // 加载位置
                const locationResponse = await fetch(`${API_BASE}/location/list?userId=${currentUser.userId}`);
                const locationResult = await locationResponse.json();
                const locations = locationResult.data && Array.isArray(locationResult.data) ? locationResult.data : [];
                
                const editLocationSelect = document.getElementById('edit-location');
                editLocationSelect.innerHTML = '<option value="">请选择位置</option>' + 
                    locations.map(loc => `<option value="${loc.locationId}">${loc.icon} ${loc.name}</option>`).join('');
            } catch (error) {
                console.error('加载编辑选项失败:', error);
            }
        }

        // 编辑时的图片上传处理
        document.getElementById('edit-image-input').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // 验证文件类型
            if (!file.type.startsWith('image/')) {
                alert('请选择图片文件');
                return;
            }

            // 验证文件大小 (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('图片文件大小不能超过5MB');
                return;
            }

            try {
                // 显示预览
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('edit-image-preview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    document.getElementById('edit-image-remove').style.display = 'inline-block';
                };
                reader.readAsDataURL(file);

                // 上传到服务器
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch(`${API_BASE}/upload/image`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    editImageUrl = result.data;
                    console.log('编辑图片上传成功:', editImageUrl);
                } else {
                    alert('图片上传失败：' + (result.message || '未知错误'));
                    // 清除预览
                    document.getElementById('edit-image-preview').style.display = 'none';
                    document.getElementById('edit-image-remove').style.display = 'none';
                    editImageUrl = currentItem.imageUrl; // 恢复原图片
                }
            } catch (error) {
                console.error('图片上传失败:', error);
                alert('图片上传失败，请检查网络连接');
                // 清除预览
                document.getElementById('edit-image-preview').style.display = 'none';
                document.getElementById('edit-image-remove').style.display = 'none';
                editImageUrl = currentItem.imageUrl; // 恢复原图片
            }
        });

        // 编辑时移除图片
        document.getElementById('edit-image-remove').addEventListener('click', function() {
            document.getElementById('edit-image-preview').style.display = 'none';
            document.getElementById('edit-image-remove').style.display = 'none';
            document.getElementById('edit-image-input').value = '';
            editImageUrl = null;
        });

        // 保存编辑
        document.getElementById('edit-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentItem) return;
            
            const formData = {
                name: safeGetValue('edit-name'),
                categoryId: parseInt(safeGetValue('edit-category')),
                locationId: parseInt(safeGetValue('edit-location')),
                description: safeGetValue('edit-description'),
                imageUrl: editImageUrl
            };
            
            // 验证表单
            if (!formData.name.trim()) {
                alert('请输入物品名称');
                return;
            }
            if (!formData.categoryId) {
                alert('请选择分类');
                return;
            }
            if (!formData.locationId) {
                alert('请选择位置');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/item/${currentItem.itemId}?userId=${currentUser.userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('更新成功！');
                    // 重新获取物品详情并显示
                    await showItemDetail(currentItem.itemId);
                    // 刷新物品列表
                    loadItems();
                } else {
                    alert('更新失败：' + (result.message || '未知错误'));
                }
            } catch (error) {
                console.error('更新物品失败:', error);
                alert('更新失败，请检查网络连接');
            }
        });

        // QR码显示
        async function showItemQR() {
            if (!currentItem) return;
            
            try {
                // 生成物品信息URL (可以是一个查看物品详情的URL)
                const itemUrl = `${window.location.origin}${window.location.pathname}?item=${currentItem.itemId}`;
                
                // 显示物品信息
                document.getElementById('qr-item-name').textContent = currentItem.name;
                document.getElementById('qr-item-desc').textContent = `${currentItem.category} · ${currentItem.location}`;
                
                // 生成QR码
                const canvas = document.getElementById('qr-canvas');
                await QRCode.toCanvas(canvas, itemUrl, {
                    width: 200,
                    height: 200,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    },
                    errorCorrectionLevel: 'M',
                    margin: 2
                });
                
                // 显示模态框
                document.getElementById('qr-modal').style.display = 'block';
                
            } catch (error) {
                console.error('生成二维码失败:', error);
                alert('生成二维码失败');
            }
        }

        // 关闭QR码模态框
        function closeQRModal() {
            document.getElementById('qr-modal').style.display = 'none';
        }

        // 下载QR码
        function downloadQR() {
            const canvas = document.getElementById('qr-canvas');
            const link = document.createElement('a');
            link.download = `${currentItem.name}_QR码.png`;
            link.href = canvas.toDataURL();
            link.click();
        }

        // 打印QR码
        function printQR() {
            const canvas = document.getElementById('qr-canvas');
            const printWindow = window.open('', '_blank');
            const itemName = currentItem.name;
            const itemDesc = `${currentItem.category} · ${currentItem.location}`;
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>打印物品标签 - ${itemName}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            text-align: center;
                            padding: 20px;
                        }
                        .label {
                            display: inline-block;
                            border: 2px solid #000;
                            padding: 15px;
                            border-radius: 8px;
                            max-width: 300px;
                        }
                        .item-name {
                            font-size: 16px;
                            font-weight: bold;
                            margin-bottom: 8px;
                        }
                        .item-desc {
                            font-size: 12px;
                            color: #666;
                            margin-bottom: 10px;
                        }
                        .qr-code {
                            margin: 10px 0;
                        }
                        .footer {
                            font-size: 10px;
                            color: #999;
                            margin-top: 8px;
                        }
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="label">
                        <div class="item-name">${itemName}</div>
                        <div class="item-desc">${itemDesc}</div>
                        <div class="qr-code">
                            <img src="${canvas.toDataURL()}" alt="QR Code" style="width: 120px; height: 120px;">
                        </div>
                        <div class="footer">寻物助手 · 扫码查看详情</div>
                    </div>
                    <div class="no-print" style="margin-top: 20px;">
                        <button onclick="window.print()">打印</button>
                        <button onclick="window.close()">关闭</button>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
        }

        // 标签页切换 - 修复版本
        function showTab(tab) {
            // 隐藏所有内容页面
            document.querySelectorAll('.content').forEach(page => {
                page.style.display = 'none';
            });
            
            // 移除所有标签的激活状态
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            // 显示选中的页面
            const targetPage = document.getElementById(tab + '-page');
            if (targetPage) {
                targetPage.style.display = 'block';
            }
            
            // 激活对应的标签 - 通过onclick属性匹配
            document.querySelectorAll('.tab').forEach(tabElement => {
                const onclick = tabElement.getAttribute('onclick');
                if (onclick && onclick.includes(`'${tab}'`)) {
                    tabElement.classList.add('active');
                }
            });
            
            // 加载对应数据
            switch(tab) {
                case 'items':
                    loadItems();
                    break;
                case 'categories':
                    loadCategoriesForManagement();
                    break;
                case 'locations':
                    loadLocations();
                    break;
                case 'statistics':
                    loadEnhancedStatistics();
                    break;
                case 'add':
                    loadCategories();
                    loadLocationOptions();
                    break;
            }
        }

        // 统计相关变量
        let categoryChart = null;
        let locationChart = null;
        let trendChart = null;

        // 加载统计数据
        async function loadStatistics() {
            try {
                console.log('开始加载统计数据...');
                
                // 并行获取所有数据
                const [itemsResponse, categoriesResponse, locationsResponse] = await Promise.all([
                    fetch(`${API_BASE}/item/list?userId=${currentUser.userId}&keyword=`),
                    fetch(`${API_BASE}/category/list?userId=${currentUser.userId}`),
                    fetch(`${API_BASE}/location/list?userId=${currentUser.userId}`)
                ]);

                const itemsResult = await itemsResponse.json();
                const categoriesResult = await categoriesResponse.json();
                const locationsResult = await locationsResponse.json();
                
                console.log('API响应数据:', { itemsResult, categoriesResult, locationsResult });

                const items = itemsResult.data && itemsResult.data.items ? itemsResult.data.items : [];
                const categories = categoriesResult.data && Array.isArray(categoriesResult.data) ? categoriesResult.data : [];
                const locations = locationsResult.data && Array.isArray(locationsResult.data) ? locationsResult.data : [];

                console.log('处理后的数据:', { items: items.length, categories: categories.length, locations: locations.length });

                // 更新概览卡片
                document.getElementById('total-items').textContent = items.length;
                document.getElementById('total-categories').textContent = categories.length;
                document.getElementById('total-locations').textContent = locations.length;

                // 检查Chart.js是否加载
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js未加载');
                    // 显示错误提示
                    document.querySelectorAll('.chart-section').forEach(section => {
                        const canvas = section.querySelector('canvas');
                        if (canvas) {
                            const ctx = canvas.getContext('2d');
                            ctx.font = '14px Arial';
                            ctx.fillStyle = '#ff0000';
                            ctx.textAlign = 'center';
                            ctx.fillText('图表库加载失败', canvas.width / 2, canvas.height / 2);
                        }
                    });
                    return;
                }

                // 生成图表
                console.log('开始生成图表...');
                generateCategoryChart(items, categories);
                generateLocationChart(items, locations);
                generateTrendChart(items);
                console.log('图表生成完成');

            } catch (error) {
                console.error('加载统计数据失败:', error);
                // 显示错误状态
                document.getElementById('total-items').textContent = '错误';
                document.getElementById('total-categories').textContent = '错误';
                document.getElementById('total-locations').textContent = '错误';
                
                // 在图表区域显示错误信息
                document.querySelectorAll('.chart-section canvas').forEach(canvas => {
                    const ctx = canvas.getContext('2d');
                    ctx.font = '14px Arial';
                    ctx.fillStyle = '#ff0000';
                    ctx.textAlign = 'center';
                    ctx.fillText('加载失败', canvas.width / 2, canvas.height / 2);
                    ctx.fillText(error.message, canvas.width / 2, canvas.height / 2 + 20);
                });
            }
        }

        // 生成分类统计图表
        function generateCategoryChart(items, categories) {
            const ctx = document.getElementById('category-chart').getContext('2d');
            
            // 销毁已存在的图表
            if (categoryChart) {
                categoryChart.destroy();
            }

            // 统计每个分类的物品数量
            const categoryStats = {};
            categories.forEach(cat => {
                categoryStats[cat.name] = 0;
            });

            items.forEach(item => {
                if (categoryStats.hasOwnProperty(item.category)) {
                    categoryStats[item.category]++;
                }
            });

            const labels = Object.keys(categoryStats);
            const data = Object.values(categoryStats);
            
            // 检查是否有数据
            if (labels.length === 0 || data.every(value => value === 0)) {
                // 没有数据时显示提示
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '14px Arial';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('暂无数据', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            const colors = generateColors(labels.length);

            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1.5,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value}个 (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 生成位置统计图表
        function generateLocationChart(items, locations) {
            const ctx = document.getElementById('location-chart').getContext('2d');
            
            // 销毁已存在的图表
            if (locationChart) {
                locationChart.destroy();
            }

            // 统计每个位置的物品数量
            const locationStats = {};
            locations.forEach(loc => {
                locationStats[loc.name] = 0;
            });

            items.forEach(item => {
                if (locationStats.hasOwnProperty(item.location)) {
                    locationStats[item.location]++;
                }
            });

            const labels = Object.keys(locationStats);
            const data = Object.values(locationStats);
            
            // 检查是否有数据
            if (labels.length === 0 || data.every(value => value === 0)) {
                // 没有数据时显示提示
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '14px Arial';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('暂无数据', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            locationChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '物品数量',
                        data: data,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed.y}个物品`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 生成趋势图表
        function generateTrendChart(items) {
            const ctx = document.getElementById('trend-chart').getContext('2d');
            
            // 销毁已存在的图表
            if (trendChart) {
                trendChart.destroy();
            }

            // 按日期统计物品添加数量（最近7天）
            const today = new Date();
            const trendData = {};
            const labels = [];

            // 初始化最近7天的数据
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
                labels.push(dateStr);
                trendData[dateStr] = 0;
            }

            // 统计每天添加的物品数量
            items.forEach(item => {
                const itemDate = new Date(item.createTime || item.lastUpdateTime);
                const dateStr = itemDate.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
                if (trendData.hasOwnProperty(dateStr)) {
                    trendData[dateStr]++;
                }
            });

            const data = labels.map(label => trendData[label]);
            
            // 检查是否有数据
            if (data.every(value => value === 0)) {
                // 没有数据时显示提示
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '14px Arial';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('暂无数据', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '新增物品',
                        data: data,
                        borderColor: 'rgba(118, 75, 162, 1)',
                        backgroundColor: 'rgba(118, 75, 162, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: 'rgba(118, 75, 162, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: 新增${context.parsed.y}个物品`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 生成颜色数组
        function generateColors(count) {
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
            ];
            const result = [];
            for (let i = 0; i < count; i++) {
                result.push(colors[i % colors.length]);
            }
            return result;
        }

        // PWA 相关功能
        let deferredPrompt;
        let isInstalled = false;

        // 检查是否已安装
        window.addEventListener('appinstalled', () => {
            console.log('PWA 已安装');
            isInstalled = true;
            hidePWAPrompt();
        });

        // 监听安装提示事件
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('PWA 安装提示');
            e.preventDefault();
            deferredPrompt = e;
            showPWAPrompt();
        });

        // 显示安装提示
        function showPWAPrompt() {
            if (isInstalled || !deferredPrompt) return;
            
            // 创建安装提示元素
            const installPrompt = document.createElement('div');
            installPrompt.id = 'pwa-install-prompt';
            installPrompt.innerHTML = `
                <div style="position: fixed; bottom: 20px; left: 20px; right: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1001; display: flex; align-items: center; justify-content: space-between;">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; margin-bottom: 5px;">📱 安装寻物助手</div>
                        <div style="font-size: 14px; opacity: 0.9;">将应用安装到手机桌面，使用更便捷</div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-left: 15px;">
                        <button onclick="installPWA()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">安装</button>
                        <button onclick="hidePWAPrompt()" style="background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">稍后</button>
                    </div>
                </div>
            `;
            document.body.appendChild(installPrompt);
        }

        // 隐藏安装提示
        function hidePWAPrompt() {
            const prompt = document.getElementById('pwa-install-prompt');
            if (prompt) {
                prompt.remove();
            }
        }

        // 安装 PWA
        async function installPWA() {
            if (!deferredPrompt) return;
            
            try {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    console.log('用户接受安装');
                    isInstalled = true;
                } else {
                    console.log('用户拒绝安装');
                }
                
                deferredPrompt = null;
                hidePWAPrompt();
            } catch (error) {
                console.error('安装失败:', error);
                hidePWAPrompt();
            }
        }

        // 注册 Service Worker
        if ('serviceWorker' in navigator && (location.protocol === 'http:' || location.protocol === 'https:')) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js');
                    console.log('Service Worker 注册成功:', registration.scope);
                    
                    // 监听更新
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showUpdatePrompt();
                            }
                        });
                    });
                } catch (error) {
                    console.log('Service Worker 注册失败:', error);
                }
            });
        } else if (location.protocol === 'file:') {
            console.log('检测到本地文件访问，Service Worker功能已禁用。请通过HTTP服务器访问以启用完整功能。');
        }

        // 显示更新提示
        function showUpdatePrompt() {
            const updatePrompt = document.createElement('div');
            updatePrompt.innerHTML = `
                <div style="position: fixed; top: 20px; left: 20px; right: 20px; background: #28a745; color: white; padding: 12px; border-radius: 8px; z-index: 1001; text-align: center;">
                    <div style="margin-bottom: 8px;">🎉 应用已更新！</div>
                    <button onclick="location.reload()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; margin-right: 10px;">立即刷新</button>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: transparent; border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer;">稍后</button>
                </div>
            `;
            document.body.appendChild(updatePrompt);
        }

        // 离线状态检测
        window.addEventListener('online', () => {
            console.log('网络已连接');
            showNetworkStatus('✅ 网络已连接', '#28a745');
        });

        window.addEventListener('offline', () => {
            console.log('网络已断开');
            showNetworkStatus('⚠️ 离线模式', '#ffc107');
        });

        // 显示网络状态
        function showNetworkStatus(message, color) {
            const statusEl = document.createElement('div');
            statusEl.innerHTML = `
                <div style="position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: ${color}; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; z-index: 1002; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                    ${message}
                </div>
            `;
            document.body.appendChild(statusEl);
            
            setTimeout(() => {
                statusEl.remove();
            }, 3000);
        }

        // 物品历史记录功能
        let historyVisible = false;

        // 切换历史记录显示
        function toggleItemHistory() {
            const historyDiv = document.getElementById('item-history');
            const toggleBtn = document.getElementById('history-toggle');
            
            if (historyVisible) {
                historyDiv.style.display = 'none';
                toggleBtn.textContent = '历史记录';
                historyVisible = false;
            } else {
                historyDiv.style.display = 'block';
                toggleBtn.textContent = '收起历史';
                historyVisible = true;
                loadItemHistory();
            }
        }

        // 加载物品历史记录
        async function loadItemHistory() {
            if (!currentItem) return;
            
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '<div class="loading-history" style="text-align: center; padding: 20px; color: #666;">正在加载历史记录...</div>';
            
            try {
                // 尝试从API获取历史记录
                const response = await fetch(`${API_BASE}/item/${currentItem.itemId}/history?userId=${currentUser.userId}`);
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    displayItemHistory(result.data);
                } else {
                    // 如果没有API或没有历史记录，生成模拟数据
                    const mockHistory = generateMockHistory(currentItem);
                    displayItemHistory(mockHistory);
                }
            } catch (error) {
                console.log('无法获取历史记录API，使用模拟数据');
                // API不存在时，生成基于当前物品的模拟历史
                const mockHistory = generateMockHistory(currentItem);
                displayItemHistory(mockHistory);
            }
        }

        // 生成模拟历史记录（当后端API不可用时）
        function generateMockHistory(item) {
            const history = [];
            const now = new Date();
            
            // 创建记录
            const createTime = new Date(item.lastUpdateTime);
            history.push({
                id: 1,
                action: '创建物品',
                actionType: 'create',
                timestamp: createTime,
                changes: [
                    { field: '物品名称', newValue: item.name },
                    { field: '分类', newValue: item.category },
                    { field: '位置', newValue: item.location },
                    { field: '描述', newValue: item.description || '无' }
                ],
                operator: '用户'
            });
            
            // 如果有图片，添加图片上传记录
            if (item.imageUrl) {
                const imageTime = new Date(createTime.getTime() + 1000 * 60 * 2); // 2分钟后
                history.push({
                    id: 2,
                    action: '上传图片',
                    actionType: 'update',
                    timestamp: imageTime,
                    changes: [
                        { field: '物品图片', oldValue: '无', newValue: '已上传' }
                    ],
                    operator: '用户'
                });
            }
            
            // 模拟一些更新记录
            const updateTime = new Date(createTime.getTime() + 1000 * 60 * 60 * 24 * 3); // 3天后
            if (updateTime < now) {
                history.push({
                    id: 3,
                    action: '更新信息',
                    actionType: 'update',
                    timestamp: updateTime,
                    changes: [
                        { field: '描述', oldValue: item.description || '无', newValue: item.description || '已更新描述' }
                    ],
                    operator: '用户'
                });
            }
            
            // 按时间倒序排列
            return history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }

        // 显示历史记录
        function displayItemHistory(historyData) {
            const historyList = document.getElementById('history-list');
            
            if (!historyData || historyData.length === 0) {
                historyList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">暂无历史记录</div>';
                return;
            }
            
            const historyHtml = historyData.map(record => {
                const time = new Date(record.timestamp).toLocaleString('zh-CN');
                const actionIcon = getActionIcon(record.actionType);
                const changesHtml = record.changes.map(change => {
                    if (change.oldValue && change.newValue) {
                        return `<div class="history-change">
                            <strong>${change.field}:</strong> 
                            <span class="history-old">${change.oldValue}</span> → 
                            <span class="history-new">${change.newValue}</span>
                        </div>`;
                    } else if (change.newValue) {
                        return `<div class="history-change">
                            <strong>${change.field}:</strong> 
                            <span class="history-new">${change.newValue}</span>
                        </div>`;
                    } else {
                        return `<div class="history-change">
                            <strong>${change.field}:</strong> ${change.description || '已删除'}
                        </div>`;
                    }
                }).join('');
                
                return `
                    <div class="history-item ${record.actionType}">
                        <div class="history-action">${actionIcon} ${record.action}</div>
                        <div class="history-time">📅 ${time} · ${record.operator || '系统'}</div>
                        <div class="history-changes">${changesHtml}</div>
                    </div>
                `;
            }).join('');
            
            historyList.innerHTML = historyHtml;
        }

        // 获取操作图标
        function getActionIcon(actionType) {
            switch (actionType) {
                case 'create': return '✨';
                case 'update': return '📝';
                case 'delete': return '🗑️';
                case 'move': return '📦';
                case 'restore': return '🔄';
                default: return '📋';
            }
        }

        // 记录物品操作历史（用于将来与后端集成）
        function recordItemHistory(itemId, action, actionType, changes) {
            const historyRecord = {
                itemId: itemId,
                action: action,
                actionType: actionType,
                changes: changes,
                timestamp: new Date().toISOString(),
                operator: '用户',
                userId: currentUser.userId
            };
            
            // 这里将来可以发送到后端API保存
            console.log('记录历史:', historyRecord);
            
            // 暂时存储到本地存储
            const localHistory = JSON.parse(localStorage.getItem('itemHistory') || '{}');
            if (!localHistory[itemId]) {
                localHistory[itemId] = [];
            }
            localHistory[itemId].unshift(historyRecord);
            
            // 限制每个物品最多保存50条历史记录
            if (localHistory[itemId].length > 50) {
                localHistory[itemId] = localHistory[itemId].slice(0, 50);
            }
            
            localStorage.setItem('itemHistory', JSON.stringify(localHistory));
        }

        // 修改现有的编辑保存函数以记录历史
        const originalEditFormSubmit = document.getElementById('edit-form');
        if (originalEditFormSubmit) {
            // 在保存编辑时记录变更历史
            originalEditFormSubmit.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!currentItem) return;
                
                const newName = document.getElementById('edit-name').value;
                const newCategoryId = parseInt(document.getElementById('edit-category').value);
                const newLocationId = parseInt(document.getElementById('edit-location').value);
                const newDescription = document.getElementById('edit-description').value;
                
                // 检测变更
                const changes = [];
                if (newName !== currentItem.name) {
                    changes.push({ field: '物品名称', oldValue: currentItem.name, newValue: newName });
                }
                
                const categorySelect = document.getElementById('edit-category');
                const newCategoryName = categorySelect.options[categorySelect.selectedIndex].text.replace(' (系统)', '');
                if (newCategoryName !== currentItem.category) {
                    changes.push({ field: '分类', oldValue: currentItem.category, newValue: newCategoryName });
                }
                
                const locationSelect = document.getElementById('edit-location');
                const newLocationName = locationSelect.options[locationSelect.selectedIndex].text.replace(/^[^\s]+ /, '');
                if (newLocationName !== currentItem.location) {
                    changes.push({ field: '位置', oldValue: currentItem.location, newValue: newLocationName });
                }
                
                if (newDescription !== (currentItem.description || '')) {
                    changes.push({ field: '描述', oldValue: currentItem.description || '无', newValue: newDescription || '无' });
                }
                
                if (editImageUrl !== currentItem.imageUrl) {
                    const oldImg = currentItem.imageUrl ? '已设置' : '无';
                    const newImg = editImageUrl ? '已更新' : '无';
                    changes.push({ field: '物品图片', oldValue: oldImg, newValue: newImg });
                }
                
                // 如果有变更，记录历史
                if (changes.length > 0) {
                    recordItemHistory(currentItem.itemId, '更新信息', 'update', changes);
                }
                
                // 继续原有的保存逻辑...
                // （这里省略原有的保存代码，因为已经存在）
            });
        }

        // 初始化页面
        function initializePage() {
            // 初始化移动端手势
            initMobileGestures();
            
            // 检查URL参数，如果有item参数则直接显示物品详情
            const urlParams = new URLSearchParams(window.location.search);
            const itemId = urlParams.get('item');
            
            if (itemId) {
                // 通过二维码访问，直接显示物品详情
                showItemDetail(parseInt(itemId));
            } else {
                // 正常访问，显示物品列表
                showTab('items');
            }
        }

        // 加载分类管理页面的分类列表
        async function loadCategoriesForManagement() {
            try {
                const response = await fetch(`${API_BASE}/category/list?userId=${currentUser.userId}`);
                const result = await response.json();
                
                const list = document.getElementById('categories-list');
                const categories = result.data && Array.isArray(result.data) ? result.data : [];
                
                if (categories.length === 0) {
                    list.innerHTML = '<div class="empty-state"><p>暂无分类记录</p></div>';
                    return;
                }
                
                list.innerHTML = categories.map(category => `
                    <div class="location-item">
                        <span>${category.name}${category.isSystem ? ' (系统)' : ''}</span>
                        <div class="location-actions">
                            ${!category.isSystem ? `<button class="btn btn-danger" onclick="deleteCategory(${category.categoryId})" style="background: #ff6b6b; padding: 6px 12px; font-size: 12px;">删除</button>` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('加载分类失败:', error);
                const list = document.getElementById('categories-list');
                list.innerHTML = '<div class="empty-state"><p>加载失败，请重试</p></div>';
            }
        }

        // 分类管理
        function showAddCategoryModal() {
            document.getElementById('category-modal').style.display = 'block';
        }

        function closeCategoryModal() {
            document.getElementById('category-modal').style.display = 'none';
            document.getElementById('add-category-form').reset();
        }

        document.getElementById('add-category-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                userId: currentUser.userId,
                name: document.getElementById('category-name').value
            };
            
            // 验证表单
            if (!formData.name.trim()) {
                alert('请输入分类名称');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/category/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('分类添加成功！');
                    closeCategoryModal();
                    loadCategoriesForManagement();
                    loadCategories(); // 刷新添加页面的分类选项
                } else {
                    alert('添加失败：' + (result.message || '未知错误'));
                }
            } catch (error) {
                console.error('添加分类失败:', error);
                alert('添加失败，请检查网络连接');
            }
        });

        // 删除分类
        async function deleteCategory(categoryId) {
            if (!confirm('确定要删除这个分类吗？注意：分类下有物品时无法删除。')) return;
            
            try {
                const response = await fetch(`${API_BASE}/category/${categoryId}?userId=${currentUser.userId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('删除成功！');
                    loadCategoriesForManagement();
                    loadCategories(); // 刷新添加页面的分类选项
                } else {
                    alert('删除失败：' + (result.message || '未知错误'));
                }
            } catch (error) {
                console.error('删除分类失败:', error);
                alert('删除失败，请检查网络连接');
            }
        }

        // 加载物品列表
        async function loadItems() {
            try {
                const keyword = safeGetValue('search-input');
                const response = await fetch(`${API_BASE}/item/list?userId=${currentUser.userId}&keyword=${keyword}`);
                const result = await response.json();
                
                const list = document.getElementById('items-list');
                
                // 安全检查并获取items数组
                let items = result.data && result.data.items ? result.data.items : [];
                
                // 应用筛选条件
                items = applyFilters(items);
                
                if (items.length === 0) {
                    list.innerHTML = '<div class="empty-state"><p>暂无物品记录</p></div>';
                    return;
                }
                
                list.innerHTML = items.map(item => `
                    <div class="item-card" onclick="showItemDetail(${item.itemId})">
                        <div class="item-header">
                            <span class="item-name">${item.name}</span>
                            <span class="item-time">${new Date(item.lastUpdateTime).toLocaleDateString()}</span>
                        </div>
                        <div class="item-content">
                            ${item.imageUrl ? `<img src="${item.imageUrl}" alt="${item.name}" class="item-image">` : ''}
                            <div class="item-details">
                                <div class="item-info">
                                    <div>分类: ${item.category}</div>
                                    <div>位置: ${item.location}</div>
                                </div>
                                <button class="btn btn-danger" onclick="event.stopPropagation(); deleteItem(${item.itemId})" style="background: #ff6b6b; margin-top: 8px; padding: 6px 12px; font-size: 12px;">删除</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('加载物品失败:', error);
                const list = document.getElementById('items-list');
                list.innerHTML = '<div class="empty-state"><p>加载失败，请重试</p></div>';
            }
        }

        // 应用筛选条件
        function applyFilters(items) {
            const categoryFilter = document.getElementById('filter-category').value;
            const locationFilter = document.getElementById('filter-location').value;
            const sortFilter = document.getElementById('filter-sort').value;

            // 筛选分类
            if (categoryFilter) {
                items = items.filter(item => item.category === categoryFilter);
            }

            // 筛选位置
            if (locationFilter) {
                items = items.filter(item => item.location === locationFilter);
            }

            // 排序
            switch (sortFilter) {
                case 'time-desc':
                    items.sort((a, b) => new Date(b.lastUpdateTime) - new Date(a.lastUpdateTime));
                    break;
                case 'time-asc':
                    items.sort((a, b) => new Date(a.lastUpdateTime) - new Date(b.lastUpdateTime));
                    break;
                case 'name-asc':
                    items.sort((a, b) => a.name.localeCompare(b.name, 'zh-CN'));
                    break;
                case 'name-desc':
                    items.sort((a, b) => b.name.localeCompare(a.name, 'zh-CN'));
                    break;
                default:
                    items.sort((a, b) => new Date(b.lastUpdateTime) - new Date(a.lastUpdateTime));
            }

            return items;
        }

        // 智能搜索功能
        let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
        let searchSuggestions = [];
        let isVoiceSearching = false;

        // 语音搜索
        function startVoiceSearch() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('您的浏览器不支持语音识别功能');
                return;
            }

            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            const voiceBtn = document.querySelector('.voice-search-btn');
            
            recognition.lang = 'zh-CN';
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onstart = function() {
                isVoiceSearching = true;
                voiceBtn.classList.add('recording');
                voiceBtn.title = '正在录音...';
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                safeSetValue('search-input', transcript);
                addToSearchHistory(transcript);
                loadItems();
            };

            recognition.onerror = function(event) {
                console.error('语音识别错误:', event.error);
                alert('语音识别失败，请重试');
            };

            recognition.onend = function() {
                isVoiceSearching = false;
                voiceBtn.classList.remove('recording');
                voiceBtn.title = '语音搜索';
            };

            recognition.start();
        }

        // 扫码搜索
        function startCameraSearch() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('您的浏览器不支持摄像头功能');
                return;
            }

            // 创建扫码界面
            const scannerModal = document.createElement('div');
            scannerModal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1002; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <div style="color: white; margin-bottom: 20px; text-align: center;">
                        <h3>扫描物品二维码</h3>
                        <p>将二维码对准摄像头</p>
                    </div>
                    <video id="camera-video" style="width: 300px; height: 300px; border: 2px solid white; border-radius: 8px;"></video>
                    <canvas id="camera-canvas" style="display: none;"></canvas>
                    <button onclick="closeCameraSearch()" style="margin-top: 20px; padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">关闭</button>
                </div>
            `;
            scannerModal.id = 'camera-scanner';
            document.body.appendChild(scannerModal);

            // 启动摄像头
            const video = document.getElementById('camera-video');
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    video.srcObject = stream;
                    video.play();
                    
                    // 简单的扫码模拟（实际项目中需要使用专业的QR码库）
                    setTimeout(() => {
                        alert('扫码功能需要集成专业的QR码识别库，当前为演示模式');
                        closeCameraSearch();
                    }, 3000);
                })
                .catch(err => {
                    console.error('摄像头启动失败:', err);
                    alert('无法启动摄像头');
                    closeCameraSearch();
                });
        }

        // 关闭扫码界面
        function closeCameraSearch() {
            const scanner = document.getElementById('camera-scanner');
            if (scanner) {
                const video = document.getElementById('camera-video');
                if (video && video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                }
                scanner.remove();
            }
        }

        // 搜索建议
        async function generateSearchSuggestions(keyword) {
            if (!keyword.trim()) {
                hideSearchSuggestions();
                return;
            }

            try {
                // 获取所有数据
                const [itemsRes, categoriesRes, locationsRes] = await Promise.all([
                    fetch(`${API_BASE}/item/list?userId=${currentUser.userId}&keyword=`),
                    fetch(`${API_BASE}/category/list?userId=${currentUser.userId}`),
                    fetch(`${API_BASE}/location/list?userId=${currentUser.userId}`)
                ]);

                const items = (await itemsRes.json()).data?.items || [];
                const categories = (await categoriesRes.json()).data || [];
                const locations = (await locationsRes.json()).data || [];

                const suggestions = [];
                const lowerKeyword = keyword.toLowerCase();

                // 物品名称建议
                items.forEach(item => {
                    if (item.name.toLowerCase().includes(lowerKeyword)) {
                        suggestions.push({ text: item.name, type: '物品', icon: '📦' });
                    }
                });

                // 分类建议
                categories.forEach(cat => {
                    if (cat.name.toLowerCase().includes(lowerKeyword)) {
                        suggestions.push({ text: cat.name, type: '分类', icon: '🏷️' });
                    }
                });

                // 位置建议
                locations.forEach(loc => {
                    if (loc.name.toLowerCase().includes(lowerKeyword)) {
                        suggestions.push({ text: loc.name, type: '位置', icon: loc.icon || '📍' });
                    }
                });

                // 去重并限制数量
                const uniqueSuggestions = suggestions
                    .filter((item, index, self) => self.findIndex(i => i.text === item.text) === index)
                    .slice(0, 5);

                showSearchSuggestions(uniqueSuggestions);
            } catch (error) {
                console.error('生成搜索建议失败:', error);
            }
        }

        // 显示搜索建议
        function showSearchSuggestions(suggestions) {
            const suggestionsDiv = document.getElementById('search-suggestions');
            
            if (suggestions.length === 0) {
                hideSearchSuggestions();
                return;
            }

            suggestionsDiv.innerHTML = suggestions.map(item => 
                `<div class="suggestion-item" onclick="selectSuggestion('${item.text}')">
                    <span>${item.icon}</span>
                    <span>${item.text}</span>
                    <span class="suggestion-type">${item.type}</span>
                </div>`
            ).join('');
            
            suggestionsDiv.style.display = 'block';
        }

        // 隐藏搜索建议
        function hideSearchSuggestions() {
            safeSetStyle('search-suggestions', 'display', 'none');
        }

        // 选择搜索建议
        function selectSuggestion(text) {
            safeSetValue('search-input', text);
            hideSearchSuggestions();
            addToSearchHistory(text);
            loadItems();
        }

        // 添加到搜索历史
        function addToSearchHistory(keyword) {
            if (!keyword.trim()) return;
            
            // 移除重复项
            searchHistory = searchHistory.filter(item => item !== keyword);
            // 添加到开头
            searchHistory.unshift(keyword);
            // 限制历史记录数量
            searchHistory = searchHistory.slice(0, 10);
            
            localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
        }

        // 显示搜索历史
        function showSearchHistory() {
            const historyDiv = document.getElementById('search-history');
            
            if (searchHistory.length === 0) {
                historyDiv.style.display = 'none';
                return;
            }

            historyDiv.innerHTML = 
                '<div style="padding: 10px 15px; font-weight: bold; color: #666; font-size: 12px; background: #f8f9fa;">🕒 搜索历史</div>' +
                searchHistory.map(item => 
                    `<div class="history-item" onclick="selectSuggestion('${item}')">
                        <span>🔍</span>
                        <span>${item}</span>
                        <button onclick="event.stopPropagation(); removeFromHistory('${item}')" style="margin-left: auto; background: none; border: none; color: #999; cursor: pointer;">×</button>
                    </div>`
                ).join('');
            
            historyDiv.style.display = 'block';
        }

        // 从历史记录中移除
        function removeFromHistory(keyword) {
            searchHistory = searchHistory.filter(item => item !== keyword);
            localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
            showSearchHistory();
        }

        // 智能搜索事件监听 - 性能优化版
        const searchInput = safeGetElement('search-input');
        
        if (searchInput) {
            // 输入时显示建议 - 使用更智能的防抖
            searchInput.addEventListener('input', debounce(function(e) {
                const keyword = e.target.value;
                if (keyword.trim()) {
                    // 批量更新DOM以提高性能
                    domBatchUpdater.addUpdate(() => {
                        generateSearchSuggestions(keyword);
                        smartAnalytics.recordSearch(keyword);
                    });
                } else {
                    hideSearchSuggestions();
                }
                loadItems();
            }, 300));
        
            // 获得焦点时显示历史
            searchInput.addEventListener('focus', function() {
                if (!this.value.trim()) {
                    showSearchHistory();
                }
            });
            
            // 失去焦点时隐藏建议（延迟以允许点击）
            searchInput.addEventListener('blur', function() {
                setTimeout(() => {
                    hideSearchSuggestions();
                    safeSetStyle('search-history', 'display', 'none');
                }, 200);
            });
            
            // 按键处理
            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    const keyword = this.value.trim();
                    if (keyword) {
                        addToSearchHistory(keyword);
                        hideSearchSuggestions();
                        loadItems();
                    }
                } else if (e.key === 'Escape') {
                    hideSearchSuggestions();
                    safeSetStyle('search-history', 'display', 'none');
                }
            });
        }
        
        // 高级搜索切换
        function toggleSearchFilters() {
            const filters = document.getElementById('search-filters');
            const toggle = document.getElementById('filter-toggle');
            
            if (filters.style.display === 'none') {
                filters.style.display = 'block';
                toggle.textContent = '🔼 收起筛选';
                loadFilterOptions();
            } else {
                filters.style.display = 'none';
                toggle.textContent = '🔍 高级搜索';
            }
        }

        // 清除筛选条件
        function clearFilters() {
            document.getElementById('filter-category').value = '';
            document.getElementById('filter-location').value = '';
            document.getElementById('filter-sort').value = 'time-desc';
            loadItems();
        }

        // 批量操作切换
        function toggleBatchOperations() {
            const operations = document.getElementById('batch-operations');
            const toggle = document.getElementById('batch-toggle');
            
            if (operations.style.display === 'none') {
                operations.style.display = 'block';
                toggle.textContent = '🔼 收起操作';
            } else {
                operations.style.display = 'none';
                toggle.textContent = '📋 批量操作';
            }
        }

        // 导出物品数据
        async function exportItems() {
            try {
                const response = await fetch(`${API_BASE}/item/list?userId=${currentUser.userId}&keyword=`);
                const result = await response.json();
                
                const items = result.data && result.data.items ? result.data.items : [];
                
                if (items.length === 0) {
                    alert('暂无数据可导出');
                    return;
                }

                // 准备导出数据
                const exportData = items.map(item => ({
                    名称: item.name,
                    分类: item.category,
                    位置: item.location,
                    描述: item.description || '',
                    图片链接: item.imageUrl || '',
                    创建时间: new Date(item.lastUpdateTime).toLocaleString('zh-CN')
                }));

                // 生成CSV格式
                const csvContent = convertToCSV(exportData);
                
                // 下载文件
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `物品数据_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`成功导出 ${items.length} 条物品记录`);
                
            } catch (error) {
                console.error('导出失败:', error);
                alert('导出失败，请检查网络连接');
            }
        }

        // 转换为CSV格式
        function convertToCSV(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => 
                    headers.map(header => {
                        const value = row[header] || '';
                        // 处理包含逗号、引号和换行符的字段
                        return `"${value.toString().replace(/"/g, '""')}"`;
                    }).join(',')
                )
            ].join('\n');
            
            return csvContent;
        }

        // 文件导入处理
        document.getElementById('import-file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            if (fileExtension === 'csv') {
                importFromCSV(file);
            } else if (fileExtension === 'json') {
                importFromJSON(file);
            } else {
                alert('不支持的文件格式，请选择CSV或JSON文件');
                e.target.value = '';
            }
        });

        // 从CSV导入
        function importFromCSV(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        alert('CSV文件格式错误：至少需要标题行和一行数据');
                        return;
                    }
                    
                    const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
                    const items = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                        const values = parseCSVLine(lines[i]);
                        if (values.length >= 3) { // 至少需要名称、分类、位置
                            const item = {
                                name: values[0] || '',
                                category: values[1] || '',
                                location: values[2] || '',
                                description: values[3] || '',
                                imageUrl: values[4] || ''
                            };
                            if (item.name && item.category && item.location) {
                                items.push(item);
                            }
                        }
                    }
                    
                    if (items.length > 0) {
                        confirmImport(items, 'CSV');
                    } else {
                        alert('CSV文件中没有找到有效的物品数据');
                    }
                    
                } catch (error) {
                    console.error('CSV解析失败:', error);
                    alert('CSV文件解析失败，请检查文件格式');
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        // 解析CSV行（处理引号和逗号）
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++; // 跳过下一个引号
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        // 从JSON导入
        function importFromJSON(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    const items = Array.isArray(jsonData) ? jsonData : [jsonData];
                    
                    const validItems = items.filter(item => 
                        item.name && item.category && item.location
                    ).map(item => ({
                        name: item.name || item['名称'] || '',
                        category: item.category || item['分类'] || '',
                        location: item.location || item['位置'] || '',
                        description: item.description || item['描述'] || '',
                        imageUrl: item.imageUrl || item['图片链接'] || ''
                    }));
                    
                    if (validItems.length > 0) {
                        confirmImport(validItems, 'JSON');
                    } else {
                        alert('JSON文件中没有找到有效的物品数据');
                    }
                    
                } catch (error) {
                    console.error('JSON解析失败:', error);
                    alert('JSON文件解析失败，请检查文件格式');
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        // 确认导入
        async function confirmImport(items, fileType) {
            const confirmMsg = `准备导入 ${items.length} 条物品记录（${fileType}格式）\n\n预览前3条：\n${
                items.slice(0, 3).map(item => `• ${item.name} (${item.category} - ${item.location})`).join('\n')
            }\n\n确定要导入吗？`;
            
            if (!confirm(confirmMsg)) {
                document.getElementById('import-file-input').value = '';
                return;
            }
            
            await importItems(items);
        }

        // 批量导入物品
        async function importItems(items) {
            let successCount = 0;
            let failCount = 0;
            const errors = [];
            
            // 获取现有的分类和位置
            const [categoriesResponse, locationsResponse] = await Promise.all([
                fetch(`${API_BASE}/category/list?userId=${currentUser.userId}`),
                fetch(`${API_BASE}/location/list?userId=${currentUser.userId}`)
            ]);
            
            const categoriesResult = await categoriesResponse.json();
            const locationsResult = await locationsResponse.json();
            
            const existingCategories = new Set((categoriesResult.data || []).map(cat => cat.name));
            const existingLocations = new Set((locationsResult.data || []).map(loc => loc.name));
            
            // 处理每个物品
            for (const item of items) {
                try {
                    // 检查分类是否存在，不存在则创建
                    if (!existingCategories.has(item.category)) {
                        await createCategory(item.category);
                        existingCategories.add(item.category);
                    }
                    
                    // 检查位置是否存在，不存在则创建
                    if (!existingLocations.has(item.location)) {
                        await createLocation(item.location);
                        existingLocations.add(item.location);
                    }
                    
                    // 重新获取分类和位置ID
                    const updatedCategoriesResponse = await fetch(`${API_BASE}/category/list?userId=${currentUser.userId}`);
                    const updatedCategoriesResult = await updatedCategoriesResponse.json();
                    const categoryMap = new Map((updatedCategoriesResult.data || []).map(cat => [cat.name, cat.categoryId]));
                    
                    const updatedLocationsResponse = await fetch(`${API_BASE}/location/list?userId=${currentUser.userId}`);
                    const updatedLocationsResult = await updatedLocationsResponse.json();
                    const locationMap = new Map((updatedLocationsResult.data || []).map(loc => [loc.name, loc.locationId]));
                    
                    // 添加物品
                    const itemData = {
                        userId: currentUser.userId,
                        name: item.name,
                        categoryId: categoryMap.get(item.category),
                        locationId: locationMap.get(item.location),
                        description: item.description,
                        imageUrl: item.imageUrl
                    };
                    
                    const response = await fetch(`${API_BASE}/item/add`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(itemData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        successCount++;
                    } else {
                        failCount++;
                        errors.push(`${item.name}: ${result.message || '未知错误'}`);
                    }
                    
                } catch (error) {
                    console.error(`导入物品失败: ${item.name}`, error);
                    failCount++;
                    errors.push(`${item.name}: 网络错误`);
                }
            }
            
            // 显示导入结果
            let resultMsg = `导入完成！\n成功: ${successCount} 条\n失败: ${failCount} 条`;
            if (errors.length > 0 && errors.length <= 5) {
                resultMsg += '\n\n失败详情:\n' + errors.join('\n');
            } else if (errors.length > 5) {
                resultMsg += '\n\n部分失败详情:\n' + errors.slice(0, 5).join('\n') + `\n... 还有 ${errors.length - 5} 条错误`;
            }
            
            alert(resultMsg);
            
            // 清空文件输入并刷新列表
            document.getElementById('import-file-input').value = '';
            if (successCount > 0) {
                loadItems();
                // 刷新其他页面的数据
                loadCategoriesForManagement();
                loadLocations();
            }
        }

        // 创建分类
        async function createCategory(categoryName) {
            const response = await fetch(`${API_BASE}/category/add`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: currentUser.userId,
                    name: categoryName
                })
            });
            return response.json();
        }

        // 创建位置
        async function createLocation(locationName) {
            const response = await fetch(`${API_BASE}/location/add`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    userId: currentUser.userId,
                    name: locationName,
                    icon: '📦' // 默认图标
                })
            });
            return response.json();
        }

        // 加载筛选选项
        async function loadFilterOptions() {
            try {
                const [categoriesResponse, locationsResponse] = await Promise.all([
                    fetch(`${API_BASE}/category/list?userId=${currentUser.userId}`),
                    fetch(`${API_BASE}/location/list?userId=${currentUser.userId}`)
                ]);

                const categoriesResult = await categoriesResponse.json();
                const locationsResult = await locationsResponse.json();

                const categories = categoriesResult.data && Array.isArray(categoriesResult.data) ? categoriesResult.data : [];
                const locations = locationsResult.data && Array.isArray(locationsResult.data) ? locationsResult.data : [];

                // 填充分类筛选器
                const categoryFilter = document.getElementById('filter-category');
                categoryFilter.innerHTML = '<option value="">全部分类</option>' + 
                    categories.map(cat => `<option value="${cat.name}">${cat.name}${cat.isSystem ? ' (系统)' : ''}</option>`).join('');

                // 填充位置筛选器
                const locationFilter = document.getElementById('filter-location');
                locationFilter.innerHTML = '<option value="">全部位置</option>' + 
                    locations.map(loc => `<option value="${loc.name}">${loc.icon} ${loc.name}</option>`).join('');

            } catch (error) {
                console.error('加载筛选选项失败:', error);
            }
        }

        // 添加筛选器事件监听
        document.getElementById('filter-category').addEventListener('change', loadItems);
        document.getElementById('filter-location').addEventListener('change', loadItems);
        document.getElementById('filter-sort').addEventListener('change', loadItems);

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 加载位置列表
        async function loadLocations() {
            try {
                const response = await fetch(`${API_BASE}/location/list?userId=${currentUser.userId}`);
                const result = await response.json();
                
                const list = document.getElementById('locations-list');
                
                // 安全检查并获取位置数组
                const locations = result.data && Array.isArray(result.data) ? result.data : [];
                
                if (locations.length === 0) {
                    list.innerHTML = '<div class="empty-state"><p>暂无位置记录</p></div>';
                    return;
                }
                
                list.innerHTML = locations.map(location => `
                    <div class="location-item">
                        <span>${location.icon} ${location.name}</span>
                        <div class="location-actions">
                            <button class="btn btn-danger" onclick="deleteLocation(${location.locationId})" style="background: #ff6b6b; padding: 6px 12px; font-size: 12px;">删除</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('加载位置失败:', error);
                const list = document.getElementById('locations-list');
                list.innerHTML = '<div class="empty-state"><p>加载失败，请重试</p></div>';
            }
        }

        // 加载分类选项
        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE}/category/list?userId=${currentUser.userId}`);
                const result = await response.json();
                
                const select = document.getElementById('item-category');
                const categories = result.data && Array.isArray(result.data) ? result.data : [];
                
                select.innerHTML = '<option value="">请选择分类</option>' + 
                    categories.map(cat => `<option value="${cat.categoryId}">${cat.name}${cat.isSystem ? ' (系统)' : ''}</option>`).join('');
            } catch (error) {
                console.error('加载分类失败:', error);
                const select = document.getElementById('item-category');
                select.innerHTML = '<option value="">加载失败</option>';
            }
        }

        // 加载位置选项
        async function loadLocationOptions() {
            try {
                const response = await fetch(`${API_BASE}/location/list?userId=${currentUser.userId}`);
                const result = await response.json();
                
                const select = document.getElementById('item-location');
                const locations = result.data && Array.isArray(result.data) ? result.data : [];
                
                select.innerHTML = '<option value="">请选择位置</option>' + 
                    locations.map(loc => `<option value="${loc.locationId}">${loc.icon} ${loc.name}</option>`).join('');
            } catch (error) {
                console.error('加载位置选项失败:', error);
                const select = document.getElementById('item-location');
                select.innerHTML = '<option value="">加载失败</option>';
            }
        }

        // 添加物品
        document.getElementById('add-item-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                userId: currentUser.userId,
                name: safeGetValue('item-name'),
                categoryId: parseInt(safeGetValue('item-category')),
                locationId: parseInt(safeGetValue('item-location')),
                description: safeGetValue('item-description'),
                imageUrl: currentImageUrl // 包含上传的图片URL
            };
            
            // 增强的表单验证
            if (!formData.name || !formData.name.trim()) {
                showToast('❌ 请输入物品名称', 2000);
                return;
            }
            if (!formData.categoryId || isNaN(formData.categoryId)) {
                showToast('❌ 请选择分类', 2000);
                return;
            }
            if (!formData.locationId || isNaN(formData.locationId)) {
                showToast('❌ 请选择位置', 2000);
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/item/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('添加成功！');
                    
                    // 记录行为数据
                    smartAnalytics.recordAddTime();
                    const categorySelect = document.getElementById('item-category');
                    const locationSelect = document.getElementById('item-location');
                    if (categorySelect.selectedIndex > 0) {
                        smartAnalytics.recordCategoryUsage(categorySelect.options[categorySelect.selectedIndex].text.replace(/ \(\u7cfb\u7edf\)/, ''));
                    }
                    if (locationSelect.selectedIndex > 0) {
                        smartAnalytics.recordLocationUsage(locationSelect.options[locationSelect.selectedIndex].text.replace(/^[^\s]+ /, ''));
                    }
                    
                    // 清空表单
                    document.getElementById('add-item-form').reset();
                    document.getElementById('image-preview').style.display = 'none';
                    document.getElementById('image-remove').style.display = 'none';
                    currentImageUrl = null;
                    showTab('items');
                    loadItems();
                } else {
                    alert('添加失败：' + (result.message || '未知错误'));
                }
            } catch (error) {
                console.error('添加物品失败:', error);
                alert('添加失败，请检查网络连接');
            }
        });

        // 位置管理
        function showAddLocationModal() {
            document.getElementById('location-modal').style.display = 'block';
        }

        function closeLocationModal() {
            document.getElementById('location-modal').style.display = 'none';
            document.getElementById('add-location-form').reset();
        }

        document.getElementById('add-location-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                userId: currentUser.userId,
                name: document.getElementById('location-name').value,
                icon: document.getElementById('location-icon').value
            };
            
            // 验证表单
            if (!formData.name.trim()) {
                alert('请输入位置名称');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/location/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('位置添加成功！');
                    closeLocationModal();
                    loadLocations();
                    loadLocationOptions();
                } else {
                    alert('添加失败：' + (result.message || '未知错误'));
                }
            } catch (error) {
                console.error('添加位置失败:', error);
                alert('添加失败，请检查网络连接');
            }
        });

        // 删除物品
        async function deleteItem(itemId) {
            if (!confirm('确定要删除这个物品吗？')) return;
            
            try {
                const response = await fetch(`${API_BASE}/item/${itemId}?userId=${currentUser.userId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('删除成功！');
                    loadItems();
                } else {
                    alert('删除失败：' + (result.message || '未知错误'));
                }
            } catch (error) {
                console.error('删除物品失败:', error);
                alert('删除失败，请检查网络连接');
            }
        }

        // 删除位置
        async function deleteLocation(locationId) {
            if (!confirm('确定要删除这个位置吗？注意：位置下有物品时无法删除。')) return;
            
            try {
                const response = await fetch(`${API_BASE}/location/${locationId}?userId=${currentUser.userId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('删除成功！');
                    loadLocations();
                    loadLocationOptions();
                } else {
                    alert('删除失败：' + (result.message || '未知错误'));
                }
            } catch (error) {
                console.error('删除位置失败:', error);
                alert('删除失败，请检查网络连接');
            }
        }

        // 快速添加功能 - 简化版本
        let quickMode = 'smart', parsedItems = [], capturedPhotos = [];

        // 显示快速添加模态框
        function showQuickAddModal() { 
            document.getElementById('quick-add-modal').style.display = 'block';
            
            // 显示智能推荐
            displayQuickAddRecommendations();
        }
        function closeQuickAddModal() {
            document.getElementById('quick-add-modal').style.display = 'none';
            parsedItems = []; capturedPhotos = [];
            document.getElementById('smart-input-text').value = '';
            document.getElementById('smart-suggestions').style.display = 'none';
            document.getElementById('confirm-smart-btn').style.display = 'none';
        }

        function switchQuickMode(mode) {
            quickMode = mode;
            document.querySelectorAll('.quick-mode').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.quick-mode-content').forEach(content => content.style.display = 'none');
            document.getElementById(mode + '-mode').style.display = 'block';
        }

        function processSmartInput() {
            const text = document.getElementById('smart-input-text').value.trim();
            if (!text) { alert('请输入要添加的物品信息'); return; }
            document.querySelector('.smart-input').classList.add('processing');
            setTimeout(() => {
                const items = parseSmartInput(text);
                displayParsedItems(items);
                document.querySelector('.smart-input').classList.remove('processing');
            }, 1500);
        }

        function parseSmartInput(text) {
            const items = [], lines = text.split('\n').filter(line => line.trim());
            const categoryKeywords = {
                '电子产品': ['iPhone', 'iPad', '手机', '电脑', '笔记本', '耳机'],
                '书籍文具': ['书', '小说', '笔', '本子', '文件夹'],
                '服装配饰': ['衬衫', '裤子', '鞋子', '手表', '项链'],
                '生活用品': ['杯子', '锅', '碳', '毛巾'],
                '其他物品': []
            };
            const locationKeywords = {
                '客厅': ['客厅', '沙发', '电视'], '卧室': ['卧室', '床', '衣柜'],
                '厨房': ['厨房', '冰箱'], '书房': ['书房', '书桌'], '其他位置': []
            };

            lines.forEach((line, index) => {
                let itemName = line.replace(/在.*?的|,.*|，.*/g, '').trim();
                let category = '其他物品', location = '其他位置', description = '';

                for (const [loc, keywords] of Object.entries(locationKeywords)) {
                    if (keywords.some(keyword => line.includes(keyword)) || line.includes(loc)) { location = loc; break; }
                }
                for (const [cat, keywords] of Object.entries(categoryKeywords)) {
                    if (keywords.some(keyword => line.includes(keyword))) { category = cat; break; }
                }
                const descMatch = line.match(/[,，](.+)/);
                if (descMatch) description = descMatch[1].trim();
                if (itemName) items.push({ id: Date.now() + index, name: itemName, category, location, description, confirmed: false });
            });
            return items;
        }

        function displayParsedItems(items) {
            parsedItems = items;
            const container = document.getElementById('parsed-items');
            if (items.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">没有识别到有效的物品信息</p>';
                document.getElementById('smart-suggestions').style.display = 'block'; return;
            }
            container.innerHTML = items.map(item => `
                <div class="parsed-item" data-id="${item.id}">
                    <div class="parsed-item-info">
                        <div class="parsed-item-name">${item.name}</div>
                        <div class="parsed-item-details">${item.category} · ${item.location}${item.description ? ' · ' + item.description : ''}</div>
                    </div>
                    <div class="parsed-item-actions">
                        <button class="btn" onclick="confirmParsedItem(${item.id})" style="background: #28a745; color: white; padding: 4px 8px; font-size: 12px;">确认</button>
                        <button class="btn btn-danger" onclick="removeParsedItem(${item.id})" style="padding: 4px 8px; font-size: 12px;">删除</button>
                    </div>
                </div>
            `).join('');
            document.getElementById('smart-suggestions').style.display = 'block';
            document.getElementById('confirm-smart-btn').style.display = 'inline-block';
        }

        function confirmParsedItem(itemId) {
            const item = parsedItems.find(p => p.id === itemId);
            if (item) {
                item.confirmed = true;
                const element = document.querySelector(`[data-id="${itemId}"]`);
                element.classList.add('confirmed');
                element.querySelector('.parsed-item-actions').innerHTML = '<span style="color: #4caf50; font-weight: bold;">✓ 已确认</span>';
            }
        }

        function removeParsedItem(itemId) { parsedItems = parsedItems.filter(p => p.id !== itemId); displayParsedItems(parsedItems); }

        async function confirmSmartItems() {
            const confirmedItems = parsedItems.filter(item => item.confirmed);
            if (confirmedItems.length === 0) { alert('请至少确认一个物品'); return; }
            let successCount = 0, failCount = 0;
            for (const item of confirmedItems) {
                try {
                    const categoryId = await getOrCreateCategory(item.category);
                    const locationId = await getOrCreateLocation(item.location);
                    const response = await fetch(`${API_BASE}/item/add`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: currentUser.userId, name: item.name, categoryId, locationId, description: item.description || '', imageUrl: null })
                    });
                    const result = await response.json();
                    if (result.success) successCount++; else failCount++;
                } catch (error) { failCount++; }
            }
            alert(`批量添加完成！\n成功: ${successCount} 个\n失败: ${failCount} 个`);
            if (successCount > 0) { closeQuickAddModal(); loadItems(); }
        }

        async function getOrCreateCategory(categoryName) {
            try {
                const response = await fetch(`${API_BASE}/category/list?userId=${currentUser.userId}`);
                const result = await response.json(), categories = result.data || [];
                const existing = categories.find(cat => cat.name === categoryName);
                if (existing) return existing.categoryId;
                const createResponse = await fetch(`${API_BASE}/category/add`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.userId, name: categoryName })
                });
                const createResult = await createResponse.json();
                return createResult.success ? createResult.data : null;
            } catch (error) { return null; }
        }

        async function getOrCreateLocation(locationName) {
            try {
                const response = await fetch(`${API_BASE}/location/list?userId=${currentUser.userId}`);
                const result = await response.json(), locations = result.data || [];
                const existing = locations.find(loc => loc.name === locationName);
                if (existing) return existing.locationId;
                const createResponse = await fetch(`${API_BASE}/location/add`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.userId, name: locationName, icon: '📍' })
                });
                const createResult = await createResponse.json();
                return createResult.success ? createResult.data : null;
            } catch (error) { return null; }
        }

        // 连拍和语音功能（简化版）
        async function startQuickCamera() {
            try {
                const video = document.getElementById('quick-camera-video');
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream; video.style.display = 'block'; video.play();
                document.getElementById('start-camera-btn').style.display = 'none';
                document.getElementById('capture-btn').style.display = 'inline-block';
            } catch (error) { alert('无法启动摄像头'); }
        }

        function captureQuickPhoto() {
            const video = document.getElementById('quick-camera-video'), canvas = document.getElementById('quick-camera-canvas'), ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight; ctx.drawImage(video, 0, 0);
            capturedPhotos.push({ id: Date.now(), data: canvas.toDataURL('image/jpeg', 0.8) }); displayCapturedPhotos();
        }

        function displayCapturedPhotos() {
            document.getElementById('captured-images').innerHTML = capturedPhotos.map(photo => `
                <div class="captured-image"><img src="${photo.data}" alt="拍照">
                <button class="remove-btn" onclick="removeCapturedPhoto(${photo.id})">×</button></div>
            `).join('');
            if (capturedPhotos.length > 0) document.getElementById('camera-actions').style.display = 'block';
        }

        function removeCapturedPhoto(photoId) { capturedPhotos = capturedPhotos.filter(p => p.id !== photoId); displayCapturedPhotos(); }
        function processQuickPhotos() { if (capturedPhotos.length === 0) { alert('请先拍照'); return; } alert('演示模式，实际使用AI识别'); }

        function startQuickVoiceInput() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) { alert('不支持语音识别'); return; }
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)(), btn = document.getElementById('voice-input-btn');
            recognition.lang = 'zh-CN'; recognition.continuous = true; recognition.interimResults = false;
            recognition.onstart = () => { btn.textContent = '📴 录音中...'; btn.style.background = '#ff4444'; };
            recognition.onresult = (event) => {
                let transcript = ''; for (let i = 0; i < event.results.length; i++) transcript += event.results[i][0].transcript;
                document.getElementById('voice-text').textContent = transcript; document.getElementById('voice-result').style.display = 'block';
            };
            recognition.onerror = () => alert('语音识别失败');
            recognition.onend = () => { btn.textContent = '🎤 开始录音'; btn.style.background = '#667eea'; };
            recognition.start(); setTimeout(() => recognition.stop(), 10000);
        }

        function processVoiceResult() {
            const voiceText = document.getElementById('voice-text').textContent;
            if (!voiceText.trim()) { alert('没有识别到语音'); return; }
            switchQuickMode('smart'); document.getElementById('smart-input-text').value = voiceText; processSmartInput();
        }

        // 移动端手势优化功能
        let touchStartX = 0, touchStartY = 0, currentSwipeCard = null, isPulling = false, pullDistance = 0;

        // 初始化移动端手势
        function initMobileGestures() {
            // 为所有物品卡片添加手势监听
            document.addEventListener('touchstart', handleTouchStart, { passive: false });
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleTouchEnd, { passive: false });
            
            // 双击图片放大
            document.addEventListener('dblclick', function(e) {
                if (e.target.classList.contains('item-image') || e.target.classList.contains('image-preview')) {
                    showImageZoom(e.target.src);
                }
            });
            
            // 长按显示快捷操作面板
            let longPressTimer;
            document.addEventListener('touchstart', function(e) {
                longPressTimer = setTimeout(() => {
                    if (!e.target.closest('.modal') && !e.target.closest('.quick-actions-panel')) {
                        showQuickActionsPanel();
                        navigator.vibrate && navigator.vibrate(50);
                    }
                }, 800);
            });
            
            document.addEventListener('touchend', () => clearTimeout(longPressTimer));
            document.addEventListener('touchmove', () => clearTimeout(longPressTimer));
        }

        function handleTouchStart(e) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            currentSwipeCard = e.target.closest('.item-card');
            
            // 下拉刷新检测
            if (e.target.closest('#items-list') && window.scrollY === 0) {
                isPulling = true;
                pullDistance = 0;
            }
        }

        function handleTouchMove(e) {
            if (!touchStartX || !touchStartY) return;
            
            const touchX = e.touches[0].clientX;
            const touchY = e.touches[0].clientY;
            const deltaX = touchX - touchStartX;
            const deltaY = touchY - touchStartY;
            
            // 下拉刷新
            if (isPulling && deltaY > 0 && window.scrollY === 0) {
                pullDistance = Math.min(deltaY, 100);
                const itemsList = document.getElementById('items-list');
                if (itemsList) {
                    itemsList.style.transform = `translateY(${pullDistance}px)`;
                    if (pullDistance > 50) {
                        itemsList.classList.add('pulling');
                    }
                }
                e.preventDefault();
                return;
            }
            
            // 卡片左右滑动
            if (currentSwipeCard && Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 20) {
                const swipeDistance = Math.min(Math.abs(deltaX), 120);
                if (deltaX < 0) { // 左滑
                    currentSwipeCard.style.transform = `translateX(-${swipeDistance}px)`;
                    currentSwipeCard.classList.add('swiping');
                    
                    // 显示操作按钮
                    let swipeActions = currentSwipeCard.querySelector('.swipe-actions');
                    if (!swipeActions) {
                        swipeActions = document.createElement('div');
                        swipeActions.className = 'swipe-actions';
                        swipeActions.innerHTML = `
                            <div class="swipe-action edit" onclick="editItemFromSwipe(this)">✏️</div>
                            <div class="swipe-action qr" onclick="showQRFromSwipe(this)">📱</div>
                            <div class="swipe-action" onclick="deleteItemFromSwipe(this)">🗑️</div>
                        `;
                        currentSwipeCard.appendChild(swipeActions);
                    }
                    
                    if (swipeDistance > 60) {
                        swipeActions.classList.add('show');
                    }
                }
                e.preventDefault();
            }
        }

        function handleTouchEnd(e) {
            // 下拉刷新完成
            if (isPulling) {
                const itemsList = document.getElementById('items-list');
                if (itemsList) {
                    if (pullDistance > 50) {
                        // 触发刷新
                        itemsList.classList.add('refreshing');
                        refreshAllData().then(() => {
                            setTimeout(() => {
                                itemsList.style.transform = '';
                                itemsList.classList.remove('pulling', 'refreshing');
                            }, 500);
                        });
                    } else {
                        itemsList.style.transform = '';
                        itemsList.classList.remove('pulling');
                    }
                }
                isPulling = false;
                pullDistance = 0;
            }
            
            // 卡片滑动完成
            if (currentSwipeCard) {
                const transform = currentSwipeCard.style.transform;
                const translateX = transform ? parseFloat(transform.match(/-?\d+/)) : 0;
                
                if (Math.abs(translateX) > 60) {
                    currentSwipeCard.classList.add('swiped');
                } else {
                    currentSwipeCard.style.transform = '';
                    currentSwipeCard.classList.remove('swiping');
                    const swipeActions = currentSwipeCard.querySelector('.swipe-actions');
                    if (swipeActions) swipeActions.classList.remove('show');
                }
            }
            
            // 重置状态
            touchStartX = 0;
            touchStartY = 0;
            if (currentSwipeCard && !currentSwipeCard.classList.contains('swiped')) {
                currentSwipeCard = null;
            }
        }

        // 滑动操作函数
        function editItemFromSwipe(element) {
            const card = element.closest('.item-card');
            const itemId = card.onclick.toString().match(/\d+/)[0];
            showItemDetail(parseInt(itemId));
            setTimeout(() => editItem(), 500);
            resetSwipeCard(card);
        }

        function showQRFromSwipe(element) {
            const card = element.closest('.item-card');
            const itemId = card.onclick.toString().match(/\d+/)[0];
            showItemDetail(parseInt(itemId));
            setTimeout(() => showItemQR(), 500);
            resetSwipeCard(card);
        }

        function deleteItemFromSwipe(element) {
            const card = element.closest('.item-card');
            const itemId = card.onclick.toString().match(/\d+/)[0];
            deleteItem(parseInt(itemId));
            resetSwipeCard(card);
        }

        function resetSwipeCard(card) {
            card.style.transform = '';
            card.classList.remove('swiping', 'swiped');
            const swipeActions = card.querySelector('.swipe-actions');
            if (swipeActions) swipeActions.classList.remove('show');
        }

        // 图片放大功能
        function showImageZoom(imageSrc) {
            const modal = document.getElementById('image-zoom-modal');
            const img = document.getElementById('zoom-image');
            img.src = imageSrc;
            modal.style.display = 'flex';
        }

        function closeImageZoom() {
            document.getElementById('image-zoom-modal').style.display = 'none';
        }

        // 快捷操作面板
        function showQuickActionsPanel() {
            const panel = document.getElementById('quick-actions-panel');
            if (panel) {
                // 重置任何内联样式
                panel.style.bottom = '';
                panel.classList.add('show');
                console.log('Quick actions panel shown');
                
                // 添加ESC键监听
                document.addEventListener('keydown', handleQuickPanelEscape);
            }
        }

        function hideQuickActionsPanel() {
            const panel = document.getElementById('quick-actions-panel');
            if (panel) {
                panel.classList.remove('show');
                console.log('Quick actions panel hidden');
                
                // 移除ESC键监听
                document.removeEventListener('keydown', handleQuickPanelEscape);
                
                // 强制隐藏备用方案（如果CSS动画有问题）
                setTimeout(() => {
                    if (!panel.classList.contains('show')) {
                        panel.style.bottom = '-200px';
                    }
                }, 300);
            } else {
                console.error('Quick actions panel not found');
            }
        }
        
        // ESC键关闭快捷面板
        function handleQuickPanelEscape(e) {
            if (e.key === 'Escape') {
                hideQuickActionsPanel();
            }
        }

        // 全局刷新功能
        async function refreshAllData() {
            try {
                // 显示加载状态
                const loadingToast = showToast('🔄 正在刷新数据...', 0);
                
                // 并行刷新所有数据
                await Promise.all([
                    loadItems(),
                    loadCategoriesForManagement(),
                    loadLocations(),
                    loadCategories(),
                    loadLocationOptions()
                ]);
                
                // 隐藏加载状态
                hideToast(loadingToast);
                showToast('✓ 数据刷新成功', 2000);
            } catch (error) {
                console.error('刷新数据失败:', error);
                showToast('❌ 刷新失败', 2000);
            }
        }

        // 显示应用信息
        function showAppInfo() {
            alert(`🚀 寻物助手 v2.0\n\n✨ 新增功能：\n• 智能语音搜索\n• 快速批量添加\n• 手势操作优化\n• 下拉刷新功能\n\n📱 移动端体验：\n• 左滑卡片显示操作\n• 双击图片放大\n• 长按屏幕快捷操作\n\n❤️ 感谢使用！`);
        }

        // Toast 提示功能
        function showToast(message, duration = 3000) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                background: rgba(0,0,0,0.8); color: white; padding: 12px 20px;
                border-radius: 20px; font-size: 14px; z-index: 1004;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            if (duration > 0) {
                setTimeout(() => hideToast(toast), duration);
            }
            
            return toast;
        }

        function hideToast(toast) {
            if (toast && toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }

        // 数据安全和备份功能
        class DataBackupManager {
            constructor() {
                this.backupKey = 'findthingBackup';
                this.autoBackupInterval = null;
                this.enableAutoBackup();
            }

            // 启用自动备份（每30分钟）
            enableAutoBackup() {
                this.autoBackupInterval = setInterval(() => {
                    this.createAutoBackup();
                }, 30 * 60 * 1000);
            }

            // 创建自动备份
            async createAutoBackup() {
                try {
                    const backupData = await this.exportAllData();
                    const backups = JSON.parse(localStorage.getItem(this.backupKey) || '[]');
                    
                    // 添加新备份
                    backups.unshift({
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        type: 'auto',
                        data: backupData,
                        itemCount: backupData.items?.length || 0
                    });
                    
                    // 保留最近10个备份
                    const limitedBackups = backups.slice(0, 10);
                    localStorage.setItem(this.backupKey, JSON.stringify(limitedBackups));
                    
                    console.log('自动备份完成:', new Date().toLocaleString());
                } catch (error) {
                    console.error('自动备份失败:', error);
                }
            }

            // 手动创建备份
            async createManualBackup(description = '') {
                try {
                    const backupData = await this.exportAllData();
                    const backups = JSON.parse(localStorage.getItem(this.backupKey) || '[]');
                    
                    backups.unshift({
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        type: 'manual',
                        description: description,
                        data: backupData,
                        itemCount: backupData.items?.length || 0
                    });
                    
                    localStorage.setItem(this.backupKey, JSON.stringify(backups.slice(0, 20)));
                    return true;
                } catch (error) {
                    console.error('手动备份失败:', error);
                    return false;
                }
            }

            // 导出所有数据
            async exportAllData() {
                const [itemsRes, categoriesRes, locationsRes] = await Promise.all([
                    fetch(`${API_BASE}/item/list?userId=${currentUser.userId}&keyword=`),
                    fetch(`${API_BASE}/category/list?userId=${currentUser.userId}`),
                    fetch(`${API_BASE}/location/list?userId=${currentUser.userId}`)
                ]);

                return {
                    items: (await itemsRes.json()).data?.items || [],
                    categories: (await categoriesRes.json()).data || [],
                    locations: (await locationsRes.json()).data || [],
                    exportTime: new Date().toISOString(),
                    version: '2.0'
                };
            }

            // 获取备份列表
            getBackupList() {
                return JSON.parse(localStorage.getItem(this.backupKey) || '[]');
            }

            // 恢复备份
            async restoreBackup(backupId) {
                const backups = this.getBackupList();
                const backup = backups.find(b => b.id === backupId);
                
                if (!backup) {
                    throw new Error('备份不存在');
                }

                // 这里应该实现数据恢复逻辑
                // 由于需要调用后端 API，这里只做演示
                console.log('恢复备份:', backup);
                return true;
            }

            // 删除备份
            deleteBackup(backupId) {
                const backups = this.getBackupList();
                const filteredBackups = backups.filter(b => b.id !== backupId);
                localStorage.setItem(this.backupKey, JSON.stringify(filteredBackups));
            }

            // 清理过期备份（30天前）
            cleanOldBackups() {
                const backups = this.getBackupList();
                const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                
                const validBackups = backups.filter(backup => {
                    return backup.type === 'manual' || new Date(backup.timestamp) > thirtyDaysAgo;
                });
                
                localStorage.setItem(this.backupKey, JSON.stringify(validBackups));
            }
        }

        // 初始化备份管理器
        const backupManager = new DataBackupManager();

        // 备份管理函数
        function showBackupManager() {
            const backups = backupManager.getBackupList();
            const backupHtml = backups.length > 0 ? backups.map(backup => {
                const date = new Date(backup.timestamp).toLocaleString('zh-CN');
                const typeText = backup.type === 'auto' ? '自动' : '手动';
                return `
                    <div style="background: #f8f9fa; margin: 10px 0; padding: 15px; border-radius: 8px; border-left: 4px solid ${backup.type === 'manual' ? '#28a745' : '#667eea'};">
                        <div style="font-weight: bold; margin-bottom: 5px;">${typeText}备份 - ${backup.itemCount} 个物品</div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 8px;">${date}</div>
                        ${backup.description ? `<div style="font-size: 14px; margin-bottom: 8px;">${backup.description}</div>` : ''}
                        <div>
                            <button onclick="downloadBackup(${backup.id})" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; margin-right: 5px; cursor: pointer; font-size: 12px;">下载</button>
                            <button onclick="restoreBackupData(${backup.id})" style="background: #ffc107; color: white; border: none; padding: 6px 12px; border-radius: 4px; margin-right: 5px; cursor: pointer; font-size: 12px;">恢复</button>
                            <button onclick="deleteBackupData(${backup.id})" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">删除</button>
                        </div>
                    </div>
                `;
            }).join('') : '<p style="text-align: center; color: #666; padding: 40px;">暂无备份记录</p>';

            const modal = document.createElement('div');
            modal.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1002; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; margin: 20px; border-radius: 12px; padding: 0; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                            <h3>💾 数据备份管理</h3>
                            <button onclick="this.closest('div').parentElement.remove()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>
                        <div style="padding: 20px;">
                            <div style="margin-bottom: 20px; text-align: center;">
                                <button onclick="createManualBackupNow()" style="background: #28a745; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; margin-right: 10px;">💾 立即备份</button>
                                <button onclick="exportFullBackup()" style="background: #17a2b8; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer;">📦 导出备份</button>
                            </div>
                            <div style="border-top: 1px solid #eee; padding-top: 15px;">
                                <h4 style="margin-bottom: 15px; color: #333;">历史备份 (${backups.length})</h4>
                                ${backupHtml}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 创建手动备份
        async function createManualBackupNow() {
            const description = prompt('请输入备份描述（可选）:') || '';
            const loading = showToast('💾 正在创建备份...', 0);
            
            const success = await backupManager.createManualBackup(description);
            hideToast(loading);
            
            if (success) {
                showToast('✓ 备份创建成功', 2000);
                // 重新刷新备份管理器
                document.querySelector('.close')?.click();
                setTimeout(showBackupManager, 100);
            } else {
                showToast('❌ 备份创建失败', 2000);
            }
        }

        // 导出完整备份
        async function exportFullBackup() {
            try {
                const loading = showToast('📦 正在导出完整备份...', 0);
                const allData = await backupManager.exportAllData();
                
                const backupFile = {
                    appName: '寻物助手',
                    version: '2.0',
                    exportTime: new Date().toISOString(),
                    userData: currentUser,
                    data: allData,
                    backupHistory: backupManager.getBackupList()
                };
                
                const blob = new Blob([JSON.stringify(backupFile, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `寻物助手_完整备份_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                
                hideToast(loading);
                showToast('✓ 导出成功', 2000);
            } catch (error) {
                console.error('导出失败:', error);
                showToast('❌ 导出失败', 2000);
            }
        }

        // 下载单个备份
        function downloadBackup(backupId) {
            const backups = backupManager.getBackupList();
            const backup = backups.find(b => b.id === backupId);
            if (!backup) return;
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `备份_${new Date(backup.timestamp).toLocaleDateString().replace(/\//g, '-')}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // 恢复备份数据
        function restoreBackupData(backupId) {
            if (!confirm('恢复备份将覆盖当前数据，确定继续吗？')) return;
            
            // 这里应该实现真正的数据恢复逻辑
            alert('数据恢复功能需要后端API支持，当前为演示模式。\n\n实际项目中将会：\n1. 清空当前数据\n2. 恢复备份中的数据\n3. 更新本地显示');
        }

        // 删除备份数据
        function deleteBackupData(backupId) {
            if (!confirm('确定要删除这个备份吗？此操作不可恢复。')) return;
            
            backupManager.deleteBackup(backupId);
            showToast('✓ 备份已删除', 2000);
            
            // 重新刷新备份管理器
            document.querySelector('.close')?.click();
            setTimeout(showBackupManager, 100);
        }

        // 智能推荐和数据分析功能
        class SmartAnalytics {
            constructor() {
                this.userBehavior = JSON.parse(localStorage.getItem('userBehavior') || '{}');
                this.initializeBehaviorTracking();
            }

            // 初始化用户行为跟踪
            initializeBehaviorTracking() {
                if (!this.userBehavior.searchHistory) this.userBehavior.searchHistory = [];
                if (!this.userBehavior.categoryUsage) this.userBehavior.categoryUsage = {};
                if (!this.userBehavior.locationUsage) this.userBehavior.locationUsage = {};
                if (!this.userBehavior.addTimes) this.userBehavior.addTimes = [];
            }

            // 记录搜索行为
            recordSearch(keyword) {
                if (!keyword.trim()) return;
                this.userBehavior.searchHistory.unshift({
                    keyword: keyword,
                    timestamp: Date.now()
                });
                this.userBehavior.searchHistory = this.userBehavior.searchHistory.slice(0, 100);
                this.saveBehavior();
            }

            // 记录分类使用
            recordCategoryUsage(categoryName) {
                this.userBehavior.categoryUsage[categoryName] = (this.userBehavior.categoryUsage[categoryName] || 0) + 1;
                this.saveBehavior();
            }

            // 记录位置使用
            recordLocationUsage(locationName) {
                this.userBehavior.locationUsage[locationName] = (this.userBehavior.locationUsage[locationName] || 0) + 1;
                this.saveBehavior();
            }

            // 记录添加物品时间
            recordAddTime() {
                const hour = new Date().getHours();
                this.userBehavior.addTimes.push(hour);
                this.userBehavior.addTimes = this.userBehavior.addTimes.slice(-200); // 保留最近200次
                this.saveBehavior();
            }

            // 保存行为数据
            saveBehavior() {
                localStorage.setItem('userBehavior', JSON.stringify(this.userBehavior));
            }

            // 获取搜索推荐
            getSearchRecommendations() {
                const recentSearches = this.userBehavior.searchHistory.slice(0, 10);
                const popularKeywords = {};
                
                recentSearches.forEach(search => {
                    const words = search.keyword.split(/\s+/);
                    words.forEach(word => {
                        if (word.length > 1) {
                            popularKeywords[word] = (popularKeywords[word] || 0) + 1;
                        }
                    });
                });
                
                return Object.entries(popularKeywords)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 5)
                    .map(([word]) => word);
            }

            // 获取分类推荐
            getCategoryRecommendation() {
                const sortedCategories = Object.entries(this.userBehavior.categoryUsage)
                    .sort(([,a], [,b]) => b - a);
                return sortedCategories.length > 0 ? sortedCategories[0][0] : '其他物品';
            }

            // 获取位置推荐
            getLocationRecommendation() {
                const sortedLocations = Object.entries(this.userBehavior.locationUsage)
                    .sort(([,a], [,b]) => b - a);
                return sortedLocations.length > 0 ? sortedLocations[0][0] : '其他位置';
            }

            // 获取活跃时间分析
            getActiveTimeAnalysis() {
                const hourCounts = {};
                this.userBehavior.addTimes.forEach(hour => {
                    hourCounts[hour] = (hourCounts[hour] || 0) + 1;
                });
                
                const peakHour = Object.entries(hourCounts)
                    .sort(([,a], [,b]) => b - a)[0];
                
                return peakHour ? {
                    hour: parseInt(peakHour[0]),
                    count: peakHour[1],
                    timeLabel: this.getTimeLabel(parseInt(peakHour[0]))
                } : null;
            }

            // 获取时间段标签
            getTimeLabel(hour) {
                if (hour >= 6 && hour < 12) return '上午';
                if (hour >= 12 && hour < 18) return '下午';
                if (hour >= 18 && hour < 24) return '晚上';
                return '深夜';
            }

            // 获取智能推荐
            getSmartRecommendations(items) {
                const recommendations = [];
                
                // 分析物品分布
                const categoryStats = {};
                const locationStats = {};
                
                items.forEach(item => {
                    categoryStats[item.category] = (categoryStats[item.category] || 0) + 1;
                    locationStats[item.location] = (locationStats[item.location] || 0) + 1;
                });
                
                // 检查是否有分类不均衡
                const totalItems = items.length;
                const categoryCount = Object.keys(categoryStats).length;
                if (categoryCount > 0) {
                    const maxCategoryItems = Math.max(...Object.values(categoryStats));
                    if (maxCategoryItems > totalItems * 0.6) {
                        recommendations.push({
                            type: 'balance',
                            title: '分类均衡建议',
                            description: '您的物品主要集中在某个分类，建议考虑细化分类管理',
                            icon: '⚖️'
                        });
                    }
                }
                
                // 检查是否需要清理
                const oldItems = items.filter(item => {
                    const itemDate = new Date(item.lastUpdateTime);
                    const monthsAgo = (Date.now() - itemDate.getTime()) / (1000 * 60 * 60 * 24 * 30);
                    return monthsAgo > 6;
                });
                
                if (oldItems.length > totalItems * 0.3) {
                    recommendations.push({
                        type: 'cleanup',
                        title: '清理建议',
                        description: `您有 ${oldItems.length} 个物品超过6个月未更新，建议检查是否还需要`,
                        icon: '🧹'
                    });
                }
                
                // 活跃时间推荐
                const activeTime = this.getActiveTimeAnalysis();
                if (activeTime && activeTime.count > 5) {
                    recommendations.push({
                        type: 'timing',
                        title: '最佳整理时间',
                        description: `您通常在${activeTime.timeLabel}(${activeTime.hour}:00)整理物品，这是您的高效时段`,
                        icon: '⏰'
                    });
                }
                
                return recommendations;
            }
        }

        // 初始化智能分析
        const smartAnalytics = new SmartAnalytics();

        // 更新统计页面显示智能推荐
        async function loadEnhancedStatistics() {
            try {
                // 获取数据
                const [itemsResponse, categoriesResponse, locationsResponse] = await Promise.all([
                    fetch(`${API_BASE}/item/list?userId=${currentUser.userId}&keyword=`),
                    fetch(`${API_BASE}/category/list?userId=${currentUser.userId}`),
                    fetch(`${API_BASE}/location/list?userId=${currentUser.userId}`)
                ]);

                const itemsResult = await itemsResponse.json();
                const categoriesResult = await categoriesResponse.json();
                const locationsResult = await locationsResponse.json();

                const items = itemsResult.data?.items || [];
                const categories = categoriesResult.data || [];
                const locations = locationsResult.data || [];

                // 更新基本统计
                document.getElementById('total-items').textContent = items.length;
                document.getElementById('total-categories').textContent = categories.length;
                document.getElementById('total-locations').textContent = locations.length;

                // 生成智能推荐
                const recommendations = smartAnalytics.getSmartRecommendations(items);
                displaySmartRecommendations(recommendations);

                // 生成增强统计
                generateEnhancedCharts(items, categories, locations);

            } catch (error) {
                console.error('加载增强统计失败:', error);
            }
        }

        // 显示智能推荐
        function displaySmartRecommendations(recommendations) {
            // 在统计页面添加推荐区域
            let recommendationSection = document.getElementById('smart-recommendations');
            if (!recommendationSection) {
                recommendationSection = document.createElement('div');
                recommendationSection.id = 'smart-recommendations';
                recommendationSection.style.cssText = 'margin-bottom: 20px;';
                
                const statsOverview = document.querySelector('.stats-overview');
                if (statsOverview) {
                    statsOverview.insertAdjacentElement('afterend', recommendationSection);
                }
            }

            if (recommendations.length === 0) {
                recommendationSection.innerHTML = '';
                return;
            }

            recommendationSection.innerHTML = `
                <div style="background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: #333; font-size: 16px;">🤖 智能推荐</h4>
                    ${recommendations.map(rec => `
                        <div style="background: #f8f9fa; border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 4px solid #667eea;">
                            <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                <span style="font-size: 18px; margin-right: 8px;">${rec.icon}</span>
                                <strong style="color: #333;">${rec.title}</strong>
                            </div>
                            <div style="color: #666; font-size: 14px;">${rec.description}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // 生成增强统计图表
        function generateEnhancedCharts(items, categories, locations) {
            // 原有的图表生成
            generateCategoryChart(items, categories);
            generateLocationChart(items, locations);
            generateTrendChart(items);
            
            // 新增时间分析图表
            generateTimeAnalysisChart(items);
        }

        // 旰时间分析图表
        function generateTimeAnalysisChart(items) {
            // 在统计页面添加旰图表区域
            let timeChartSection = document.getElementById('time-analysis-section');
            if (!timeChartSection) {
                timeChartSection = document.createElement('div');
                timeChartSection.innerHTML = `
                    <div class="chart-section">
                        <h4>时间分析</h4>
                        <div class="chart-container">
                            <canvas id="time-analysis-chart"></canvas>
                        </div>
                    </div>
                `;
                timeChartSection.id = 'time-analysis-section';
                
                const chartsContainer = document.querySelector('.charts-container');
                if (chartsContainer) {
                    chartsContainer.appendChild(timeChartSection);
                }
            }

            const ctx = document.getElementById('time-analysis-chart');
            if (!ctx) return;
            
            // 统计每天添加的物品数量（最近30天）
            const last30Days = {};
            const today = new Date();
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
                last30Days[dateStr] = 0;
            }

            items.forEach(item => {
                const itemDate = new Date(item.lastUpdateTime);
                const dateStr = itemDate.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
                if (last30Days.hasOwnProperty(dateStr)) {
                    last30Days[dateStr]++;
                }
            });

            const labels = Object.keys(last30Days);
            const data = Object.values(last30Days);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '新增物品',
                        data: data,
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: 10
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: 新增${context.parsed.y}个物品`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 初始化
        initializePage();
        
        // 显示快速添加推荐
        function displayQuickAddRecommendations() {
            const recommendations = smartAnalytics.getSearchRecommendations();
            const suggestedCategory = smartAnalytics.getCategoryRecommendation();
            const suggestedLocation = smartAnalytics.getLocationRecommendation();
            
            // 在智能识别模式下方添加推荐区域
            let recommendationDiv = document.getElementById('quick-recommendations');
            if (!recommendationDiv) {
                recommendationDiv = document.createElement('div');
                recommendationDiv.id = 'quick-recommendations';
                recommendationDiv.style.cssText = 'margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 8px;';
                
                const smartMode = document.getElementById('smart-mode');
                const smartInput = smartMode?.querySelector('.smart-input');
                if (smartInput) {
                    smartInput.insertAdjacentElement('afterend', recommendationDiv);
                }
            }
            
            const hasRecommendations = recommendations.length > 0 || suggestedCategory !== '其他物品' || suggestedLocation !== '其他位置';
            
            if (!hasRecommendations) {
                recommendationDiv.style.display = 'none';
                return;
            }
            
            recommendationDiv.style.display = 'block';
            recommendationDiv.innerHTML = `
                <h5 style="margin-bottom: 10px; color: #1976d2; font-size: 14px;">💡 智能推荐</h5>
                ${recommendations.length > 0 ? `
                    <div style="margin-bottom: 10px;">
                        <span style="font-size: 12px; color: #666;">常用搜索：</span>
                        ${recommendations.map(keyword => `
                            <span onclick="insertRecommendation('${keyword}')" style="display: inline-block; background: white; color: #1976d2; padding: 4px 8px; border-radius: 12px; margin: 2px; cursor: pointer; font-size: 12px; border: 1px solid #1976d2;">${keyword}</span>
                        `).join('')}
                    </div>
                ` : ''}
                ${suggestedCategory !== '其他物品' ? `
                    <div style="margin-bottom: 5px; font-size: 12px;">
                        <span style="color: #666;">推荐分类：</span>
                        <span style="color: #1976d2; font-weight: bold;">${suggestedCategory}</span>
                    </div>
                ` : ''}
                ${suggestedLocation !== '其他位置' ? `
                    <div style="font-size: 12px;">
                        <span style="color: #666;">推荐位置：</span>
                        <span style="color: #1976d2; font-weight: bold;">${suggestedLocation}</span>
                    </div>
                ` : ''}
            `;
        }
        
        // 插入推荐关键词
        function insertRecommendation(keyword) {
            const textarea = document.getElementById('smart-input-text');
            if (textarea) {
                const currentValue = textarea.value;
                const newValue = currentValue ? currentValue + '\n' + keyword : keyword;
                textarea.value = newValue;
                textarea.focus();
            }
        }
    </script>
</body>
</html>